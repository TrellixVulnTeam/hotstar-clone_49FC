{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.triggerTag = exports.printAbortedErrors = exports.printErrors = exports.logAndTrackDeployStats = exports.AbortedDeploymentError = exports.DeploymentError = void 0;\n\nconst backend = require(\"../backend\");\n\nconst clc = require(\"cli-color\");\n\nconst logger_1 = require(\"../../../logger\");\n\nconst track = require(\"../../../track\");\n\nconst utils = require(\"../../../utils\");\n\nconst functionsDeployHelper_1 = require(\"../functionsDeployHelper\");\n\nclass DeploymentError extends Error {\n  constructor(endpoint, op, original) {\n    super(`Failed to ${op} function ${endpoint.id} in region ${endpoint.region}`);\n    this.endpoint = endpoint;\n    this.op = op;\n    this.original = original;\n  }\n\n}\n\nexports.DeploymentError = DeploymentError;\n\nclass AbortedDeploymentError extends DeploymentError {\n  constructor(endpoint) {\n    super(endpoint, \"delete\", new Error(\"aborted\"));\n    this.endpoint = endpoint;\n  }\n\n}\n\nexports.AbortedDeploymentError = AbortedDeploymentError;\n\nasync function logAndTrackDeployStats(summary) {\n  let totalTime = 0;\n  let totalErrors = 0;\n  let totalSuccesses = 0;\n  let totalAborts = 0;\n  const reports = [];\n\n  for (const result of summary.results) {\n    const tag = triggerTag(result.endpoint);\n    totalTime += result.durationMs;\n\n    if (!result.error) {\n      totalSuccesses++;\n      reports.push(track.track(\"function_deploy_success\", tag, result.durationMs));\n    } else if (result.error instanceof AbortedDeploymentError) {\n      totalAborts++;\n      reports.push(track.track(\"function_deploy_abort\", tag, result.durationMs));\n    } else {\n      totalErrors++;\n      reports.push(track.track(\"function_deploy_failure\", tag, result.durationMs));\n    }\n  }\n\n  const gcfv1 = summary.results.find(r => r.endpoint.platform === \"gcfv1\");\n  const gcfv2 = summary.results.find(r => r.endpoint.platform === \"gcfv2\");\n  const tag = gcfv1 && gcfv2 ? \"v1+v2\" : gcfv1 ? \"v1\" : \"v2\";\n  reports.push(track.track(\"functions_codebase_deploy\", tag, summary.results.length));\n  const avgTime = totalTime / (totalSuccesses + totalErrors);\n  logger_1.logger.debug(`Total Function Deployment time: ${summary.totalTime}`);\n  logger_1.logger.debug(`${totalErrors + totalSuccesses + totalAborts} Functions Deployed`);\n  logger_1.logger.debug(`${totalErrors} Functions Errored`);\n  logger_1.logger.debug(`${totalAborts} Function Deployments Aborted`);\n  logger_1.logger.debug(`Average Function Deployment time: ${avgTime}`);\n\n  if (totalErrors + totalSuccesses > 0) {\n    if (totalErrors === 0) {\n      reports.push(track.track(\"functions_deploy_result\", \"success\", totalSuccesses));\n    } else if (totalSuccesses > 0) {\n      reports.push(track.track(\"functions_deploy_result\", \"partial_success\", totalSuccesses));\n      reports.push(track.track(\"functions_deploy_result\", \"partial_failure\", totalErrors));\n      reports.push(track.track(\"functions_deploy_result\", \"partial_error_ratio\", totalErrors / (totalSuccesses + totalErrors)));\n    } else {\n      reports.push(track.track(\"functions_deploy_result\", \"failure\", totalErrors));\n    }\n  }\n\n  await utils.allSettled(reports);\n}\n\nexports.logAndTrackDeployStats = logAndTrackDeployStats;\n\nfunction printErrors(summary) {\n  const errored = summary.results.filter(r => r.error);\n\n  if (errored.length === 0) {\n    return;\n  }\n\n  errored.sort((left, right) => backend.compareFunctions(left.endpoint, right.endpoint));\n  logger_1.logger.info(\"\");\n  logger_1.logger.info(\"Functions deploy had errors with the following functions:\" + errored.filter(r => !(r.error instanceof AbortedDeploymentError)).map(result => `\\n\\t${functionsDeployHelper_1.getFunctionLabel(result.endpoint)}`).join(\"\"));\n  printIamErrors(errored);\n  printQuotaErrors(errored);\n  printAbortedErrors(errored);\n}\n\nexports.printErrors = printErrors;\n\nfunction printIamErrors(results) {\n  const iamFailures = results.filter(r => r.error instanceof DeploymentError && r.error.op === \"set invoker\");\n\n  if (!iamFailures.length) {\n    return;\n  }\n\n  logger_1.logger.info(\"\");\n  logger_1.logger.info(\"Unable to set the invoker for the IAM policy on the following functions:\" + iamFailures.map(result => `\\n\\t${functionsDeployHelper_1.getFunctionLabel(result.endpoint)}`).join(\"\"));\n  logger_1.logger.info(\"\");\n  logger_1.logger.info(\"Some common causes of this:\");\n  logger_1.logger.info(\"\");\n  logger_1.logger.info(\"- You may not have the roles/functions.admin IAM role. Note that \" + \"roles/functions.developer does not allow you to change IAM policies.\");\n  logger_1.logger.info(\"\");\n  logger_1.logger.info(\"- An organization policy that restricts Network Access on your project.\");\n  const hadImplicitMakePublic = iamFailures.find(r => backend.isHttpsTriggered(r.endpoint) && !r.endpoint.httpsTrigger.invoker);\n\n  if (!hadImplicitMakePublic) {\n    return;\n  }\n\n  logger_1.logger.info(\"\");\n  logger_1.logger.info(\"One or more functions were being implicitly made publicly available on function create.\");\n  logger_1.logger.info(\"Functions are not implicitly made public on updates. To try to make \" + \"these functions public on next deploy, configure these functions with \" + `${clc.bold(\"invoker\")} set to ${clc.bold(`\"public\"`)}`);\n}\n\nfunction printQuotaErrors(results) {\n  const hadQuotaError = results.find(r => {\n    var _a, _b, _c, _d, _e, _f;\n\n    if (!(r.error instanceof DeploymentError)) {\n      return false;\n    }\n\n    const original = r.error.original;\n    const code = (original === null || original === void 0 ? void 0 : original.status) || (original === null || original === void 0 ? void 0 : original.code) || ((_b = (_a = original === null || original === void 0 ? void 0 : original.context) === null || _a === void 0 ? void 0 : _a.response) === null || _b === void 0 ? void 0 : _b.statusCode) || ((_c = original === null || original === void 0 ? void 0 : original.original) === null || _c === void 0 ? void 0 : _c.code) || ((_f = (_e = (_d = original === null || original === void 0 ? void 0 : original.original) === null || _d === void 0 ? void 0 : _d.context) === null || _e === void 0 ? void 0 : _e.response) === null || _f === void 0 ? void 0 : _f.statusCode);\n    return code === 429 || code === 409;\n  });\n\n  if (!hadQuotaError) {\n    return;\n  }\n\n  logger_1.logger.info(\"\");\n  logger_1.logger.info(\"Exceeded maximum retries while deploying functions. \" + \"If you are deploying a large number of functions, \" + \"please deploy your functions in batches by using the --only flag, \" + \"and wait a few minutes before deploying again. \" + \"Go to https://firebase.google.com/docs/cli/#partial_deploys to learn more.\");\n}\n\nfunction printAbortedErrors(results) {\n  const aborted = results.filter(r => r.error instanceof AbortedDeploymentError);\n\n  if (!aborted) {\n    return;\n  }\n\n  logger_1.logger.info(\"\");\n  logger_1.logger.info(\"Because there were errors creating or updating functions, the following \" + \"functions were not deleted\" + aborted.map(result => `\\n\\t${functionsDeployHelper_1.getFunctionLabel(result.endpoint)}`).join(\"\"));\n  logger_1.logger.info(`To delete these, use ${clc.bold(\"firebase functions:delete\")}`);\n}\n\nexports.printAbortedErrors = printAbortedErrors;\n\nfunction triggerTag(endpoint) {\n  var _a;\n\n  const prefix = endpoint.platform === \"gcfv1\" ? \"v1\" : \"v2\";\n\n  if (backend.isScheduleTriggered(endpoint)) {\n    return `${prefix}.scheduled`;\n  }\n\n  if (backend.isHttpsTriggered(endpoint)) {\n    if ((_a = endpoint.labels) === null || _a === void 0 ? void 0 : _a[\"deployment-callable\"]) {\n      return `${prefix}.callable`;\n    }\n\n    return `${prefix}.https`;\n  }\n\n  return endpoint.eventTrigger.eventType;\n}\n\nexports.triggerTag = triggerTag;","map":{"version":3,"sources":["C:/Users/Sharik/Desktop/Projects/ReactProject/my-first-app/node_modules/firebase-tools/lib/deploy/functions/release/reporter.js"],"names":["Object","defineProperty","exports","value","triggerTag","printAbortedErrors","printErrors","logAndTrackDeployStats","AbortedDeploymentError","DeploymentError","backend","require","clc","logger_1","track","utils","functionsDeployHelper_1","Error","constructor","endpoint","op","original","id","region","summary","totalTime","totalErrors","totalSuccesses","totalAborts","reports","result","results","tag","durationMs","error","push","gcfv1","find","r","platform","gcfv2","length","avgTime","logger","debug","allSettled","errored","filter","sort","left","right","compareFunctions","info","map","getFunctionLabel","join","printIamErrors","printQuotaErrors","iamFailures","hadImplicitMakePublic","isHttpsTriggered","httpsTrigger","invoker","bold","hadQuotaError","_a","_b","_c","_d","_e","_f","code","status","context","response","statusCode","aborted","prefix","isScheduleTriggered","labels","eventTrigger","eventType"],"mappings":"AAAA;;AACAA,MAAM,CAACC,cAAP,CAAsBC,OAAtB,EAA+B,YAA/B,EAA6C;AAAEC,EAAAA,KAAK,EAAE;AAAT,CAA7C;AACAD,OAAO,CAACE,UAAR,GAAqBF,OAAO,CAACG,kBAAR,GAA6BH,OAAO,CAACI,WAAR,GAAsBJ,OAAO,CAACK,sBAAR,GAAiCL,OAAO,CAACM,sBAAR,GAAiCN,OAAO,CAACO,eAAR,GAA0B,KAAK,CAAzK;;AACA,MAAMC,OAAO,GAAGC,OAAO,CAAC,YAAD,CAAvB;;AACA,MAAMC,GAAG,GAAGD,OAAO,CAAC,WAAD,CAAnB;;AACA,MAAME,QAAQ,GAAGF,OAAO,CAAC,iBAAD,CAAxB;;AACA,MAAMG,KAAK,GAAGH,OAAO,CAAC,gBAAD,CAArB;;AACA,MAAMI,KAAK,GAAGJ,OAAO,CAAC,gBAAD,CAArB;;AACA,MAAMK,uBAAuB,GAAGL,OAAO,CAAC,0BAAD,CAAvC;;AACA,MAAMF,eAAN,SAA8BQ,KAA9B,CAAoC;AAChCC,EAAAA,WAAW,CAACC,QAAD,EAAWC,EAAX,EAAeC,QAAf,EAAyB;AAChC,UAAO,aAAYD,EAAG,aAAYD,QAAQ,CAACG,EAAG,cAAaH,QAAQ,CAACI,MAAO,EAA3E;AACA,SAAKJ,QAAL,GAAgBA,QAAhB;AACA,SAAKC,EAAL,GAAUA,EAAV;AACA,SAAKC,QAAL,GAAgBA,QAAhB;AACH;;AAN+B;;AAQpCnB,OAAO,CAACO,eAAR,GAA0BA,eAA1B;;AACA,MAAMD,sBAAN,SAAqCC,eAArC,CAAqD;AACjDS,EAAAA,WAAW,CAACC,QAAD,EAAW;AAClB,UAAMA,QAAN,EAAgB,QAAhB,EAA0B,IAAIF,KAAJ,CAAU,SAAV,CAA1B;AACA,SAAKE,QAAL,GAAgBA,QAAhB;AACH;;AAJgD;;AAMrDjB,OAAO,CAACM,sBAAR,GAAiCA,sBAAjC;;AACA,eAAeD,sBAAf,CAAsCiB,OAAtC,EAA+C;AAC3C,MAAIC,SAAS,GAAG,CAAhB;AACA,MAAIC,WAAW,GAAG,CAAlB;AACA,MAAIC,cAAc,GAAG,CAArB;AACA,MAAIC,WAAW,GAAG,CAAlB;AACA,QAAMC,OAAO,GAAG,EAAhB;;AACA,OAAK,MAAMC,MAAX,IAAqBN,OAAO,CAACO,OAA7B,EAAsC;AAClC,UAAMC,GAAG,GAAG5B,UAAU,CAAC0B,MAAM,CAACX,QAAR,CAAtB;AACAM,IAAAA,SAAS,IAAIK,MAAM,CAACG,UAApB;;AACA,QAAI,CAACH,MAAM,CAACI,KAAZ,EAAmB;AACfP,MAAAA,cAAc;AACdE,MAAAA,OAAO,CAACM,IAAR,CAAarB,KAAK,CAACA,KAAN,CAAY,yBAAZ,EAAuCkB,GAAvC,EAA4CF,MAAM,CAACG,UAAnD,CAAb;AACH,KAHD,MAIK,IAAIH,MAAM,CAACI,KAAP,YAAwB1B,sBAA5B,EAAoD;AACrDoB,MAAAA,WAAW;AACXC,MAAAA,OAAO,CAACM,IAAR,CAAarB,KAAK,CAACA,KAAN,CAAY,uBAAZ,EAAqCkB,GAArC,EAA0CF,MAAM,CAACG,UAAjD,CAAb;AACH,KAHI,MAIA;AACDP,MAAAA,WAAW;AACXG,MAAAA,OAAO,CAACM,IAAR,CAAarB,KAAK,CAACA,KAAN,CAAY,yBAAZ,EAAuCkB,GAAvC,EAA4CF,MAAM,CAACG,UAAnD,CAAb;AACH;AACJ;;AACD,QAAMG,KAAK,GAAGZ,OAAO,CAACO,OAAR,CAAgBM,IAAhB,CAAsBC,CAAD,IAAOA,CAAC,CAACnB,QAAF,CAAWoB,QAAX,KAAwB,OAApD,CAAd;AACA,QAAMC,KAAK,GAAGhB,OAAO,CAACO,OAAR,CAAgBM,IAAhB,CAAsBC,CAAD,IAAOA,CAAC,CAACnB,QAAF,CAAWoB,QAAX,KAAwB,OAApD,CAAd;AACA,QAAMP,GAAG,GAAGI,KAAK,IAAII,KAAT,GAAiB,OAAjB,GAA2BJ,KAAK,GAAG,IAAH,GAAU,IAAtD;AACAP,EAAAA,OAAO,CAACM,IAAR,CAAarB,KAAK,CAACA,KAAN,CAAY,2BAAZ,EAAyCkB,GAAzC,EAA8CR,OAAO,CAACO,OAAR,CAAgBU,MAA9D,CAAb;AACA,QAAMC,OAAO,GAAGjB,SAAS,IAAIE,cAAc,GAAGD,WAArB,CAAzB;AACAb,EAAAA,QAAQ,CAAC8B,MAAT,CAAgBC,KAAhB,CAAuB,mCAAkCpB,OAAO,CAACC,SAAU,EAA3E;AACAZ,EAAAA,QAAQ,CAAC8B,MAAT,CAAgBC,KAAhB,CAAuB,GAAElB,WAAW,GAAGC,cAAd,GAA+BC,WAAY,qBAApE;AACAf,EAAAA,QAAQ,CAAC8B,MAAT,CAAgBC,KAAhB,CAAuB,GAAElB,WAAY,oBAArC;AACAb,EAAAA,QAAQ,CAAC8B,MAAT,CAAgBC,KAAhB,CAAuB,GAAEhB,WAAY,+BAArC;AACAf,EAAAA,QAAQ,CAAC8B,MAAT,CAAgBC,KAAhB,CAAuB,qCAAoCF,OAAQ,EAAnE;;AACA,MAAIhB,WAAW,GAAGC,cAAd,GAA+B,CAAnC,EAAsC;AAClC,QAAID,WAAW,KAAK,CAApB,EAAuB;AACnBG,MAAAA,OAAO,CAACM,IAAR,CAAarB,KAAK,CAACA,KAAN,CAAY,yBAAZ,EAAuC,SAAvC,EAAkDa,cAAlD,CAAb;AACH,KAFD,MAGK,IAAIA,cAAc,GAAG,CAArB,EAAwB;AACzBE,MAAAA,OAAO,CAACM,IAAR,CAAarB,KAAK,CAACA,KAAN,CAAY,yBAAZ,EAAuC,iBAAvC,EAA0Da,cAA1D,CAAb;AACAE,MAAAA,OAAO,CAACM,IAAR,CAAarB,KAAK,CAACA,KAAN,CAAY,yBAAZ,EAAuC,iBAAvC,EAA0DY,WAA1D,CAAb;AACAG,MAAAA,OAAO,CAACM,IAAR,CAAarB,KAAK,CAACA,KAAN,CAAY,yBAAZ,EAAuC,qBAAvC,EAA8DY,WAAW,IAAIC,cAAc,GAAGD,WAArB,CAAzE,CAAb;AACH,KAJI,MAKA;AACDG,MAAAA,OAAO,CAACM,IAAR,CAAarB,KAAK,CAACA,KAAN,CAAY,yBAAZ,EAAuC,SAAvC,EAAkDY,WAAlD,CAAb;AACH;AACJ;;AACD,QAAMX,KAAK,CAAC8B,UAAN,CAAiBhB,OAAjB,CAAN;AACH;;AACD3B,OAAO,CAACK,sBAAR,GAAiCA,sBAAjC;;AACA,SAASD,WAAT,CAAqBkB,OAArB,EAA8B;AAC1B,QAAMsB,OAAO,GAAGtB,OAAO,CAACO,OAAR,CAAgBgB,MAAhB,CAAwBT,CAAD,IAAOA,CAAC,CAACJ,KAAhC,CAAhB;;AACA,MAAIY,OAAO,CAACL,MAAR,KAAmB,CAAvB,EAA0B;AACtB;AACH;;AACDK,EAAAA,OAAO,CAACE,IAAR,CAAa,CAACC,IAAD,EAAOC,KAAP,KAAiBxC,OAAO,CAACyC,gBAAR,CAAyBF,IAAI,CAAC9B,QAA9B,EAAwC+B,KAAK,CAAC/B,QAA9C,CAA9B;AACAN,EAAAA,QAAQ,CAAC8B,MAAT,CAAgBS,IAAhB,CAAqB,EAArB;AACAvC,EAAAA,QAAQ,CAAC8B,MAAT,CAAgBS,IAAhB,CAAqB,8DACjBN,OAAO,CACFC,MADL,CACaT,CAAD,IAAO,EAAEA,CAAC,CAACJ,KAAF,YAAmB1B,sBAArB,CADnB,EAEK6C,GAFL,CAEUvB,MAAD,IAAa,OAAMd,uBAAuB,CAACsC,gBAAxB,CAAyCxB,MAAM,CAACX,QAAhD,CAA0D,EAFtF,EAGKoC,IAHL,CAGU,EAHV,CADJ;AAKAC,EAAAA,cAAc,CAACV,OAAD,CAAd;AACAW,EAAAA,gBAAgB,CAACX,OAAD,CAAhB;AACAzC,EAAAA,kBAAkB,CAACyC,OAAD,CAAlB;AACH;;AACD5C,OAAO,CAACI,WAAR,GAAsBA,WAAtB;;AACA,SAASkD,cAAT,CAAwBzB,OAAxB,EAAiC;AAC7B,QAAM2B,WAAW,GAAG3B,OAAO,CAACgB,MAAR,CAAgBT,CAAD,IAAOA,CAAC,CAACJ,KAAF,YAAmBzB,eAAnB,IAAsC6B,CAAC,CAACJ,KAAF,CAAQd,EAAR,KAAe,aAA3E,CAApB;;AACA,MAAI,CAACsC,WAAW,CAACjB,MAAjB,EAAyB;AACrB;AACH;;AACD5B,EAAAA,QAAQ,CAAC8B,MAAT,CAAgBS,IAAhB,CAAqB,EAArB;AACAvC,EAAAA,QAAQ,CAAC8B,MAAT,CAAgBS,IAAhB,CAAqB,6EACjBM,WAAW,CAACL,GAAZ,CAAiBvB,MAAD,IAAa,OAAMd,uBAAuB,CAACsC,gBAAxB,CAAyCxB,MAAM,CAACX,QAAhD,CAA0D,EAA7F,EAAgGoC,IAAhG,CAAqG,EAArG,CADJ;AAEA1C,EAAAA,QAAQ,CAAC8B,MAAT,CAAgBS,IAAhB,CAAqB,EAArB;AACAvC,EAAAA,QAAQ,CAAC8B,MAAT,CAAgBS,IAAhB,CAAqB,6BAArB;AACAvC,EAAAA,QAAQ,CAAC8B,MAAT,CAAgBS,IAAhB,CAAqB,EAArB;AACAvC,EAAAA,QAAQ,CAAC8B,MAAT,CAAgBS,IAAhB,CAAqB,sEACjB,sEADJ;AAEAvC,EAAAA,QAAQ,CAAC8B,MAAT,CAAgBS,IAAhB,CAAqB,EAArB;AACAvC,EAAAA,QAAQ,CAAC8B,MAAT,CAAgBS,IAAhB,CAAqB,yEAArB;AACA,QAAMO,qBAAqB,GAAGD,WAAW,CAACrB,IAAZ,CAAkBC,CAAD,IAAO5B,OAAO,CAACkD,gBAAR,CAAyBtB,CAAC,CAACnB,QAA3B,KAAwC,CAACmB,CAAC,CAACnB,QAAF,CAAW0C,YAAX,CAAwBC,OAAzF,CAA9B;;AACA,MAAI,CAACH,qBAAL,EAA4B;AACxB;AACH;;AACD9C,EAAAA,QAAQ,CAAC8B,MAAT,CAAgBS,IAAhB,CAAqB,EAArB;AACAvC,EAAAA,QAAQ,CAAC8B,MAAT,CAAgBS,IAAhB,CAAqB,yFAArB;AACAvC,EAAAA,QAAQ,CAAC8B,MAAT,CAAgBS,IAAhB,CAAqB,yEACjB,wEADiB,GAEhB,GAAExC,GAAG,CAACmD,IAAJ,CAAS,SAAT,CAAoB,WAAUnD,GAAG,CAACmD,IAAJ,CAAU,UAAV,CAAqB,EAF1D;AAGH;;AACD,SAASN,gBAAT,CAA0B1B,OAA1B,EAAmC;AAC/B,QAAMiC,aAAa,GAAGjC,OAAO,CAACM,IAAR,CAAcC,CAAD,IAAO;AACtC,QAAI2B,EAAJ,EAAQC,EAAR,EAAYC,EAAZ,EAAgBC,EAAhB,EAAoBC,EAApB,EAAwBC,EAAxB;;AACA,QAAI,EAAEhC,CAAC,CAACJ,KAAF,YAAmBzB,eAArB,CAAJ,EAA2C;AACvC,aAAO,KAAP;AACH;;AACD,UAAMY,QAAQ,GAAGiB,CAAC,CAACJ,KAAF,CAAQb,QAAzB;AACA,UAAMkD,IAAI,GAAG,CAAClD,QAAQ,KAAK,IAAb,IAAqBA,QAAQ,KAAK,KAAK,CAAvC,GAA2C,KAAK,CAAhD,GAAoDA,QAAQ,CAACmD,MAA9D,MAA0EnD,QAAQ,KAAK,IAAb,IAAqBA,QAAQ,KAAK,KAAK,CAAvC,GAA2C,KAAK,CAAhD,GAAoDA,QAAQ,CAACkD,IAAvI,MAAiJ,CAACL,EAAE,GAAG,CAACD,EAAE,GAAG5C,QAAQ,KAAK,IAAb,IAAqBA,QAAQ,KAAK,KAAK,CAAvC,GAA2C,KAAK,CAAhD,GAAoDA,QAAQ,CAACoD,OAAnE,MAAgF,IAAhF,IAAwFR,EAAE,KAAK,KAAK,CAApG,GAAwG,KAAK,CAA7G,GAAiHA,EAAE,CAACS,QAA1H,MAAwI,IAAxI,IAAgJR,EAAE,KAAK,KAAK,CAA5J,GAAgK,KAAK,CAArK,GAAyKA,EAAE,CAACS,UAA7T,MAA6U,CAACR,EAAE,GAAG9C,QAAQ,KAAK,IAAb,IAAqBA,QAAQ,KAAK,KAAK,CAAvC,GAA2C,KAAK,CAAhD,GAAoDA,QAAQ,CAACA,QAAnE,MAAiF,IAAjF,IAAyF8C,EAAE,KAAK,KAAK,CAArG,GAAyG,KAAK,CAA9G,GAAkHA,EAAE,CAACI,IAAlc,MAA4c,CAACD,EAAE,GAAG,CAACD,EAAE,GAAG,CAACD,EAAE,GAAG/C,QAAQ,KAAK,IAAb,IAAqBA,QAAQ,KAAK,KAAK,CAAvC,GAA2C,KAAK,CAAhD,GAAoDA,QAAQ,CAACA,QAAnE,MAAiF,IAAjF,IAAyF+C,EAAE,KAAK,KAAK,CAArG,GAAyG,KAAK,CAA9G,GAAkHA,EAAE,CAACK,OAA3H,MAAwI,IAAxI,IAAgJJ,EAAE,KAAK,KAAK,CAA5J,GAAgK,KAAK,CAArK,GAAyKA,EAAE,CAACK,QAAlL,MAAgM,IAAhM,IAAwMJ,EAAE,KAAK,KAAK,CAApN,GAAwN,KAAK,CAA7N,GAAiOA,EAAE,CAACK,UAAhrB,CAAb;AACA,WAAOJ,IAAI,KAAK,GAAT,IAAgBA,IAAI,KAAK,GAAhC;AACH,GARqB,CAAtB;;AASA,MAAI,CAACP,aAAL,EAAoB;AAChB;AACH;;AACDnD,EAAAA,QAAQ,CAAC8B,MAAT,CAAgBS,IAAhB,CAAqB,EAArB;AACAvC,EAAAA,QAAQ,CAAC8B,MAAT,CAAgBS,IAAhB,CAAqB,yDACjB,oDADiB,GAEjB,oEAFiB,GAGjB,iDAHiB,GAIjB,4EAJJ;AAKH;;AACD,SAAS/C,kBAAT,CAA4B0B,OAA5B,EAAqC;AACjC,QAAM6C,OAAO,GAAG7C,OAAO,CAACgB,MAAR,CAAgBT,CAAD,IAAOA,CAAC,CAACJ,KAAF,YAAmB1B,sBAAzC,CAAhB;;AACA,MAAI,CAACoE,OAAL,EAAc;AACV;AACH;;AACD/D,EAAAA,QAAQ,CAAC8B,MAAT,CAAgBS,IAAhB,CAAqB,EAArB;AACAvC,EAAAA,QAAQ,CAAC8B,MAAT,CAAgBS,IAAhB,CAAqB,6EACjB,4BADiB,GAEjBwB,OAAO,CAACvB,GAAR,CAAavB,MAAD,IAAa,OAAMd,uBAAuB,CAACsC,gBAAxB,CAAyCxB,MAAM,CAACX,QAAhD,CAA0D,EAAzF,EAA4FoC,IAA5F,CAAiG,EAAjG,CAFJ;AAGA1C,EAAAA,QAAQ,CAAC8B,MAAT,CAAgBS,IAAhB,CAAsB,wBAAuBxC,GAAG,CAACmD,IAAJ,CAAS,2BAAT,CAAsC,EAAnF;AACH;;AACD7D,OAAO,CAACG,kBAAR,GAA6BA,kBAA7B;;AACA,SAASD,UAAT,CAAoBe,QAApB,EAA8B;AAC1B,MAAI8C,EAAJ;;AACA,QAAMY,MAAM,GAAG1D,QAAQ,CAACoB,QAAT,KAAsB,OAAtB,GAAgC,IAAhC,GAAuC,IAAtD;;AACA,MAAI7B,OAAO,CAACoE,mBAAR,CAA4B3D,QAA5B,CAAJ,EAA2C;AACvC,WAAQ,GAAE0D,MAAO,YAAjB;AACH;;AACD,MAAInE,OAAO,CAACkD,gBAAR,CAAyBzC,QAAzB,CAAJ,EAAwC;AACpC,QAAI,CAAC8C,EAAE,GAAG9C,QAAQ,CAAC4D,MAAf,MAA2B,IAA3B,IAAmCd,EAAE,KAAK,KAAK,CAA/C,GAAmD,KAAK,CAAxD,GAA4DA,EAAE,CAAC,qBAAD,CAAlE,EAA2F;AACvF,aAAQ,GAAEY,MAAO,WAAjB;AACH;;AACD,WAAQ,GAAEA,MAAO,QAAjB;AACH;;AACD,SAAO1D,QAAQ,CAAC6D,YAAT,CAAsBC,SAA7B;AACH;;AACD/E,OAAO,CAACE,UAAR,GAAqBA,UAArB","sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.triggerTag = exports.printAbortedErrors = exports.printErrors = exports.logAndTrackDeployStats = exports.AbortedDeploymentError = exports.DeploymentError = void 0;\nconst backend = require(\"../backend\");\nconst clc = require(\"cli-color\");\nconst logger_1 = require(\"../../../logger\");\nconst track = require(\"../../../track\");\nconst utils = require(\"../../../utils\");\nconst functionsDeployHelper_1 = require(\"../functionsDeployHelper\");\nclass DeploymentError extends Error {\n    constructor(endpoint, op, original) {\n        super(`Failed to ${op} function ${endpoint.id} in region ${endpoint.region}`);\n        this.endpoint = endpoint;\n        this.op = op;\n        this.original = original;\n    }\n}\nexports.DeploymentError = DeploymentError;\nclass AbortedDeploymentError extends DeploymentError {\n    constructor(endpoint) {\n        super(endpoint, \"delete\", new Error(\"aborted\"));\n        this.endpoint = endpoint;\n    }\n}\nexports.AbortedDeploymentError = AbortedDeploymentError;\nasync function logAndTrackDeployStats(summary) {\n    let totalTime = 0;\n    let totalErrors = 0;\n    let totalSuccesses = 0;\n    let totalAborts = 0;\n    const reports = [];\n    for (const result of summary.results) {\n        const tag = triggerTag(result.endpoint);\n        totalTime += result.durationMs;\n        if (!result.error) {\n            totalSuccesses++;\n            reports.push(track.track(\"function_deploy_success\", tag, result.durationMs));\n        }\n        else if (result.error instanceof AbortedDeploymentError) {\n            totalAborts++;\n            reports.push(track.track(\"function_deploy_abort\", tag, result.durationMs));\n        }\n        else {\n            totalErrors++;\n            reports.push(track.track(\"function_deploy_failure\", tag, result.durationMs));\n        }\n    }\n    const gcfv1 = summary.results.find((r) => r.endpoint.platform === \"gcfv1\");\n    const gcfv2 = summary.results.find((r) => r.endpoint.platform === \"gcfv2\");\n    const tag = gcfv1 && gcfv2 ? \"v1+v2\" : gcfv1 ? \"v1\" : \"v2\";\n    reports.push(track.track(\"functions_codebase_deploy\", tag, summary.results.length));\n    const avgTime = totalTime / (totalSuccesses + totalErrors);\n    logger_1.logger.debug(`Total Function Deployment time: ${summary.totalTime}`);\n    logger_1.logger.debug(`${totalErrors + totalSuccesses + totalAborts} Functions Deployed`);\n    logger_1.logger.debug(`${totalErrors} Functions Errored`);\n    logger_1.logger.debug(`${totalAborts} Function Deployments Aborted`);\n    logger_1.logger.debug(`Average Function Deployment time: ${avgTime}`);\n    if (totalErrors + totalSuccesses > 0) {\n        if (totalErrors === 0) {\n            reports.push(track.track(\"functions_deploy_result\", \"success\", totalSuccesses));\n        }\n        else if (totalSuccesses > 0) {\n            reports.push(track.track(\"functions_deploy_result\", \"partial_success\", totalSuccesses));\n            reports.push(track.track(\"functions_deploy_result\", \"partial_failure\", totalErrors));\n            reports.push(track.track(\"functions_deploy_result\", \"partial_error_ratio\", totalErrors / (totalSuccesses + totalErrors)));\n        }\n        else {\n            reports.push(track.track(\"functions_deploy_result\", \"failure\", totalErrors));\n        }\n    }\n    await utils.allSettled(reports);\n}\nexports.logAndTrackDeployStats = logAndTrackDeployStats;\nfunction printErrors(summary) {\n    const errored = summary.results.filter((r) => r.error);\n    if (errored.length === 0) {\n        return;\n    }\n    errored.sort((left, right) => backend.compareFunctions(left.endpoint, right.endpoint));\n    logger_1.logger.info(\"\");\n    logger_1.logger.info(\"Functions deploy had errors with the following functions:\" +\n        errored\n            .filter((r) => !(r.error instanceof AbortedDeploymentError))\n            .map((result) => `\\n\\t${functionsDeployHelper_1.getFunctionLabel(result.endpoint)}`)\n            .join(\"\"));\n    printIamErrors(errored);\n    printQuotaErrors(errored);\n    printAbortedErrors(errored);\n}\nexports.printErrors = printErrors;\nfunction printIamErrors(results) {\n    const iamFailures = results.filter((r) => r.error instanceof DeploymentError && r.error.op === \"set invoker\");\n    if (!iamFailures.length) {\n        return;\n    }\n    logger_1.logger.info(\"\");\n    logger_1.logger.info(\"Unable to set the invoker for the IAM policy on the following functions:\" +\n        iamFailures.map((result) => `\\n\\t${functionsDeployHelper_1.getFunctionLabel(result.endpoint)}`).join(\"\"));\n    logger_1.logger.info(\"\");\n    logger_1.logger.info(\"Some common causes of this:\");\n    logger_1.logger.info(\"\");\n    logger_1.logger.info(\"- You may not have the roles/functions.admin IAM role. Note that \" +\n        \"roles/functions.developer does not allow you to change IAM policies.\");\n    logger_1.logger.info(\"\");\n    logger_1.logger.info(\"- An organization policy that restricts Network Access on your project.\");\n    const hadImplicitMakePublic = iamFailures.find((r) => backend.isHttpsTriggered(r.endpoint) && !r.endpoint.httpsTrigger.invoker);\n    if (!hadImplicitMakePublic) {\n        return;\n    }\n    logger_1.logger.info(\"\");\n    logger_1.logger.info(\"One or more functions were being implicitly made publicly available on function create.\");\n    logger_1.logger.info(\"Functions are not implicitly made public on updates. To try to make \" +\n        \"these functions public on next deploy, configure these functions with \" +\n        `${clc.bold(\"invoker\")} set to ${clc.bold(`\"public\"`)}`);\n}\nfunction printQuotaErrors(results) {\n    const hadQuotaError = results.find((r) => {\n        var _a, _b, _c, _d, _e, _f;\n        if (!(r.error instanceof DeploymentError)) {\n            return false;\n        }\n        const original = r.error.original;\n        const code = (original === null || original === void 0 ? void 0 : original.status) || (original === null || original === void 0 ? void 0 : original.code) || ((_b = (_a = original === null || original === void 0 ? void 0 : original.context) === null || _a === void 0 ? void 0 : _a.response) === null || _b === void 0 ? void 0 : _b.statusCode) || ((_c = original === null || original === void 0 ? void 0 : original.original) === null || _c === void 0 ? void 0 : _c.code) || ((_f = (_e = (_d = original === null || original === void 0 ? void 0 : original.original) === null || _d === void 0 ? void 0 : _d.context) === null || _e === void 0 ? void 0 : _e.response) === null || _f === void 0 ? void 0 : _f.statusCode);\n        return code === 429 || code === 409;\n    });\n    if (!hadQuotaError) {\n        return;\n    }\n    logger_1.logger.info(\"\");\n    logger_1.logger.info(\"Exceeded maximum retries while deploying functions. \" +\n        \"If you are deploying a large number of functions, \" +\n        \"please deploy your functions in batches by using the --only flag, \" +\n        \"and wait a few minutes before deploying again. \" +\n        \"Go to https://firebase.google.com/docs/cli/#partial_deploys to learn more.\");\n}\nfunction printAbortedErrors(results) {\n    const aborted = results.filter((r) => r.error instanceof AbortedDeploymentError);\n    if (!aborted) {\n        return;\n    }\n    logger_1.logger.info(\"\");\n    logger_1.logger.info(\"Because there were errors creating or updating functions, the following \" +\n        \"functions were not deleted\" +\n        aborted.map((result) => `\\n\\t${functionsDeployHelper_1.getFunctionLabel(result.endpoint)}`).join(\"\"));\n    logger_1.logger.info(`To delete these, use ${clc.bold(\"firebase functions:delete\")}`);\n}\nexports.printAbortedErrors = printAbortedErrors;\nfunction triggerTag(endpoint) {\n    var _a;\n    const prefix = endpoint.platform === \"gcfv1\" ? \"v1\" : \"v2\";\n    if (backend.isScheduleTriggered(endpoint)) {\n        return `${prefix}.scheduled`;\n    }\n    if (backend.isHttpsTriggered(endpoint)) {\n        if ((_a = endpoint.labels) === null || _a === void 0 ? void 0 : _a[\"deployment-callable\"]) {\n            return `${prefix}.callable`;\n        }\n        return `${prefix}.https`;\n    }\n    return endpoint.eventTrigger.eventType;\n}\nexports.triggerTag = triggerTag;\n"]},"metadata":{},"sourceType":"script"}