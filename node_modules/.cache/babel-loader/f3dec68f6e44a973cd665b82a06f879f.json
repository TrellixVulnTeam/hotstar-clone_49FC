{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.FunctionsEmulator = void 0;\n\nconst _ = require(\"lodash\");\n\nconst fs = require(\"fs\");\n\nconst path = require(\"path\");\n\nconst express = require(\"express\");\n\nconst clc = require(\"cli-color\");\n\nconst http = require(\"http\");\n\nconst jwt = require(\"jsonwebtoken\");\n\nconst url_1 = require(\"url\");\n\nconst api = require(\"../api\");\n\nconst logger_1 = require(\"../logger\");\n\nconst track = require(\"../track\");\n\nconst constants_1 = require(\"./constants\");\n\nconst types_1 = require(\"./types\");\n\nconst chokidar = require(\"chokidar\");\n\nconst spawn = require(\"cross-spawn\");\n\nconst child_process_1 = require(\"child_process\");\n\nconst functionsEmulatorShared_1 = require(\"./functionsEmulatorShared\");\n\nconst registry_1 = require(\"./registry\");\n\nconst events_1 = require(\"events\");\n\nconst emulatorLogger_1 = require(\"./emulatorLogger\");\n\nconst functionsRuntimeWorker_1 = require(\"./functionsRuntimeWorker\");\n\nconst error_1 = require(\"../error\");\n\nconst workQueue_1 = require(\"./workQueue\");\n\nconst utils_1 = require(\"../utils\");\n\nconst defaultCredentials_1 = require(\"../defaultCredentials\");\n\nconst adminSdkConfig_1 = require(\"./adminSdkConfig\");\n\nconst functionsEnv = require(\"../functions/env\");\n\nconst types_2 = require(\"./events/types\");\n\nconst EVENT_INVOKE = \"functions:invoke\";\nconst DATABASE_PATH_PATTERN = new RegExp(\"^projects/[^/]+/instances/([^/]+)/refs(/.*)$\");\n\nclass FunctionsEmulator {\n  constructor(args) {\n    this.args = args;\n    this.nodeBinary = \"\";\n    this.triggers = {};\n    this.triggerGeneration = 0;\n    this.logger = emulatorLogger_1.EmulatorLogger.forEmulator(types_1.Emulators.FUNCTIONS);\n    this.multicastTriggers = {};\n    emulatorLogger_1.EmulatorLogger.verbosity = this.args.quiet ? emulatorLogger_1.Verbosity.QUIET : emulatorLogger_1.Verbosity.DEBUG;\n\n    if (this.args.debugPort) {\n      this.args.disabledRuntimeFeatures = this.args.disabledRuntimeFeatures || {};\n      this.args.disabledRuntimeFeatures.timeout = true;\n    }\n\n    this.adminSdkConfig = {\n      projectId: this.args.projectId\n    };\n    const mode = this.args.debugPort ? types_1.FunctionsExecutionMode.SEQUENTIAL : types_1.FunctionsExecutionMode.AUTO;\n    this.workerPool = new functionsRuntimeWorker_1.RuntimeWorkerPool(mode);\n    this.workQueue = new workQueue_1.WorkQueue(mode);\n  }\n\n  static getHttpFunctionUrl(host, port, projectId, name, region) {\n    return `http://${host}:${port}/${projectId}/${region}/${name}`;\n  }\n\n  async getCredentialsEnvironment() {\n    const credentialEnv = {};\n\n    if (process.env.GOOGLE_APPLICATION_CREDENTIALS) {\n      this.logger.logLabeled(\"WARN\", \"functions\", `Your GOOGLE_APPLICATION_CREDENTIALS environment variable points to ${process.env.GOOGLE_APPLICATION_CREDENTIALS}. Non-emulated services will access production using these credentials. Be careful!`);\n    } else if (this.args.account) {\n      const defaultCredPath = await defaultCredentials_1.getCredentialPathAsync(this.args.account);\n\n      if (defaultCredPath) {\n        this.logger.log(\"DEBUG\", `Setting GAC to ${defaultCredPath}`);\n        credentialEnv.GOOGLE_APPLICATION_CREDENTIALS = defaultCredPath;\n      }\n    } else {\n      this.logger.logLabeled(\"WARN\", \"functions\", \"You are not signed in to the Firebase CLI. If you have authorized this machine using gcloud application-default credentials those may be discovered and used to access production services.\");\n    }\n\n    return credentialEnv;\n  }\n\n  createHubServer() {\n    this.workQueue.start();\n    const hub = express();\n\n    const dataMiddleware = (req, res, next) => {\n      const chunks = [];\n      req.on(\"data\", chunk => {\n        chunks.push(chunk);\n      });\n      req.on(\"end\", () => {\n        req.rawBody = Buffer.concat(chunks);\n        next();\n      });\n    };\n\n    const backgroundFunctionRoute = `/functions/projects/:project_id/triggers/:trigger_name`;\n    const httpsFunctionRoute = `/${this.args.projectId}/:region/:trigger_name`;\n    const multicastFunctionRoute = `/functions/projects/:project_id/trigger_multicast`;\n    const httpsFunctionRoutes = [httpsFunctionRoute, `${httpsFunctionRoute}/*`];\n\n    const backgroundHandler = (req, res) => {\n      var _a;\n\n      const region = req.params.region;\n      const triggerId = req.params.trigger_name;\n      const projectId = req.params.project_id;\n      const reqBody = req.rawBody;\n      let proto = JSON.parse(reqBody.toString());\n\n      if ((_a = req.headers[\"content-type\"]) === null || _a === void 0 ? void 0 : _a.includes(\"cloudevent\")) {\n        if (types_2.EventUtils.isBinaryCloudEvent(req)) {\n          proto = types_2.EventUtils.extractBinaryCloudEventContext(req);\n          proto.data = req.body;\n        }\n      }\n\n      this.workQueue.submit(() => {\n        this.logger.log(\"DEBUG\", `Accepted request ${req.method} ${req.url} --> ${triggerId}`);\n        return this.handleBackgroundTrigger(projectId, triggerId, proto).then(x => res.json(x)).catch(errorBundle => {\n          if (errorBundle.body) {\n            res.status(errorBundle.code).send(errorBundle.body);\n          } else {\n            res.sendStatus(errorBundle.code);\n          }\n        });\n      });\n    };\n\n    const httpsHandler = (req, res) => {\n      this.workQueue.submit(() => {\n        return this.handleHttpsTrigger(req, res);\n      });\n    };\n\n    const multicastHandler = (req, res) => {\n      var _a;\n\n      const projectId = req.params.project_id;\n      const reqBody = req.rawBody;\n      let proto = JSON.parse(reqBody.toString());\n      let triggerKey;\n\n      if ((_a = req.headers[\"content-type\"]) === null || _a === void 0 ? void 0 : _a.includes(\"cloudevent\")) {\n        triggerKey = `${this.args.projectId}:${proto.type}`;\n\n        if (types_2.EventUtils.isBinaryCloudEvent(req)) {\n          proto = types_2.EventUtils.extractBinaryCloudEventContext(req);\n          proto.data = req.body;\n        }\n      } else {\n        triggerKey = `${this.args.projectId}:${proto.eventType}`;\n      }\n\n      const triggers = this.multicastTriggers[triggerKey] || [];\n      triggers.forEach(triggerId => {\n        this.workQueue.submit(() => {\n          this.logger.log(\"DEBUG\", `Accepted multicast request ${req.method} ${req.url} --> ${triggerId}`);\n          return this.handleBackgroundTrigger(projectId, triggerId, proto);\n        });\n      });\n      res.json({\n        status: \"multicast_acknowledged\"\n      });\n    };\n\n    hub.post(backgroundFunctionRoute, dataMiddleware, backgroundHandler);\n    hub.post(multicastFunctionRoute, dataMiddleware, multicastHandler);\n    hub.all(httpsFunctionRoutes, dataMiddleware, httpsHandler);\n    hub.all(\"*\", dataMiddleware, (req, res) => {\n      logger_1.logger.debug(`Functions emulator received unknown request at path ${req.path}`);\n      res.sendStatus(404);\n    });\n    return hub;\n  }\n\n  startFunctionRuntime(triggerId, targetName, signatureType, proto, runtimeOpts) {\n    const bundleTemplate = this.getBaseBundle();\n    const runtimeBundle = Object.assign(Object.assign({}, bundleTemplate), {\n      emulators: {\n        firestore: this.getEmulatorInfo(types_1.Emulators.FIRESTORE),\n        database: this.getEmulatorInfo(types_1.Emulators.DATABASE),\n        pubsub: this.getEmulatorInfo(types_1.Emulators.PUBSUB),\n        auth: this.getEmulatorInfo(types_1.Emulators.AUTH),\n        storage: this.getEmulatorInfo(types_1.Emulators.STORAGE)\n      },\n      nodeMajorVersion: this.args.nodeMajorVersion,\n      proto,\n      triggerId,\n      targetName\n    });\n    const opts = runtimeOpts || {\n      nodeBinary: this.nodeBinary,\n      extensionTriggers: this.args.predefinedTriggers\n    };\n    const worker = this.invokeRuntime(runtimeBundle, opts, this.getRuntimeEnvs({\n      targetName,\n      signatureType\n    }));\n    return worker;\n  }\n\n  async start() {\n    this.nodeBinary = this.askInstallNodeVersion(this.args.functionsDir, this.args.nodeMajorVersion);\n    const credentialEnv = await this.getCredentialsEnvironment();\n    this.args.env = Object.assign(Object.assign({}, credentialEnv), this.args.env);\n    const adminSdkConfig = await adminSdkConfig_1.getProjectAdminSdkConfigOrCached(this.args.projectId);\n\n    if (adminSdkConfig) {\n      this.adminSdkConfig = adminSdkConfig;\n    } else {\n      this.logger.logLabeled(\"WARN\", \"functions\", \"Unable to fetch project Admin SDK configuration, Admin SDK behavior in Cloud Functions emulator may be incorrect.\");\n      this.adminSdkConfig = adminSdkConfig_1.constructDefaultAdminSdkConfig(this.args.projectId);\n    }\n\n    const {\n      host,\n      port\n    } = this.getInfo();\n    this.workQueue.start();\n    const server = this.createHubServer().listen(port, host);\n    this.destroyServer = utils_1.createDestroyer(server);\n    return Promise.resolve();\n  }\n\n  async connect() {\n    this.logger.logLabeled(\"BULLET\", \"functions\", `Watching \"${this.args.functionsDir}\" for Cloud Functions...`);\n    const watcher = chokidar.watch(this.args.functionsDir, {\n      ignored: [/.+?[\\\\\\/]node_modules[\\\\\\/].+?/, /(^|[\\/\\\\])\\../, /.+\\.log/],\n      persistent: true\n    });\n\n    const debouncedLoadTriggers = _.debounce(() => this.loadTriggers(), 1000);\n\n    watcher.on(\"change\", filePath => {\n      this.logger.log(\"DEBUG\", `File ${filePath} changed, reloading triggers`);\n      return debouncedLoadTriggers();\n    });\n    return this.loadTriggers(true);\n  }\n\n  async stop() {\n    try {\n      await this.workQueue.flush();\n    } catch (e) {\n      this.logger.logLabeled(\"WARN\", \"functions\", \"Functions emulator work queue did not empty before stopping\");\n    }\n\n    this.workQueue.stop();\n    this.workerPool.exit();\n\n    if (this.destroyServer) {\n      await this.destroyServer();\n    }\n  }\n\n  async loadTriggers(force = false) {\n    this.workerPool.refresh();\n    const worker = this.invokeRuntime(this.getBaseBundle(), {\n      nodeBinary: this.nodeBinary,\n      extensionTriggers: this.args.predefinedTriggers\n    }, Object.assign(Object.assign(Object.assign(Object.assign({}, this.getSystemEnvs()), this.getEmulatorEnvs()), {\n      FIREBASE_CONFIG: this.getFirebaseConfig()\n    }), this.args.env));\n    const triggerParseEvent = await types_1.EmulatorLog.waitForLog(worker.runtime.events, \"SYSTEM\", \"triggers-parsed\");\n    const parsedDefinitions = triggerParseEvent.data.triggerDefinitions;\n    const triggerDefinitions = functionsEmulatorShared_1.emulatedFunctionsByRegion(parsedDefinitions);\n    const toSetup = triggerDefinitions.filter(definition => {\n      if (force) {\n        return true;\n      }\n\n      const anyEnabledMatch = Object.values(this.triggers).some(record => {\n        const sameEntryPoint = record.def.entryPoint === definition.entryPoint;\n        const sameEventTrigger = JSON.stringify(record.def.eventTrigger) === JSON.stringify(definition.eventTrigger);\n\n        if (sameEntryPoint && !sameEventTrigger) {\n          this.logger.log(\"DEBUG\", `Definition for trigger ${definition.entryPoint} changed from ${JSON.stringify(record.def.eventTrigger)} to ${JSON.stringify(definition.eventTrigger)}`);\n        }\n\n        return record.enabled && sameEntryPoint && sameEventTrigger;\n      });\n      return !anyEnabledMatch;\n    });\n\n    for (const definition of toSetup) {\n      let added = false;\n      let url = undefined;\n\n      if (definition.httpsTrigger) {\n        const {\n          host,\n          port\n        } = this.getInfo();\n        added = true;\n        url = FunctionsEmulator.getHttpFunctionUrl(host, port, this.args.projectId, definition.name, definition.region);\n      } else if (definition.eventTrigger) {\n        const service = functionsEmulatorShared_1.getFunctionService(definition);\n        const key = this.getTriggerKey(definition);\n        const signature = functionsEmulatorShared_1.getSignatureType(definition);\n\n        switch (service) {\n          case constants_1.Constants.SERVICE_FIRESTORE:\n            added = await this.addFirestoreTrigger(this.args.projectId, key, definition.eventTrigger);\n            break;\n\n          case constants_1.Constants.SERVICE_REALTIME_DATABASE:\n            added = await this.addRealtimeDatabaseTrigger(this.args.projectId, key, definition.eventTrigger);\n            break;\n\n          case constants_1.Constants.SERVICE_PUBSUB:\n            added = await this.addPubsubTrigger(definition.name, key, definition.eventTrigger, signature, definition.schedule);\n            break;\n\n          case constants_1.Constants.SERVICE_AUTH:\n            added = this.addAuthTrigger(this.args.projectId, key, definition.eventTrigger);\n            break;\n\n          case constants_1.Constants.SERVICE_STORAGE:\n            added = this.addStorageTrigger(this.args.projectId, key, definition.eventTrigger);\n            break;\n\n          default:\n            this.logger.log(\"DEBUG\", `Unsupported trigger: ${JSON.stringify(definition)}`);\n            break;\n        }\n      } else {\n        this.logger.log(\"WARN\", `Trigger trigger \"${definition.name}\" has has neither \"httpsTrigger\" or \"eventTrigger\" member`);\n      }\n\n      const ignored = !added;\n      this.addTriggerRecord(definition, {\n        ignored,\n        url\n      });\n      const type = definition.httpsTrigger ? \"http\" : constants_1.Constants.getServiceName(functionsEmulatorShared_1.getFunctionService(definition));\n\n      if (ignored) {\n        const msg = `function ignored because the ${type} emulator does not exist or is not running.`;\n        this.logger.logLabeled(\"BULLET\", `functions[${definition.id}]`, msg);\n      } else {\n        const msg = url ? `${clc.bold(type)} function initialized (${url}).` : `${clc.bold(type)} function initialized.`;\n        this.logger.logLabeled(\"SUCCESS\", `functions[${definition.id}]`, msg);\n      }\n    }\n  }\n\n  addRealtimeDatabaseTrigger(projectId, key, eventTrigger) {\n    const databaseEmu = registry_1.EmulatorRegistry.get(types_1.Emulators.DATABASE);\n\n    if (!databaseEmu) {\n      return Promise.resolve(false);\n    }\n\n    const result = DATABASE_PATH_PATTERN.exec(eventTrigger.resource);\n\n    if (result === null || result.length !== 3) {\n      this.logger.log(\"WARN\", `Event trigger \"${key}\" has malformed \"resource\" member. ` + `${eventTrigger.resource}`);\n      return Promise.reject();\n    }\n\n    const instance = result[1];\n    const bundle = JSON.stringify({\n      name: `projects/${projectId}/locations/_/functions/${key}`,\n      path: result[2],\n      event: eventTrigger.eventType,\n      topic: `projects/${projectId}/topics/${key}`\n    });\n    logger_1.logger.debug(`addRealtimeDatabaseTrigger[${instance}]`, JSON.stringify(bundle));\n    let setTriggersPath = \"/.settings/functionTriggers.json\";\n\n    if (instance !== \"\") {\n      setTriggersPath += `?ns=${instance}`;\n    } else {\n      this.logger.log(\"WARN\", `No project in use. Registering function trigger for sentinel namespace '${constants_1.Constants.DEFAULT_DATABASE_EMULATOR_NAMESPACE}'`);\n    }\n\n    return api.request(\"POST\", setTriggersPath, {\n      origin: `http://${registry_1.EmulatorRegistry.getInfoHostString(databaseEmu.getInfo())}`,\n      headers: {\n        Authorization: \"Bearer owner\"\n      },\n      data: bundle,\n      json: false\n    }).then(() => {\n      return true;\n    }).catch(err => {\n      this.logger.log(\"WARN\", \"Error adding trigger: \" + err);\n      throw err;\n    });\n  }\n\n  addFirestoreTrigger(projectId, key, eventTrigger) {\n    const firestoreEmu = registry_1.EmulatorRegistry.get(types_1.Emulators.FIRESTORE);\n\n    if (!firestoreEmu) {\n      return Promise.resolve(false);\n    }\n\n    const bundle = JSON.stringify({\n      eventTrigger\n    });\n    logger_1.logger.debug(`addFirestoreTrigger`, JSON.stringify(bundle));\n    return api.request(\"PUT\", `/emulator/v1/projects/${projectId}/triggers/${key}`, {\n      origin: `http://${registry_1.EmulatorRegistry.getInfoHostString(firestoreEmu.getInfo())}`,\n      data: bundle,\n      json: false\n    }).then(() => {\n      return true;\n    }).catch(err => {\n      this.logger.log(\"WARN\", \"Error adding trigger: \" + err);\n      throw err;\n    });\n  }\n\n  async addPubsubTrigger(triggerName, key, eventTrigger, signatureType, schedule) {\n    const pubsubPort = registry_1.EmulatorRegistry.getPort(types_1.Emulators.PUBSUB);\n\n    if (!pubsubPort) {\n      return false;\n    }\n\n    const pubsubEmulator = registry_1.EmulatorRegistry.get(types_1.Emulators.PUBSUB);\n    logger_1.logger.debug(`addPubsubTrigger`, JSON.stringify({\n      eventTrigger\n    }));\n    const resource = eventTrigger.resource;\n    let topic;\n\n    if (schedule) {\n      topic = \"firebase-schedule-\" + triggerName;\n    } else {\n      const resourceParts = resource.split(\"/\");\n      topic = resourceParts[resourceParts.length - 1];\n    }\n\n    try {\n      await pubsubEmulator.addTrigger(topic, key, signatureType);\n      return true;\n    } catch (e) {\n      return false;\n    }\n  }\n\n  addAuthTrigger(projectId, key, eventTrigger) {\n    logger_1.logger.debug(`addAuthTrigger`, JSON.stringify({\n      eventTrigger\n    }));\n    const eventTriggerId = `${projectId}:${eventTrigger.eventType}`;\n    const triggers = this.multicastTriggers[eventTriggerId] || [];\n    triggers.push(key);\n    this.multicastTriggers[eventTriggerId] = triggers;\n    return true;\n  }\n\n  addStorageTrigger(projectId, key, eventTrigger) {\n    logger_1.logger.debug(`addStorageTrigger`, JSON.stringify({\n      eventTrigger\n    }));\n    const eventTriggerId = `${projectId}:${eventTrigger.eventType}`;\n    const triggers = this.multicastTriggers[eventTriggerId] || [];\n    triggers.push(key);\n    this.multicastTriggers[eventTriggerId] = triggers;\n    return true;\n  }\n\n  getProjectId() {\n    return this.args.projectId;\n  }\n\n  getInfo() {\n    const host = this.args.host || constants_1.Constants.getDefaultHost(types_1.Emulators.FUNCTIONS);\n    const port = this.args.port || constants_1.Constants.getDefaultPort(types_1.Emulators.FUNCTIONS);\n    return {\n      name: this.getName(),\n      host,\n      port\n    };\n  }\n\n  getName() {\n    return types_1.Emulators.FUNCTIONS;\n  }\n\n  getTriggerDefinitions() {\n    return Object.values(this.triggers).map(record => record.def);\n  }\n\n  getTriggerDefinitionByKey(triggerKey) {\n    const record = this.triggers[triggerKey];\n\n    if (!record) {\n      logger_1.logger.debug(`Could not find key=${triggerKey} in ${JSON.stringify(this.triggers)}`);\n      throw new error_1.FirebaseError(`No trigger with key ${triggerKey}`);\n    }\n\n    return record.def;\n  }\n\n  getTriggerKey(def) {\n    return def.eventTrigger ? `${def.id}-${this.triggerGeneration}` : def.id;\n  }\n\n  addTriggerRecord(def, opts) {\n    const key = this.getTriggerKey(def);\n    this.triggers[key] = {\n      def,\n      enabled: true,\n      ignored: opts.ignored,\n      url: opts.url\n    };\n  }\n\n  setTriggersForTesting(triggers) {\n    triggers.forEach(def => this.addTriggerRecord(def, {\n      ignored: false\n    }));\n  }\n\n  getBaseBundle() {\n    return {\n      cwd: this.args.functionsDir,\n      projectId: this.args.projectId,\n      triggerId: \"\",\n      targetName: \"\",\n      emulators: {\n        firestore: registry_1.EmulatorRegistry.getInfo(types_1.Emulators.FIRESTORE),\n        database: registry_1.EmulatorRegistry.getInfo(types_1.Emulators.DATABASE),\n        pubsub: registry_1.EmulatorRegistry.getInfo(types_1.Emulators.PUBSUB),\n        auth: registry_1.EmulatorRegistry.getInfo(types_1.Emulators.AUTH),\n        storage: registry_1.EmulatorRegistry.getInfo(types_1.Emulators.STORAGE)\n      },\n      adminSdkConfig: {\n        databaseURL: this.adminSdkConfig.databaseURL,\n        storageBucket: this.adminSdkConfig.storageBucket\n      },\n      disabled_features: this.args.disabledRuntimeFeatures\n    };\n  }\n\n  getRequestedNodeRuntimeVersion(frb) {\n    const pkg = require(path.join(frb.cwd, \"package.json\"));\n\n    return frb.nodeMajorVersion || pkg.engines && pkg.engines.node;\n  }\n\n  askInstallNodeVersion(cwd, nodeMajorVersion) {\n    const pkg = require(path.join(cwd, \"package.json\"));\n\n    if ((!pkg.engines || !pkg.engines.node) && !nodeMajorVersion) {\n      this.logger.log(\"WARN\", \"Your functions directory does not specify a Node version.\\n   \" + \"- Learn more at https://firebase.google.com/docs/functions/manage-functions#set_runtime_options\");\n      return process.execPath;\n    }\n\n    const hostMajorVersion = process.versions.node.split(\".\")[0];\n    const requestedMajorVersion = nodeMajorVersion ? `${nodeMajorVersion}` : pkg.engines.node;\n    let localMajorVersion = \"0\";\n    const localNodePath = path.join(cwd, \"node_modules/.bin/node\");\n\n    try {\n      const localNodeOutput = child_process_1.spawnSync(localNodePath, [\"--version\"]).stdout.toString();\n      localMajorVersion = localNodeOutput.slice(1).split(\".\")[0];\n    } catch (err) {}\n\n    if (requestedMajorVersion === localMajorVersion) {\n      this.logger.logLabeled(\"SUCCESS\", \"functions\", `Using node@${requestedMajorVersion} from local cache.`);\n      return localNodePath;\n    }\n\n    if (requestedMajorVersion === hostMajorVersion) {\n      this.logger.logLabeled(\"SUCCESS\", \"functions\", `Using node@${requestedMajorVersion} from host.`);\n      return process.execPath;\n    }\n\n    this.logger.log(\"WARN\", `Your requested \"node\" version \"${requestedMajorVersion}\" doesn't match your global version \"${hostMajorVersion}\"`);\n    return process.execPath;\n  }\n\n  getUserEnvs() {\n    const projectInfo = {\n      functionsSource: this.args.functionsDir,\n      projectId: this.args.projectId,\n      isEmulator: true\n    };\n\n    if (functionsEnv.hasUserEnvs(projectInfo)) {\n      try {\n        return functionsEnv.loadUserEnvs(projectInfo);\n      } catch (e) {\n        logger_1.logger.debug(\"Failed to load local environment variables\", e);\n      }\n    }\n\n    return {};\n  }\n\n  getSystemEnvs(triggerDef) {\n    const envs = {};\n    envs.GCLOUD_PROJECT = this.args.projectId;\n    envs.K_REVISION = \"1\";\n    envs.PORT = \"80\";\n\n    if (triggerDef) {\n      const service = triggerDef.targetName;\n      const target = service.replace(/-/g, \".\");\n      envs.FUNCTION_TARGET = target;\n      envs.FUNCTION_SIGNATURE_TYPE = triggerDef.signatureType;\n      envs.K_SERVICE = service;\n    }\n\n    return envs;\n  }\n\n  getEmulatorEnvs() {\n    const envs = {};\n    envs.FUNCTIONS_EMULATOR = \"true\";\n    envs.TZ = \"UTC\";\n    const firestoreEmulator = this.getEmulatorInfo(types_1.Emulators.FIRESTORE);\n\n    if (firestoreEmulator != null) {\n      envs[constants_1.Constants.FIRESTORE_EMULATOR_HOST] = functionsEmulatorShared_1.formatHost(firestoreEmulator);\n    }\n\n    const databaseEmulator = this.getEmulatorInfo(types_1.Emulators.DATABASE);\n\n    if (databaseEmulator) {\n      envs[constants_1.Constants.FIREBASE_DATABASE_EMULATOR_HOST] = functionsEmulatorShared_1.formatHost(databaseEmulator);\n    }\n\n    const authEmulator = this.getEmulatorInfo(types_1.Emulators.AUTH);\n\n    if (authEmulator) {\n      envs[constants_1.Constants.FIREBASE_AUTH_EMULATOR_HOST] = functionsEmulatorShared_1.formatHost(authEmulator);\n    }\n\n    const storageEmulator = this.getEmulatorInfo(types_1.Emulators.STORAGE);\n\n    if (storageEmulator) {\n      envs[constants_1.Constants.FIREBASE_STORAGE_EMULATOR_HOST] = functionsEmulatorShared_1.formatHost(storageEmulator);\n      envs[constants_1.Constants.CLOUD_STORAGE_EMULATOR_HOST] = `http://${functionsEmulatorShared_1.formatHost(storageEmulator)}`;\n    }\n\n    const pubsubEmulator = this.getEmulatorInfo(types_1.Emulators.PUBSUB);\n\n    if (pubsubEmulator) {\n      const pubsubHost = functionsEmulatorShared_1.formatHost(pubsubEmulator);\n      process.env.PUBSUB_EMULATOR_HOST = pubsubHost;\n    }\n\n    return envs;\n  }\n\n  getFirebaseConfig() {\n    const databaseEmulator = this.getEmulatorInfo(types_1.Emulators.DATABASE);\n    let emulatedDatabaseURL = undefined;\n\n    if (databaseEmulator) {\n      let ns = this.args.projectId;\n\n      if (this.adminSdkConfig.databaseURL) {\n        const asUrl = new url_1.URL(this.adminSdkConfig.databaseURL);\n        ns = asUrl.hostname.split(\".\")[0];\n      }\n\n      emulatedDatabaseURL = `http://${functionsEmulatorShared_1.formatHost(databaseEmulator)}/?ns=${ns}`;\n    }\n\n    return JSON.stringify({\n      storageBucket: this.adminSdkConfig.storageBucket,\n      databaseURL: emulatedDatabaseURL || this.adminSdkConfig.databaseURL,\n      projectId: this.args.projectId\n    });\n  }\n\n  getRuntimeEnvs(triggerDef) {\n    return Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({}, this.getUserEnvs()), this.getSystemEnvs(triggerDef)), this.getEmulatorEnvs()), {\n      FIREBASE_CONFIG: this.getFirebaseConfig()\n    }), this.args.env);\n  }\n\n  invokeRuntime(frb, opts, runtimeEnv) {\n    if (this.workerPool.readyForWork(frb.triggerId)) {\n      return this.workerPool.submitWork(frb.triggerId, frb, opts);\n    }\n\n    const emitter = new events_1.EventEmitter();\n    const args = [path.join(__dirname, \"functionsEmulatorRuntime\")];\n\n    if (opts.ignore_warnings) {\n      args.unshift(\"--no-warnings\");\n    }\n\n    if (this.args.debugPort) {\n      if (process.env.FIREPIT_VERSION && process.execPath == opts.nodeBinary) {\n        const requestedMajorNodeVersion = this.getRequestedNodeRuntimeVersion(frb);\n        this.logger.log(\"WARN\", `To enable function inspection, please run \"${process.execPath} is:npm i node@${requestedMajorNodeVersion} --save-dev\" in your functions directory`);\n      } else {\n        const {\n          host\n        } = this.getInfo();\n        args.unshift(`--inspect=${host}:${this.args.debugPort}`);\n      }\n    }\n\n    const pnpPath = path.join(frb.cwd, \".pnp.js\");\n\n    if (fs.existsSync(pnpPath)) {\n      emulatorLogger_1.EmulatorLogger.forEmulator(types_1.Emulators.FUNCTIONS).logLabeled(\"WARN_ONCE\", \"functions\", \"Detected yarn@2 with PnP. \" + \"Cloud Functions for Firebase requires a node_modules folder to work correctly and is therefore incompatible with PnP. \" + \"See https://yarnpkg.com/getting-started/migration#step-by-step for more information.\");\n    }\n\n    const childProcess = spawn(opts.nodeBinary, args, {\n      env: Object.assign(Object.assign({\n        node: opts.nodeBinary\n      }, process.env), runtimeEnv !== null && runtimeEnv !== void 0 ? runtimeEnv : {}),\n      cwd: frb.cwd,\n      stdio: [\"pipe\", \"pipe\", \"pipe\", \"ipc\"]\n    });\n    const buffers = {\n      stderr: {\n        pipe: childProcess.stderr,\n        value: \"\"\n      },\n      stdout: {\n        pipe: childProcess.stdout,\n        value: \"\"\n      }\n    };\n    const ipcBuffer = {\n      value: \"\"\n    };\n    childProcess.on(\"message\", message => {\n      this.onData(childProcess, emitter, ipcBuffer, message);\n    });\n\n    for (const id in buffers) {\n      if (buffers.hasOwnProperty(id)) {\n        const buffer = buffers[id];\n        buffer.pipe.on(\"data\", buf => {\n          this.onData(childProcess, emitter, buffer, buf);\n        });\n      }\n    }\n\n    const runtime = {\n      pid: childProcess.pid,\n      exit: new Promise(resolve => {\n        childProcess.on(\"exit\", resolve);\n      }),\n      events: emitter,\n      shutdown: () => {\n        childProcess.kill();\n      },\n      kill: signal => {\n        childProcess.kill(signal);\n        emitter.emit(\"log\", new types_1.EmulatorLog(\"SYSTEM\", \"runtime-status\", \"killed\"));\n      },\n      send: args => {\n        return childProcess.send(JSON.stringify(args));\n      }\n    };\n    this.workerPool.addWorker(frb.triggerId, runtime);\n    return this.workerPool.submitWork(frb.triggerId, frb, opts);\n  }\n\n  async disableBackgroundTriggers() {\n    Object.values(this.triggers).forEach(record => {\n      if (record.def.eventTrigger && record.enabled) {\n        this.logger.logLabeled(\"BULLET\", `functions[${record.def.entryPoint}]`, \"function temporarily disabled.\");\n        record.enabled = false;\n      }\n    });\n    await this.workQueue.flush();\n  }\n\n  async reloadTriggers() {\n    this.triggerGeneration++;\n    return this.loadTriggers();\n  }\n\n  async handleBackgroundTrigger(projectId, triggerKey, proto) {\n    const record = this.triggers[triggerKey];\n\n    if (record && !record.enabled) {\n      return Promise.reject({\n        code: 204,\n        body: \"Background triggers are curently disabled.\"\n      });\n    }\n\n    const trigger = this.getTriggerDefinitionByKey(triggerKey);\n    const service = functionsEmulatorShared_1.getFunctionService(trigger);\n    const worker = this.startFunctionRuntime(trigger.id, trigger.name, functionsEmulatorShared_1.getSignatureType(trigger), proto);\n    return new Promise((resolve, reject) => {\n      if (projectId !== this.args.projectId) {\n        if (service !== constants_1.Constants.SERVICE_REALTIME_DATABASE) {\n          logger_1.logger.debug(`Received functions trigger for service \"${service}\" for unknown project \"${projectId}\".`);\n          reject({\n            code: 404\n          });\n          return;\n        }\n\n        if (!trigger.eventTrigger.resource.startsWith(`projects/_/instances/${projectId}`)) {\n          logger_1.logger.debug(`Received functions trigger for function \"${trigger.name}\" of project \"${projectId}\" that did not match definition: ${JSON.stringify(trigger)}.`);\n          reject({\n            code: 404\n          });\n          return;\n        }\n      }\n\n      worker.onLogs(el => {\n        if (el.level === \"FATAL\") {\n          reject({\n            code: 500,\n            body: el.text\n          });\n        }\n      });\n      track(EVENT_INVOKE, functionsEmulatorShared_1.getFunctionService(trigger));\n      worker.waitForDone().then(() => {\n        resolve({\n          status: \"acknowledged\"\n        });\n      });\n    });\n  }\n\n  getEmulatorInfo(emulator) {\n    if (this.args.remoteEmulators) {\n      if (this.args.remoteEmulators[emulator]) {\n        return this.args.remoteEmulators[emulator];\n      }\n    }\n\n    return registry_1.EmulatorRegistry.getInfo(emulator);\n  }\n\n  tokenFromAuthHeader(authHeader) {\n    const match = authHeader.match(/^Bearer (.*)$/);\n\n    if (!match) {\n      return;\n    }\n\n    let idToken = match[1];\n    logger_1.logger.debug(`ID Token: ${idToken}`);\n\n    if (idToken && idToken.includes(\"=\")) {\n      idToken = idToken.replace(/[=]+?\\./g, \".\");\n      logger_1.logger.debug(`ID Token contained invalid padding, new value: ${idToken}`);\n    }\n\n    try {\n      const decoded = jwt.decode(idToken, {\n        complete: true\n      });\n\n      if (!decoded || typeof decoded !== \"object\") {\n        logger_1.logger.debug(`Failed to decode ID Token: ${decoded}`);\n        return;\n      }\n\n      const claims = decoded.payload;\n      claims.uid = claims.sub;\n      return claims;\n    } catch (e) {\n      return;\n    }\n  }\n\n  async handleHttpsTrigger(req, res) {\n    const method = req.method;\n    const region = req.params.region;\n    const triggerName = req.params.trigger_name;\n    const triggerId = `${region}-${triggerName}`;\n\n    if (!this.triggers[triggerId]) {\n      res.status(404).send(`Function ${triggerId} does not exist, valid triggers are: ${Object.keys(this.triggers).join(\", \")}`);\n      return;\n    }\n\n    const trigger = this.getTriggerDefinitionByKey(triggerId);\n    logger_1.logger.debug(`Accepted request ${method} ${req.url} --> ${triggerId}`);\n    const reqBody = req.rawBody;\n    const isCallable = trigger.labels && trigger.labels[\"deployment-callable\"] === \"true\";\n    const authHeader = req.header(\"Authorization\");\n\n    if (authHeader && isCallable) {\n      const token = this.tokenFromAuthHeader(authHeader);\n\n      if (token) {\n        const contextAuth = {\n          uid: token.uid,\n          token: token\n        };\n        req.headers[functionsEmulatorShared_1.HttpConstants.ORIGINAL_AUTH_HEADER] = req.headers[\"authorization\"];\n        delete req.headers[\"authorization\"];\n        req.headers[functionsEmulatorShared_1.HttpConstants.CALLABLE_AUTH_HEADER] = encodeURIComponent(JSON.stringify(contextAuth));\n      }\n    }\n\n    const worker = this.startFunctionRuntime(trigger.id, trigger.name, \"http\", undefined);\n    worker.onLogs(el => {\n      if (el.level === \"FATAL\") {\n        res.status(500).send(el.text);\n      }\n    });\n    await worker.waitForSocketReady();\n    track(EVENT_INVOKE, \"https\");\n    this.logger.log(\"DEBUG\", `[functions] Runtime ready! Sending request!`);\n\n    if (!worker.lastArgs) {\n      throw new error_1.FirebaseError(\"Cannot execute on a worker with no arguments\");\n    }\n\n    if (!worker.lastArgs.frb.socketPath) {\n      throw new error_1.FirebaseError(`Cannot execute on a worker without a socketPath: ${JSON.stringify(worker.lastArgs)}`);\n    }\n\n    const url = new url_1.URL(`${req.protocol}://${req.hostname}${req.url}`);\n    const path = `${url.pathname}${url.search}`.replace(new RegExp(`\\/${this.args.projectId}\\/[^\\/]*\\/${triggerName}\\/?`), \"/\");\n    this.logger.log(\"DEBUG\", `[functions] Got req.url=${req.url}, mapping to path=${path}`);\n    const runtimeReq = http.request({\n      method,\n      path,\n      headers: req.headers,\n      socketPath: worker.lastArgs.frb.socketPath\n    }, runtimeRes => {\n      function forwardStatusAndHeaders() {\n        res.status(runtimeRes.statusCode || 200);\n\n        if (!res.headersSent) {\n          Object.keys(runtimeRes.headers).forEach(key => {\n            const val = runtimeRes.headers[key];\n\n            if (val) {\n              res.setHeader(key, val);\n            }\n          });\n        }\n      }\n\n      runtimeRes.on(\"data\", buf => {\n        forwardStatusAndHeaders();\n        res.write(buf);\n      });\n      runtimeRes.on(\"close\", () => {\n        forwardStatusAndHeaders();\n        res.end();\n      });\n      runtimeRes.on(\"end\", () => {\n        forwardStatusAndHeaders();\n        res.end();\n      });\n    });\n    runtimeReq.on(\"error\", () => {\n      res.end();\n    });\n\n    if (reqBody) {\n      runtimeReq.write(reqBody);\n      runtimeReq.end();\n    }\n\n    req.pipe(runtimeReq, {\n      end: true\n    }).on(\"error\", () => {\n      res.end();\n    });\n    await worker.waitForDone();\n  }\n\n  onData(runtime, emitter, buffer, buf) {\n    buffer.value += buf.toString();\n    const lines = buffer.value.split(\"\\n\");\n\n    if (lines.length > 1) {\n      lines.slice(0, -1).forEach(line => {\n        const log = types_1.EmulatorLog.fromJSON(line);\n        emitter.emit(\"log\", log);\n\n        if (log.level === \"FATAL\") {\n          emitter.emit(\"log\", new types_1.EmulatorLog(\"SYSTEM\", \"runtime-status\", \"killed\"));\n          runtime.kill();\n        }\n      });\n    }\n\n    buffer.value = lines[lines.length - 1];\n  }\n\n}\n\nexports.FunctionsEmulator = FunctionsEmulator;","map":{"version":3,"sources":["C:/Users/Sharik/Desktop/Projects/ReactProject/my-first-app/node_modules/firebase-tools/lib/emulator/functionsEmulator.js"],"names":["Object","defineProperty","exports","value","FunctionsEmulator","_","require","fs","path","express","clc","http","jwt","url_1","api","logger_1","track","constants_1","types_1","chokidar","spawn","child_process_1","functionsEmulatorShared_1","registry_1","events_1","emulatorLogger_1","functionsRuntimeWorker_1","error_1","workQueue_1","utils_1","defaultCredentials_1","adminSdkConfig_1","functionsEnv","types_2","EVENT_INVOKE","DATABASE_PATH_PATTERN","RegExp","constructor","args","nodeBinary","triggers","triggerGeneration","logger","EmulatorLogger","forEmulator","Emulators","FUNCTIONS","multicastTriggers","verbosity","quiet","Verbosity","QUIET","DEBUG","debugPort","disabledRuntimeFeatures","timeout","adminSdkConfig","projectId","mode","FunctionsExecutionMode","SEQUENTIAL","AUTO","workerPool","RuntimeWorkerPool","workQueue","WorkQueue","getHttpFunctionUrl","host","port","name","region","getCredentialsEnvironment","credentialEnv","process","env","GOOGLE_APPLICATION_CREDENTIALS","logLabeled","account","defaultCredPath","getCredentialPathAsync","log","createHubServer","start","hub","dataMiddleware","req","res","next","chunks","on","chunk","push","rawBody","Buffer","concat","backgroundFunctionRoute","httpsFunctionRoute","multicastFunctionRoute","httpsFunctionRoutes","backgroundHandler","_a","params","triggerId","trigger_name","project_id","reqBody","proto","JSON","parse","toString","headers","includes","EventUtils","isBinaryCloudEvent","extractBinaryCloudEventContext","data","body","submit","method","url","handleBackgroundTrigger","then","x","json","catch","errorBundle","status","code","send","sendStatus","httpsHandler","handleHttpsTrigger","multicastHandler","triggerKey","type","eventType","forEach","post","all","debug","startFunctionRuntime","targetName","signatureType","runtimeOpts","bundleTemplate","getBaseBundle","runtimeBundle","assign","emulators","firestore","getEmulatorInfo","FIRESTORE","database","DATABASE","pubsub","PUBSUB","auth","AUTH","storage","STORAGE","nodeMajorVersion","opts","extensionTriggers","predefinedTriggers","worker","invokeRuntime","getRuntimeEnvs","askInstallNodeVersion","functionsDir","getProjectAdminSdkConfigOrCached","constructDefaultAdminSdkConfig","getInfo","server","listen","destroyServer","createDestroyer","Promise","resolve","connect","watcher","watch","ignored","persistent","debouncedLoadTriggers","debounce","loadTriggers","filePath","stop","flush","e","exit","force","refresh","getSystemEnvs","getEmulatorEnvs","FIREBASE_CONFIG","getFirebaseConfig","triggerParseEvent","EmulatorLog","waitForLog","runtime","events","parsedDefinitions","triggerDefinitions","emulatedFunctionsByRegion","toSetup","filter","definition","anyEnabledMatch","values","some","record","sameEntryPoint","def","entryPoint","sameEventTrigger","stringify","eventTrigger","enabled","added","undefined","httpsTrigger","service","getFunctionService","key","getTriggerKey","signature","getSignatureType","Constants","SERVICE_FIRESTORE","addFirestoreTrigger","SERVICE_REALTIME_DATABASE","addRealtimeDatabaseTrigger","SERVICE_PUBSUB","addPubsubTrigger","schedule","SERVICE_AUTH","addAuthTrigger","SERVICE_STORAGE","addStorageTrigger","addTriggerRecord","getServiceName","msg","id","bold","databaseEmu","EmulatorRegistry","get","result","exec","resource","length","reject","instance","bundle","event","topic","setTriggersPath","DEFAULT_DATABASE_EMULATOR_NAMESPACE","request","origin","getInfoHostString","Authorization","err","firestoreEmu","triggerName","pubsubPort","getPort","pubsubEmulator","resourceParts","split","addTrigger","eventTriggerId","getProjectId","getDefaultHost","getDefaultPort","getName","getTriggerDefinitions","map","getTriggerDefinitionByKey","FirebaseError","setTriggersForTesting","cwd","databaseURL","storageBucket","disabled_features","getRequestedNodeRuntimeVersion","frb","pkg","join","engines","node","execPath","hostMajorVersion","versions","requestedMajorVersion","localMajorVersion","localNodePath","localNodeOutput","spawnSync","stdout","slice","getUserEnvs","projectInfo","functionsSource","isEmulator","hasUserEnvs","loadUserEnvs","triggerDef","envs","GCLOUD_PROJECT","K_REVISION","PORT","target","replace","FUNCTION_TARGET","FUNCTION_SIGNATURE_TYPE","K_SERVICE","FUNCTIONS_EMULATOR","TZ","firestoreEmulator","FIRESTORE_EMULATOR_HOST","formatHost","databaseEmulator","FIREBASE_DATABASE_EMULATOR_HOST","authEmulator","FIREBASE_AUTH_EMULATOR_HOST","storageEmulator","FIREBASE_STORAGE_EMULATOR_HOST","CLOUD_STORAGE_EMULATOR_HOST","pubsubHost","PUBSUB_EMULATOR_HOST","emulatedDatabaseURL","ns","asUrl","URL","hostname","runtimeEnv","readyForWork","submitWork","emitter","EventEmitter","__dirname","ignore_warnings","unshift","FIREPIT_VERSION","requestedMajorNodeVersion","pnpPath","existsSync","childProcess","stdio","buffers","stderr","pipe","ipcBuffer","message","onData","hasOwnProperty","buffer","buf","pid","shutdown","kill","signal","emit","addWorker","disableBackgroundTriggers","reloadTriggers","trigger","startsWith","onLogs","el","level","text","waitForDone","emulator","remoteEmulators","tokenFromAuthHeader","authHeader","match","idToken","decoded","decode","complete","claims","payload","uid","sub","keys","isCallable","labels","header","token","contextAuth","HttpConstants","ORIGINAL_AUTH_HEADER","CALLABLE_AUTH_HEADER","encodeURIComponent","waitForSocketReady","lastArgs","socketPath","protocol","pathname","search","runtimeReq","runtimeRes","forwardStatusAndHeaders","statusCode","headersSent","val","setHeader","write","end","lines","line","fromJSON"],"mappings":"AAAA;;AACAA,MAAM,CAACC,cAAP,CAAsBC,OAAtB,EAA+B,YAA/B,EAA6C;AAAEC,EAAAA,KAAK,EAAE;AAAT,CAA7C;AACAD,OAAO,CAACE,iBAAR,GAA4B,KAAK,CAAjC;;AACA,MAAMC,CAAC,GAAGC,OAAO,CAAC,QAAD,CAAjB;;AACA,MAAMC,EAAE,GAAGD,OAAO,CAAC,IAAD,CAAlB;;AACA,MAAME,IAAI,GAAGF,OAAO,CAAC,MAAD,CAApB;;AACA,MAAMG,OAAO,GAAGH,OAAO,CAAC,SAAD,CAAvB;;AACA,MAAMI,GAAG,GAAGJ,OAAO,CAAC,WAAD,CAAnB;;AACA,MAAMK,IAAI,GAAGL,OAAO,CAAC,MAAD,CAApB;;AACA,MAAMM,GAAG,GAAGN,OAAO,CAAC,cAAD,CAAnB;;AACA,MAAMO,KAAK,GAAGP,OAAO,CAAC,KAAD,CAArB;;AACA,MAAMQ,GAAG,GAAGR,OAAO,CAAC,QAAD,CAAnB;;AACA,MAAMS,QAAQ,GAAGT,OAAO,CAAC,WAAD,CAAxB;;AACA,MAAMU,KAAK,GAAGV,OAAO,CAAC,UAAD,CAArB;;AACA,MAAMW,WAAW,GAAGX,OAAO,CAAC,aAAD,CAA3B;;AACA,MAAMY,OAAO,GAAGZ,OAAO,CAAC,SAAD,CAAvB;;AACA,MAAMa,QAAQ,GAAGb,OAAO,CAAC,UAAD,CAAxB;;AACA,MAAMc,KAAK,GAAGd,OAAO,CAAC,aAAD,CAArB;;AACA,MAAMe,eAAe,GAAGf,OAAO,CAAC,eAAD,CAA/B;;AACA,MAAMgB,yBAAyB,GAAGhB,OAAO,CAAC,2BAAD,CAAzC;;AACA,MAAMiB,UAAU,GAAGjB,OAAO,CAAC,YAAD,CAA1B;;AACA,MAAMkB,QAAQ,GAAGlB,OAAO,CAAC,QAAD,CAAxB;;AACA,MAAMmB,gBAAgB,GAAGnB,OAAO,CAAC,kBAAD,CAAhC;;AACA,MAAMoB,wBAAwB,GAAGpB,OAAO,CAAC,0BAAD,CAAxC;;AACA,MAAMqB,OAAO,GAAGrB,OAAO,CAAC,UAAD,CAAvB;;AACA,MAAMsB,WAAW,GAAGtB,OAAO,CAAC,aAAD,CAA3B;;AACA,MAAMuB,OAAO,GAAGvB,OAAO,CAAC,UAAD,CAAvB;;AACA,MAAMwB,oBAAoB,GAAGxB,OAAO,CAAC,uBAAD,CAApC;;AACA,MAAMyB,gBAAgB,GAAGzB,OAAO,CAAC,kBAAD,CAAhC;;AACA,MAAM0B,YAAY,GAAG1B,OAAO,CAAC,kBAAD,CAA5B;;AACA,MAAM2B,OAAO,GAAG3B,OAAO,CAAC,gBAAD,CAAvB;;AACA,MAAM4B,YAAY,GAAG,kBAArB;AACA,MAAMC,qBAAqB,GAAG,IAAIC,MAAJ,CAAW,8CAAX,CAA9B;;AACA,MAAMhC,iBAAN,CAAwB;AACpBiC,EAAAA,WAAW,CAACC,IAAD,EAAO;AACd,SAAKA,IAAL,GAAYA,IAAZ;AACA,SAAKC,UAAL,GAAkB,EAAlB;AACA,SAAKC,QAAL,GAAgB,EAAhB;AACA,SAAKC,iBAAL,GAAyB,CAAzB;AACA,SAAKC,MAAL,GAAcjB,gBAAgB,CAACkB,cAAjB,CAAgCC,WAAhC,CAA4C1B,OAAO,CAAC2B,SAAR,CAAkBC,SAA9D,CAAd;AACA,SAAKC,iBAAL,GAAyB,EAAzB;AACAtB,IAAAA,gBAAgB,CAACkB,cAAjB,CAAgCK,SAAhC,GAA4C,KAAKV,IAAL,CAAUW,KAAV,GAAkBxB,gBAAgB,CAACyB,SAAjB,CAA2BC,KAA7C,GAAqD1B,gBAAgB,CAACyB,SAAjB,CAA2BE,KAA5H;;AACA,QAAI,KAAKd,IAAL,CAAUe,SAAd,EAAyB;AACrB,WAAKf,IAAL,CAAUgB,uBAAV,GAAoC,KAAKhB,IAAL,CAAUgB,uBAAV,IAAqC,EAAzE;AACA,WAAKhB,IAAL,CAAUgB,uBAAV,CAAkCC,OAAlC,GAA4C,IAA5C;AACH;;AACD,SAAKC,cAAL,GAAsB;AAClBC,MAAAA,SAAS,EAAE,KAAKnB,IAAL,CAAUmB;AADH,KAAtB;AAGA,UAAMC,IAAI,GAAG,KAAKpB,IAAL,CAAUe,SAAV,GACPnC,OAAO,CAACyC,sBAAR,CAA+BC,UADxB,GAEP1C,OAAO,CAACyC,sBAAR,CAA+BE,IAFrC;AAGA,SAAKC,UAAL,GAAkB,IAAIpC,wBAAwB,CAACqC,iBAA7B,CAA+CL,IAA/C,CAAlB;AACA,SAAKM,SAAL,GAAiB,IAAIpC,WAAW,CAACqC,SAAhB,CAA0BP,IAA1B,CAAjB;AACH;;AACwB,SAAlBQ,kBAAkB,CAACC,IAAD,EAAOC,IAAP,EAAaX,SAAb,EAAwBY,IAAxB,EAA8BC,MAA9B,EAAsC;AAC3D,WAAQ,UAASH,IAAK,IAAGC,IAAK,IAAGX,SAAU,IAAGa,MAAO,IAAGD,IAAK,EAA7D;AACH;;AAC8B,QAAzBE,yBAAyB,GAAG;AAC9B,UAAMC,aAAa,GAAG,EAAtB;;AACA,QAAIC,OAAO,CAACC,GAAR,CAAYC,8BAAhB,EAAgD;AAC5C,WAAKjC,MAAL,CAAYkC,UAAZ,CAAuB,MAAvB,EAA+B,WAA/B,EAA6C,sEAAqEH,OAAO,CAACC,GAAR,CAAYC,8BAA+B,qFAA7J;AACH,KAFD,MAGK,IAAI,KAAKrC,IAAL,CAAUuC,OAAd,EAAuB;AACxB,YAAMC,eAAe,GAAG,MAAMhD,oBAAoB,CAACiD,sBAArB,CAA4C,KAAKzC,IAAL,CAAUuC,OAAtD,CAA9B;;AACA,UAAIC,eAAJ,EAAqB;AACjB,aAAKpC,MAAL,CAAYsC,GAAZ,CAAgB,OAAhB,EAA0B,kBAAiBF,eAAgB,EAA3D;AACAN,QAAAA,aAAa,CAACG,8BAAd,GAA+CG,eAA/C;AACH;AACJ,KANI,MAOA;AACD,WAAKpC,MAAL,CAAYkC,UAAZ,CAAuB,MAAvB,EAA+B,WAA/B,EAA4C,6LAA5C;AACH;;AACD,WAAOJ,aAAP;AACH;;AACDS,EAAAA,eAAe,GAAG;AACd,SAAKjB,SAAL,CAAekB,KAAf;AACA,UAAMC,GAAG,GAAG1E,OAAO,EAAnB;;AACA,UAAM2E,cAAc,GAAG,CAACC,GAAD,EAAMC,GAAN,EAAWC,IAAX,KAAoB;AACvC,YAAMC,MAAM,GAAG,EAAf;AACAH,MAAAA,GAAG,CAACI,EAAJ,CAAO,MAAP,EAAgBC,KAAD,IAAW;AACtBF,QAAAA,MAAM,CAACG,IAAP,CAAYD,KAAZ;AACH,OAFD;AAGAL,MAAAA,GAAG,CAACI,EAAJ,CAAO,KAAP,EAAc,MAAM;AAChBJ,QAAAA,GAAG,CAACO,OAAJ,GAAcC,MAAM,CAACC,MAAP,CAAcN,MAAd,CAAd;AACAD,QAAAA,IAAI;AACP,OAHD;AAIH,KATD;;AAUA,UAAMQ,uBAAuB,GAAI,wDAAjC;AACA,UAAMC,kBAAkB,GAAI,IAAG,KAAK1D,IAAL,CAAUmB,SAAU,wBAAnD;AACA,UAAMwC,sBAAsB,GAAI,mDAAhC;AACA,UAAMC,mBAAmB,GAAG,CAACF,kBAAD,EAAsB,GAAEA,kBAAmB,IAA3C,CAA5B;;AACA,UAAMG,iBAAiB,GAAG,CAACd,GAAD,EAAMC,GAAN,KAAc;AACpC,UAAIc,EAAJ;;AACA,YAAM9B,MAAM,GAAGe,GAAG,CAACgB,MAAJ,CAAW/B,MAA1B;AACA,YAAMgC,SAAS,GAAGjB,GAAG,CAACgB,MAAJ,CAAWE,YAA7B;AACA,YAAM9C,SAAS,GAAG4B,GAAG,CAACgB,MAAJ,CAAWG,UAA7B;AACA,YAAMC,OAAO,GAAGpB,GAAG,CAACO,OAApB;AACA,UAAIc,KAAK,GAAGC,IAAI,CAACC,KAAL,CAAWH,OAAO,CAACI,QAAR,EAAX,CAAZ;;AACA,UAAI,CAACT,EAAE,GAAGf,GAAG,CAACyB,OAAJ,CAAY,cAAZ,CAAN,MAAuC,IAAvC,IAA+CV,EAAE,KAAK,KAAK,CAA3D,GAA+D,KAAK,CAApE,GAAwEA,EAAE,CAACW,QAAH,CAAY,YAAZ,CAA5E,EAAuG;AACnG,YAAI9E,OAAO,CAAC+E,UAAR,CAAmBC,kBAAnB,CAAsC5B,GAAtC,CAAJ,EAAgD;AAC5CqB,UAAAA,KAAK,GAAGzE,OAAO,CAAC+E,UAAR,CAAmBE,8BAAnB,CAAkD7B,GAAlD,CAAR;AACAqB,UAAAA,KAAK,CAACS,IAAN,GAAa9B,GAAG,CAAC+B,IAAjB;AACH;AACJ;;AACD,WAAKpD,SAAL,CAAeqD,MAAf,CAAsB,MAAM;AACxB,aAAK3E,MAAL,CAAYsC,GAAZ,CAAgB,OAAhB,EAA0B,oBAAmBK,GAAG,CAACiC,MAAO,IAAGjC,GAAG,CAACkC,GAAI,QAAOjB,SAAU,EAApF;AACA,eAAO,KAAKkB,uBAAL,CAA6B/D,SAA7B,EAAwC6C,SAAxC,EAAmDI,KAAnD,EACFe,IADE,CACIC,CAAD,IAAOpC,GAAG,CAACqC,IAAJ,CAASD,CAAT,CADV,EAEFE,KAFE,CAEKC,WAAD,IAAiB;AACxB,cAAIA,WAAW,CAACT,IAAhB,EAAsB;AAClB9B,YAAAA,GAAG,CAACwC,MAAJ,CAAWD,WAAW,CAACE,IAAvB,EAA6BC,IAA7B,CAAkCH,WAAW,CAACT,IAA9C;AACH,WAFD,MAGK;AACD9B,YAAAA,GAAG,CAAC2C,UAAJ,CAAeJ,WAAW,CAACE,IAA3B;AACH;AACJ,SATM,CAAP;AAUH,OAZD;AAaH,KA1BD;;AA2BA,UAAMG,YAAY,GAAG,CAAC7C,GAAD,EAAMC,GAAN,KAAc;AAC/B,WAAKtB,SAAL,CAAeqD,MAAf,CAAsB,MAAM;AACxB,eAAO,KAAKc,kBAAL,CAAwB9C,GAAxB,EAA6BC,GAA7B,CAAP;AACH,OAFD;AAGH,KAJD;;AAKA,UAAM8C,gBAAgB,GAAG,CAAC/C,GAAD,EAAMC,GAAN,KAAc;AACnC,UAAIc,EAAJ;;AACA,YAAM3C,SAAS,GAAG4B,GAAG,CAACgB,MAAJ,CAAWG,UAA7B;AACA,YAAMC,OAAO,GAAGpB,GAAG,CAACO,OAApB;AACA,UAAIc,KAAK,GAAGC,IAAI,CAACC,KAAL,CAAWH,OAAO,CAACI,QAAR,EAAX,CAAZ;AACA,UAAIwB,UAAJ;;AACA,UAAI,CAACjC,EAAE,GAAGf,GAAG,CAACyB,OAAJ,CAAY,cAAZ,CAAN,MAAuC,IAAvC,IAA+CV,EAAE,KAAK,KAAK,CAA3D,GAA+D,KAAK,CAApE,GAAwEA,EAAE,CAACW,QAAH,CAAY,YAAZ,CAA5E,EAAuG;AACnGsB,QAAAA,UAAU,GAAI,GAAE,KAAK/F,IAAL,CAAUmB,SAAU,IAAGiD,KAAK,CAAC4B,IAAK,EAAlD;;AACA,YAAIrG,OAAO,CAAC+E,UAAR,CAAmBC,kBAAnB,CAAsC5B,GAAtC,CAAJ,EAAgD;AAC5CqB,UAAAA,KAAK,GAAGzE,OAAO,CAAC+E,UAAR,CAAmBE,8BAAnB,CAAkD7B,GAAlD,CAAR;AACAqB,UAAAA,KAAK,CAACS,IAAN,GAAa9B,GAAG,CAAC+B,IAAjB;AACH;AACJ,OAND,MAOK;AACDiB,QAAAA,UAAU,GAAI,GAAE,KAAK/F,IAAL,CAAUmB,SAAU,IAAGiD,KAAK,CAAC6B,SAAU,EAAvD;AACH;;AACD,YAAM/F,QAAQ,GAAG,KAAKO,iBAAL,CAAuBsF,UAAvB,KAAsC,EAAvD;AACA7F,MAAAA,QAAQ,CAACgG,OAAT,CAAkBlC,SAAD,IAAe;AAC5B,aAAKtC,SAAL,CAAeqD,MAAf,CAAsB,MAAM;AACxB,eAAK3E,MAAL,CAAYsC,GAAZ,CAAgB,OAAhB,EAA0B,8BAA6BK,GAAG,CAACiC,MAAO,IAAGjC,GAAG,CAACkC,GAAI,QAAOjB,SAAU,EAA9F;AACA,iBAAO,KAAKkB,uBAAL,CAA6B/D,SAA7B,EAAwC6C,SAAxC,EAAmDI,KAAnD,CAAP;AACH,SAHD;AAIH,OALD;AAMApB,MAAAA,GAAG,CAACqC,IAAJ,CAAS;AAAEG,QAAAA,MAAM,EAAE;AAAV,OAAT;AACH,KAxBD;;AAyBA3C,IAAAA,GAAG,CAACsD,IAAJ,CAAS1C,uBAAT,EAAkCX,cAAlC,EAAkDe,iBAAlD;AACAhB,IAAAA,GAAG,CAACsD,IAAJ,CAASxC,sBAAT,EAAiCb,cAAjC,EAAiDgD,gBAAjD;AACAjD,IAAAA,GAAG,CAACuD,GAAJ,CAAQxC,mBAAR,EAA6Bd,cAA7B,EAA6C8C,YAA7C;AACA/C,IAAAA,GAAG,CAACuD,GAAJ,CAAQ,GAAR,EAAatD,cAAb,EAA6B,CAACC,GAAD,EAAMC,GAAN,KAAc;AACvCvE,MAAAA,QAAQ,CAAC2B,MAAT,CAAgBiG,KAAhB,CAAuB,uDAAsDtD,GAAG,CAAC7E,IAAK,EAAtF;AACA8E,MAAAA,GAAG,CAAC2C,UAAJ,CAAe,GAAf;AACH,KAHD;AAIA,WAAO9C,GAAP;AACH;;AACDyD,EAAAA,oBAAoB,CAACtC,SAAD,EAAYuC,UAAZ,EAAwBC,aAAxB,EAAuCpC,KAAvC,EAA8CqC,WAA9C,EAA2D;AAC3E,UAAMC,cAAc,GAAG,KAAKC,aAAL,EAAvB;AACA,UAAMC,aAAa,GAAGlJ,MAAM,CAACmJ,MAAP,CAAcnJ,MAAM,CAACmJ,MAAP,CAAc,EAAd,EAAkBH,cAAlB,CAAd,EAAiD;AAAEI,MAAAA,SAAS,EAAE;AAC5EC,QAAAA,SAAS,EAAE,KAAKC,eAAL,CAAqBpI,OAAO,CAAC2B,SAAR,CAAkB0G,SAAvC,CADiE;AAE5EC,QAAAA,QAAQ,EAAE,KAAKF,eAAL,CAAqBpI,OAAO,CAAC2B,SAAR,CAAkB4G,QAAvC,CAFkE;AAG5EC,QAAAA,MAAM,EAAE,KAAKJ,eAAL,CAAqBpI,OAAO,CAAC2B,SAAR,CAAkB8G,MAAvC,CAHoE;AAI5EC,QAAAA,IAAI,EAAE,KAAKN,eAAL,CAAqBpI,OAAO,CAAC2B,SAAR,CAAkBgH,IAAvC,CAJsE;AAK5EC,QAAAA,OAAO,EAAE,KAAKR,eAAL,CAAqBpI,OAAO,CAAC2B,SAAR,CAAkBkH,OAAvC;AALmE,OAAb;AAMhEC,MAAAA,gBAAgB,EAAE,KAAK1H,IAAL,CAAU0H,gBANoC;AAMlBtD,MAAAA,KANkB;AAOnEJ,MAAAA,SAPmE;AAQnEuC,MAAAA;AARmE,KAAjD,CAAtB;AASA,UAAMoB,IAAI,GAAGlB,WAAW,IAAI;AACxBxG,MAAAA,UAAU,EAAE,KAAKA,UADO;AAExB2H,MAAAA,iBAAiB,EAAE,KAAK5H,IAAL,CAAU6H;AAFL,KAA5B;AAIA,UAAMC,MAAM,GAAG,KAAKC,aAAL,CAAmBnB,aAAnB,EAAkCe,IAAlC,EAAwC,KAAKK,cAAL,CAAoB;AAAEzB,MAAAA,UAAF;AAAcC,MAAAA;AAAd,KAApB,CAAxC,CAAf;AACA,WAAOsB,MAAP;AACH;;AACU,QAALlF,KAAK,GAAG;AACV,SAAK3C,UAAL,GAAkB,KAAKgI,qBAAL,CAA2B,KAAKjI,IAAL,CAAUkI,YAArC,EAAmD,KAAKlI,IAAL,CAAU0H,gBAA7D,CAAlB;AACA,UAAMxF,aAAa,GAAG,MAAM,KAAKD,yBAAL,EAA5B;AACA,SAAKjC,IAAL,CAAUoC,GAAV,GAAgB1E,MAAM,CAACmJ,MAAP,CAAcnJ,MAAM,CAACmJ,MAAP,CAAc,EAAd,EAAkB3E,aAAlB,CAAd,EAAgD,KAAKlC,IAAL,CAAUoC,GAA1D,CAAhB;AACA,UAAMlB,cAAc,GAAG,MAAMzB,gBAAgB,CAAC0I,gCAAjB,CAAkD,KAAKnI,IAAL,CAAUmB,SAA5D,CAA7B;;AACA,QAAID,cAAJ,EAAoB;AAChB,WAAKA,cAAL,GAAsBA,cAAtB;AACH,KAFD,MAGK;AACD,WAAKd,MAAL,CAAYkC,UAAZ,CAAuB,MAAvB,EAA+B,WAA/B,EAA4C,mHAA5C;AACA,WAAKpB,cAAL,GAAsBzB,gBAAgB,CAAC2I,8BAAjB,CAAgD,KAAKpI,IAAL,CAAUmB,SAA1D,CAAtB;AACH;;AACD,UAAM;AAAEU,MAAAA,IAAF;AAAQC,MAAAA;AAAR,QAAiB,KAAKuG,OAAL,EAAvB;AACA,SAAK3G,SAAL,CAAekB,KAAf;AACA,UAAM0F,MAAM,GAAG,KAAK3F,eAAL,GAAuB4F,MAAvB,CAA8BzG,IAA9B,EAAoCD,IAApC,CAAf;AACA,SAAK2G,aAAL,GAAqBjJ,OAAO,CAACkJ,eAAR,CAAwBH,MAAxB,CAArB;AACA,WAAOI,OAAO,CAACC,OAAR,EAAP;AACH;;AACY,QAAPC,OAAO,GAAG;AACZ,SAAKxI,MAAL,CAAYkC,UAAZ,CAAuB,QAAvB,EAAiC,WAAjC,EAA+C,aAAY,KAAKtC,IAAL,CAAUkI,YAAa,0BAAlF;AACA,UAAMW,OAAO,GAAGhK,QAAQ,CAACiK,KAAT,CAAe,KAAK9I,IAAL,CAAUkI,YAAzB,EAAuC;AACnDa,MAAAA,OAAO,EAAE,CACL,gCADK,EAEL,eAFK,EAGL,SAHK,CAD0C;AAMnDC,MAAAA,UAAU,EAAE;AANuC,KAAvC,CAAhB;;AAQA,UAAMC,qBAAqB,GAAGlL,CAAC,CAACmL,QAAF,CAAW,MAAM,KAAKC,YAAL,EAAjB,EAAsC,IAAtC,CAA9B;;AACAN,IAAAA,OAAO,CAAC1F,EAAR,CAAW,QAAX,EAAsBiG,QAAD,IAAc;AAC/B,WAAKhJ,MAAL,CAAYsC,GAAZ,CAAgB,OAAhB,EAA0B,QAAO0G,QAAS,8BAA1C;AACA,aAAOH,qBAAqB,EAA5B;AACH,KAHD;AAIA,WAAO,KAAKE,YAAL,CAAkB,IAAlB,CAAP;AACH;;AACS,QAAJE,IAAI,GAAG;AACT,QAAI;AACA,YAAM,KAAK3H,SAAL,CAAe4H,KAAf,EAAN;AACH,KAFD,CAGA,OAAOC,CAAP,EAAU;AACN,WAAKnJ,MAAL,CAAYkC,UAAZ,CAAuB,MAAvB,EAA+B,WAA/B,EAA4C,6DAA5C;AACH;;AACD,SAAKZ,SAAL,CAAe2H,IAAf;AACA,SAAK7H,UAAL,CAAgBgI,IAAhB;;AACA,QAAI,KAAKhB,aAAT,EAAwB;AACpB,YAAM,KAAKA,aAAL,EAAN;AACH;AACJ;;AACiB,QAAZW,YAAY,CAACM,KAAK,GAAG,KAAT,EAAgB;AAC9B,SAAKjI,UAAL,CAAgBkI,OAAhB;AACA,UAAM5B,MAAM,GAAG,KAAKC,aAAL,CAAmB,KAAKpB,aAAL,EAAnB,EAAyC;AACpD1G,MAAAA,UAAU,EAAE,KAAKA,UADmC;AAEpD2H,MAAAA,iBAAiB,EAAE,KAAK5H,IAAL,CAAU6H;AAFuB,KAAzC,EAGZnK,MAAM,CAACmJ,MAAP,CAAcnJ,MAAM,CAACmJ,MAAP,CAAcnJ,MAAM,CAACmJ,MAAP,CAAcnJ,MAAM,CAACmJ,MAAP,CAAc,EAAd,EAAkB,KAAK8C,aAAL,EAAlB,CAAd,EAAuD,KAAKC,eAAL,EAAvD,CAAd,EAA8F;AAAEC,MAAAA,eAAe,EAAE,KAAKC,iBAAL;AAAnB,KAA9F,CAAd,EAA4J,KAAK9J,IAAL,CAAUoC,GAAtK,CAHY,CAAf;AAIA,UAAM2H,iBAAiB,GAAG,MAAMnL,OAAO,CAACoL,WAAR,CAAoBC,UAApB,CAA+BnC,MAAM,CAACoC,OAAP,CAAeC,MAA9C,EAAsD,QAAtD,EAAgE,iBAAhE,CAAhC;AACA,UAAMC,iBAAiB,GAAGL,iBAAiB,CAAClF,IAAlB,CACrBwF,kBADL;AAEA,UAAMA,kBAAkB,GAAGrL,yBAAyB,CAACsL,yBAA1B,CAAoDF,iBAApD,CAA3B;AACA,UAAMG,OAAO,GAAGF,kBAAkB,CAACG,MAAnB,CAA2BC,UAAD,IAAgB;AACtD,UAAIhB,KAAJ,EAAW;AACP,eAAO,IAAP;AACH;;AACD,YAAMiB,eAAe,GAAGhN,MAAM,CAACiN,MAAP,CAAc,KAAKzK,QAAnB,EAA6B0K,IAA7B,CAAmCC,MAAD,IAAY;AAClE,cAAMC,cAAc,GAAGD,MAAM,CAACE,GAAP,CAAWC,UAAX,KAA0BP,UAAU,CAACO,UAA5D;AACA,cAAMC,gBAAgB,GAAG5G,IAAI,CAAC6G,SAAL,CAAeL,MAAM,CAACE,GAAP,CAAWI,YAA1B,MAA4C9G,IAAI,CAAC6G,SAAL,CAAeT,UAAU,CAACU,YAA1B,CAArE;;AACA,YAAIL,cAAc,IAAI,CAACG,gBAAvB,EAAyC;AACrC,eAAK7K,MAAL,CAAYsC,GAAZ,CAAgB,OAAhB,EAA0B,0BAAyB+H,UAAU,CAACO,UAAW,iBAAgB3G,IAAI,CAAC6G,SAAL,CAAeL,MAAM,CAACE,GAAP,CAAWI,YAA1B,CAAwC,OAAM9G,IAAI,CAAC6G,SAAL,CAAeT,UAAU,CAACU,YAA1B,CAAwC,EAA/K;AACH;;AACD,eAAON,MAAM,CAACO,OAAP,IAAkBN,cAAlB,IAAoCG,gBAA3C;AACH,OAPuB,CAAxB;AAQA,aAAO,CAACP,eAAR;AACH,KAbe,CAAhB;;AAcA,SAAK,MAAMD,UAAX,IAAyBF,OAAzB,EAAkC;AAC9B,UAAIc,KAAK,GAAG,KAAZ;AACA,UAAIpG,GAAG,GAAGqG,SAAV;;AACA,UAAIb,UAAU,CAACc,YAAf,EAA6B;AACzB,cAAM;AAAE1J,UAAAA,IAAF;AAAQC,UAAAA;AAAR,YAAiB,KAAKuG,OAAL,EAAvB;AACAgD,QAAAA,KAAK,GAAG,IAAR;AACApG,QAAAA,GAAG,GAAGnH,iBAAiB,CAAC8D,kBAAlB,CAAqCC,IAArC,EAA2CC,IAA3C,EAAiD,KAAK9B,IAAL,CAAUmB,SAA3D,EAAsEsJ,UAAU,CAAC1I,IAAjF,EAAuF0I,UAAU,CAACzI,MAAlG,CAAN;AACH,OAJD,MAKK,IAAIyI,UAAU,CAACU,YAAf,EAA6B;AAC9B,cAAMK,OAAO,GAAGxM,yBAAyB,CAACyM,kBAA1B,CAA6ChB,UAA7C,CAAhB;AACA,cAAMiB,GAAG,GAAG,KAAKC,aAAL,CAAmBlB,UAAnB,CAAZ;AACA,cAAMmB,SAAS,GAAG5M,yBAAyB,CAAC6M,gBAA1B,CAA2CpB,UAA3C,CAAlB;;AACA,gBAAQe,OAAR;AACI,eAAK7M,WAAW,CAACmN,SAAZ,CAAsBC,iBAA3B;AACIV,YAAAA,KAAK,GAAG,MAAM,KAAKW,mBAAL,CAAyB,KAAKhM,IAAL,CAAUmB,SAAnC,EAA8CuK,GAA9C,EAAmDjB,UAAU,CAACU,YAA9D,CAAd;AACA;;AACJ,eAAKxM,WAAW,CAACmN,SAAZ,CAAsBG,yBAA3B;AACIZ,YAAAA,KAAK,GAAG,MAAM,KAAKa,0BAAL,CAAgC,KAAKlM,IAAL,CAAUmB,SAA1C,EAAqDuK,GAArD,EAA0DjB,UAAU,CAACU,YAArE,CAAd;AACA;;AACJ,eAAKxM,WAAW,CAACmN,SAAZ,CAAsBK,cAA3B;AACId,YAAAA,KAAK,GAAG,MAAM,KAAKe,gBAAL,CAAsB3B,UAAU,CAAC1I,IAAjC,EAAuC2J,GAAvC,EAA4CjB,UAAU,CAACU,YAAvD,EAAqES,SAArE,EAAgFnB,UAAU,CAAC4B,QAA3F,CAAd;AACA;;AACJ,eAAK1N,WAAW,CAACmN,SAAZ,CAAsBQ,YAA3B;AACIjB,YAAAA,KAAK,GAAG,KAAKkB,cAAL,CAAoB,KAAKvM,IAAL,CAAUmB,SAA9B,EAAyCuK,GAAzC,EAA8CjB,UAAU,CAACU,YAAzD,CAAR;AACA;;AACJ,eAAKxM,WAAW,CAACmN,SAAZ,CAAsBU,eAA3B;AACInB,YAAAA,KAAK,GAAG,KAAKoB,iBAAL,CAAuB,KAAKzM,IAAL,CAAUmB,SAAjC,EAA4CuK,GAA5C,EAAiDjB,UAAU,CAACU,YAA5D,CAAR;AACA;;AACJ;AACI,iBAAK/K,MAAL,CAAYsC,GAAZ,CAAgB,OAAhB,EAA0B,wBAAuB2B,IAAI,CAAC6G,SAAL,CAAeT,UAAf,CAA2B,EAA5E;AACA;AAlBR;AAoBH,OAxBI,MAyBA;AACD,aAAKrK,MAAL,CAAYsC,GAAZ,CAAgB,MAAhB,EAAyB,oBAAmB+H,UAAU,CAAC1I,IAAK,2DAA5D;AACH;;AACD,YAAMgH,OAAO,GAAG,CAACsC,KAAjB;AACA,WAAKqB,gBAAL,CAAsBjC,UAAtB,EAAkC;AAAE1B,QAAAA,OAAF;AAAW9D,QAAAA;AAAX,OAAlC;AACA,YAAMe,IAAI,GAAGyE,UAAU,CAACc,YAAX,GACP,MADO,GAEP5M,WAAW,CAACmN,SAAZ,CAAsBa,cAAtB,CAAqC3N,yBAAyB,CAACyM,kBAA1B,CAA6ChB,UAA7C,CAArC,CAFN;;AAGA,UAAI1B,OAAJ,EAAa;AACT,cAAM6D,GAAG,GAAI,gCAA+B5G,IAAK,6CAAjD;AACA,aAAK5F,MAAL,CAAYkC,UAAZ,CAAuB,QAAvB,EAAkC,aAAYmI,UAAU,CAACoC,EAAG,GAA5D,EAAgED,GAAhE;AACH,OAHD,MAIK;AACD,cAAMA,GAAG,GAAG3H,GAAG,GACR,GAAE7G,GAAG,CAAC0O,IAAJ,CAAS9G,IAAT,CAAe,0BAAyBf,GAAI,IADtC,GAER,GAAE7G,GAAG,CAAC0O,IAAJ,CAAS9G,IAAT,CAAe,wBAFxB;AAGA,aAAK5F,MAAL,CAAYkC,UAAZ,CAAuB,SAAvB,EAAmC,aAAYmI,UAAU,CAACoC,EAAG,GAA7D,EAAiED,GAAjE;AACH;AACJ;AACJ;;AACDV,EAAAA,0BAA0B,CAAC/K,SAAD,EAAYuK,GAAZ,EAAiBP,YAAjB,EAA+B;AACrD,UAAM4B,WAAW,GAAG9N,UAAU,CAAC+N,gBAAX,CAA4BC,GAA5B,CAAgCrO,OAAO,CAAC2B,SAAR,CAAkB4G,QAAlD,CAApB;;AACA,QAAI,CAAC4F,WAAL,EAAkB;AACd,aAAOrE,OAAO,CAACC,OAAR,CAAgB,KAAhB,CAAP;AACH;;AACD,UAAMuE,MAAM,GAAGrN,qBAAqB,CAACsN,IAAtB,CAA2BhC,YAAY,CAACiC,QAAxC,CAAf;;AACA,QAAIF,MAAM,KAAK,IAAX,IAAmBA,MAAM,CAACG,MAAP,KAAkB,CAAzC,EAA4C;AACxC,WAAKjN,MAAL,CAAYsC,GAAZ,CAAgB,MAAhB,EAAyB,kBAAiBgJ,GAAI,qCAAtB,GAA8D,GAAEP,YAAY,CAACiC,QAAS,EAA9G;AACA,aAAO1E,OAAO,CAAC4E,MAAR,EAAP;AACH;;AACD,UAAMC,QAAQ,GAAGL,MAAM,CAAC,CAAD,CAAvB;AACA,UAAMM,MAAM,GAAGnJ,IAAI,CAAC6G,SAAL,CAAe;AAC1BnJ,MAAAA,IAAI,EAAG,YAAWZ,SAAU,0BAAyBuK,GAAI,EAD/B;AAE1BxN,MAAAA,IAAI,EAAEgP,MAAM,CAAC,CAAD,CAFc;AAG1BO,MAAAA,KAAK,EAAEtC,YAAY,CAAClF,SAHM;AAI1ByH,MAAAA,KAAK,EAAG,YAAWvM,SAAU,WAAUuK,GAAI;AAJjB,KAAf,CAAf;AAMAjN,IAAAA,QAAQ,CAAC2B,MAAT,CAAgBiG,KAAhB,CAAuB,8BAA6BkH,QAAS,GAA7D,EAAiElJ,IAAI,CAAC6G,SAAL,CAAesC,MAAf,CAAjE;AACA,QAAIG,eAAe,GAAG,kCAAtB;;AACA,QAAIJ,QAAQ,KAAK,EAAjB,EAAqB;AACjBI,MAAAA,eAAe,IAAK,OAAMJ,QAAS,EAAnC;AACH,KAFD,MAGK;AACD,WAAKnN,MAAL,CAAYsC,GAAZ,CAAgB,MAAhB,EAAyB,2EAA0E/D,WAAW,CAACmN,SAAZ,CAAsB8B,mCAAoC,GAA7J;AACH;;AACD,WAAOpP,GAAG,CACLqP,OADE,CACM,MADN,EACcF,eADd,EAC+B;AAClCG,MAAAA,MAAM,EAAG,UAAS7O,UAAU,CAAC+N,gBAAX,CAA4Be,iBAA5B,CAA8ChB,WAAW,CAAC1E,OAAZ,EAA9C,CAAqE,EADrD;AAElC7D,MAAAA,OAAO,EAAE;AACLwJ,QAAAA,aAAa,EAAE;AADV,OAFyB;AAKlCnJ,MAAAA,IAAI,EAAE2I,MAL4B;AAMlCnI,MAAAA,IAAI,EAAE;AAN4B,KAD/B,EASFF,IATE,CASG,MAAM;AACZ,aAAO,IAAP;AACH,KAXM,EAYFG,KAZE,CAYK2I,GAAD,IAAS;AAChB,WAAK7N,MAAL,CAAYsC,GAAZ,CAAgB,MAAhB,EAAwB,2BAA2BuL,GAAnD;AACA,YAAMA,GAAN;AACH,KAfM,CAAP;AAgBH;;AACDjC,EAAAA,mBAAmB,CAAC7K,SAAD,EAAYuK,GAAZ,EAAiBP,YAAjB,EAA+B;AAC9C,UAAM+C,YAAY,GAAGjP,UAAU,CAAC+N,gBAAX,CAA4BC,GAA5B,CAAgCrO,OAAO,CAAC2B,SAAR,CAAkB0G,SAAlD,CAArB;;AACA,QAAI,CAACiH,YAAL,EAAmB;AACf,aAAOxF,OAAO,CAACC,OAAR,CAAgB,KAAhB,CAAP;AACH;;AACD,UAAM6E,MAAM,GAAGnJ,IAAI,CAAC6G,SAAL,CAAe;AAAEC,MAAAA;AAAF,KAAf,CAAf;AACA1M,IAAAA,QAAQ,CAAC2B,MAAT,CAAgBiG,KAAhB,CAAuB,qBAAvB,EAA6ChC,IAAI,CAAC6G,SAAL,CAAesC,MAAf,CAA7C;AACA,WAAOhP,GAAG,CACLqP,OADE,CACM,KADN,EACc,yBAAwB1M,SAAU,aAAYuK,GAAI,EADhE,EACmE;AACtEoC,MAAAA,MAAM,EAAG,UAAS7O,UAAU,CAAC+N,gBAAX,CAA4Be,iBAA5B,CAA8CG,YAAY,CAAC7F,OAAb,EAA9C,CAAsE,EADlB;AAEtExD,MAAAA,IAAI,EAAE2I,MAFgE;AAGtEnI,MAAAA,IAAI,EAAE;AAHgE,KADnE,EAMFF,IANE,CAMG,MAAM;AACZ,aAAO,IAAP;AACH,KARM,EASFG,KATE,CASK2I,GAAD,IAAS;AAChB,WAAK7N,MAAL,CAAYsC,GAAZ,CAAgB,MAAhB,EAAwB,2BAA2BuL,GAAnD;AACA,YAAMA,GAAN;AACH,KAZM,CAAP;AAaH;;AACqB,QAAhB7B,gBAAgB,CAAC+B,WAAD,EAAczC,GAAd,EAAmBP,YAAnB,EAAiC3E,aAAjC,EAAgD6F,QAAhD,EAA0D;AAC5E,UAAM+B,UAAU,GAAGnP,UAAU,CAAC+N,gBAAX,CAA4BqB,OAA5B,CAAoCzP,OAAO,CAAC2B,SAAR,CAAkB8G,MAAtD,CAAnB;;AACA,QAAI,CAAC+G,UAAL,EAAiB;AACb,aAAO,KAAP;AACH;;AACD,UAAME,cAAc,GAAGrP,UAAU,CAAC+N,gBAAX,CAA4BC,GAA5B,CAAgCrO,OAAO,CAAC2B,SAAR,CAAkB8G,MAAlD,CAAvB;AACA5I,IAAAA,QAAQ,CAAC2B,MAAT,CAAgBiG,KAAhB,CAAuB,kBAAvB,EAA0ChC,IAAI,CAAC6G,SAAL,CAAe;AAAEC,MAAAA;AAAF,KAAf,CAA1C;AACA,UAAMiC,QAAQ,GAAGjC,YAAY,CAACiC,QAA9B;AACA,QAAIM,KAAJ;;AACA,QAAIrB,QAAJ,EAAc;AACVqB,MAAAA,KAAK,GAAG,uBAAuBS,WAA/B;AACH,KAFD,MAGK;AACD,YAAMI,aAAa,GAAGnB,QAAQ,CAACoB,KAAT,CAAe,GAAf,CAAtB;AACAd,MAAAA,KAAK,GAAGa,aAAa,CAACA,aAAa,CAAClB,MAAd,GAAuB,CAAxB,CAArB;AACH;;AACD,QAAI;AACA,YAAMiB,cAAc,CAACG,UAAf,CAA0Bf,KAA1B,EAAiChC,GAAjC,EAAsClF,aAAtC,CAAN;AACA,aAAO,IAAP;AACH,KAHD,CAIA,OAAO+C,CAAP,EAAU;AACN,aAAO,KAAP;AACH;AACJ;;AACDgD,EAAAA,cAAc,CAACpL,SAAD,EAAYuK,GAAZ,EAAiBP,YAAjB,EAA+B;AACzC1M,IAAAA,QAAQ,CAAC2B,MAAT,CAAgBiG,KAAhB,CAAuB,gBAAvB,EAAwChC,IAAI,CAAC6G,SAAL,CAAe;AAAEC,MAAAA;AAAF,KAAf,CAAxC;AACA,UAAMuD,cAAc,GAAI,GAAEvN,SAAU,IAAGgK,YAAY,CAAClF,SAAU,EAA9D;AACA,UAAM/F,QAAQ,GAAG,KAAKO,iBAAL,CAAuBiO,cAAvB,KAA0C,EAA3D;AACAxO,IAAAA,QAAQ,CAACmD,IAAT,CAAcqI,GAAd;AACA,SAAKjL,iBAAL,CAAuBiO,cAAvB,IAAyCxO,QAAzC;AACA,WAAO,IAAP;AACH;;AACDuM,EAAAA,iBAAiB,CAACtL,SAAD,EAAYuK,GAAZ,EAAiBP,YAAjB,EAA+B;AAC5C1M,IAAAA,QAAQ,CAAC2B,MAAT,CAAgBiG,KAAhB,CAAuB,mBAAvB,EAA2ChC,IAAI,CAAC6G,SAAL,CAAe;AAAEC,MAAAA;AAAF,KAAf,CAA3C;AACA,UAAMuD,cAAc,GAAI,GAAEvN,SAAU,IAAGgK,YAAY,CAAClF,SAAU,EAA9D;AACA,UAAM/F,QAAQ,GAAG,KAAKO,iBAAL,CAAuBiO,cAAvB,KAA0C,EAA3D;AACAxO,IAAAA,QAAQ,CAACmD,IAAT,CAAcqI,GAAd;AACA,SAAKjL,iBAAL,CAAuBiO,cAAvB,IAAyCxO,QAAzC;AACA,WAAO,IAAP;AACH;;AACDyO,EAAAA,YAAY,GAAG;AACX,WAAO,KAAK3O,IAAL,CAAUmB,SAAjB;AACH;;AACDkH,EAAAA,OAAO,GAAG;AACN,UAAMxG,IAAI,GAAG,KAAK7B,IAAL,CAAU6B,IAAV,IAAkBlD,WAAW,CAACmN,SAAZ,CAAsB8C,cAAtB,CAAqChQ,OAAO,CAAC2B,SAAR,CAAkBC,SAAvD,CAA/B;AACA,UAAMsB,IAAI,GAAG,KAAK9B,IAAL,CAAU8B,IAAV,IAAkBnD,WAAW,CAACmN,SAAZ,CAAsB+C,cAAtB,CAAqCjQ,OAAO,CAAC2B,SAAR,CAAkBC,SAAvD,CAA/B;AACA,WAAO;AACHuB,MAAAA,IAAI,EAAE,KAAK+M,OAAL,EADH;AAEHjN,MAAAA,IAFG;AAGHC,MAAAA;AAHG,KAAP;AAKH;;AACDgN,EAAAA,OAAO,GAAG;AACN,WAAOlQ,OAAO,CAAC2B,SAAR,CAAkBC,SAAzB;AACH;;AACDuO,EAAAA,qBAAqB,GAAG;AACpB,WAAOrR,MAAM,CAACiN,MAAP,CAAc,KAAKzK,QAAnB,EAA6B8O,GAA7B,CAAkCnE,MAAD,IAAYA,MAAM,CAACE,GAApD,CAAP;AACH;;AACDkE,EAAAA,yBAAyB,CAAClJ,UAAD,EAAa;AAClC,UAAM8E,MAAM,GAAG,KAAK3K,QAAL,CAAc6F,UAAd,CAAf;;AACA,QAAI,CAAC8E,MAAL,EAAa;AACTpM,MAAAA,QAAQ,CAAC2B,MAAT,CAAgBiG,KAAhB,CAAuB,sBAAqBN,UAAW,OAAM1B,IAAI,CAAC6G,SAAL,CAAe,KAAKhL,QAApB,CAA8B,EAA3F;AACA,YAAM,IAAIb,OAAO,CAAC6P,aAAZ,CAA2B,uBAAsBnJ,UAAW,EAA5D,CAAN;AACH;;AACD,WAAO8E,MAAM,CAACE,GAAd;AACH;;AACDY,EAAAA,aAAa,CAACZ,GAAD,EAAM;AACf,WAAOA,GAAG,CAACI,YAAJ,GAAoB,GAAEJ,GAAG,CAAC8B,EAAG,IAAG,KAAK1M,iBAAkB,EAAvD,GAA2D4K,GAAG,CAAC8B,EAAtE;AACH;;AACDH,EAAAA,gBAAgB,CAAC3B,GAAD,EAAMpD,IAAN,EAAY;AACxB,UAAM+D,GAAG,GAAG,KAAKC,aAAL,CAAmBZ,GAAnB,CAAZ;AACA,SAAK7K,QAAL,CAAcwL,GAAd,IAAqB;AAAEX,MAAAA,GAAF;AAAOK,MAAAA,OAAO,EAAE,IAAhB;AAAsBrC,MAAAA,OAAO,EAAEpB,IAAI,CAACoB,OAApC;AAA6C9D,MAAAA,GAAG,EAAE0C,IAAI,CAAC1C;AAAvD,KAArB;AACH;;AACDkK,EAAAA,qBAAqB,CAACjP,QAAD,EAAW;AAC5BA,IAAAA,QAAQ,CAACgG,OAAT,CAAkB6E,GAAD,IAAS,KAAK2B,gBAAL,CAAsB3B,GAAtB,EAA2B;AAAEhC,MAAAA,OAAO,EAAE;AAAX,KAA3B,CAA1B;AACH;;AACDpC,EAAAA,aAAa,GAAG;AACZ,WAAO;AACHyI,MAAAA,GAAG,EAAE,KAAKpP,IAAL,CAAUkI,YADZ;AAEH/G,MAAAA,SAAS,EAAE,KAAKnB,IAAL,CAAUmB,SAFlB;AAGH6C,MAAAA,SAAS,EAAE,EAHR;AAIHuC,MAAAA,UAAU,EAAE,EAJT;AAKHO,MAAAA,SAAS,EAAE;AACPC,QAAAA,SAAS,EAAE9H,UAAU,CAAC+N,gBAAX,CAA4B3E,OAA5B,CAAoCzJ,OAAO,CAAC2B,SAAR,CAAkB0G,SAAtD,CADJ;AAEPC,QAAAA,QAAQ,EAAEjI,UAAU,CAAC+N,gBAAX,CAA4B3E,OAA5B,CAAoCzJ,OAAO,CAAC2B,SAAR,CAAkB4G,QAAtD,CAFH;AAGPC,QAAAA,MAAM,EAAEnI,UAAU,CAAC+N,gBAAX,CAA4B3E,OAA5B,CAAoCzJ,OAAO,CAAC2B,SAAR,CAAkB8G,MAAtD,CAHD;AAIPC,QAAAA,IAAI,EAAErI,UAAU,CAAC+N,gBAAX,CAA4B3E,OAA5B,CAAoCzJ,OAAO,CAAC2B,SAAR,CAAkBgH,IAAtD,CAJC;AAKPC,QAAAA,OAAO,EAAEvI,UAAU,CAAC+N,gBAAX,CAA4B3E,OAA5B,CAAoCzJ,OAAO,CAAC2B,SAAR,CAAkBkH,OAAtD;AALF,OALR;AAYHvG,MAAAA,cAAc,EAAE;AACZmO,QAAAA,WAAW,EAAE,KAAKnO,cAAL,CAAoBmO,WADrB;AAEZC,QAAAA,aAAa,EAAE,KAAKpO,cAAL,CAAoBoO;AAFvB,OAZb;AAgBHC,MAAAA,iBAAiB,EAAE,KAAKvP,IAAL,CAAUgB;AAhB1B,KAAP;AAkBH;;AACDwO,EAAAA,8BAA8B,CAACC,GAAD,EAAM;AAChC,UAAMC,GAAG,GAAG1R,OAAO,CAACE,IAAI,CAACyR,IAAL,CAAUF,GAAG,CAACL,GAAd,EAAmB,cAAnB,CAAD,CAAnB;;AACA,WAAOK,GAAG,CAAC/H,gBAAJ,IAAyBgI,GAAG,CAACE,OAAJ,IAAeF,GAAG,CAACE,OAAJ,CAAYC,IAA3D;AACH;;AACD5H,EAAAA,qBAAqB,CAACmH,GAAD,EAAM1H,gBAAN,EAAwB;AACzC,UAAMgI,GAAG,GAAG1R,OAAO,CAACE,IAAI,CAACyR,IAAL,CAAUP,GAAV,EAAe,cAAf,CAAD,CAAnB;;AACA,QAAI,CAAC,CAACM,GAAG,CAACE,OAAL,IAAgB,CAACF,GAAG,CAACE,OAAJ,CAAYC,IAA9B,KAAuC,CAACnI,gBAA5C,EAA8D;AAC1D,WAAKtH,MAAL,CAAYsC,GAAZ,CAAgB,MAAhB,EAAwB,mEACpB,iGADJ;AAEA,aAAOP,OAAO,CAAC2N,QAAf;AACH;;AACD,UAAMC,gBAAgB,GAAG5N,OAAO,CAAC6N,QAAR,CAAiBH,IAAjB,CAAsBrB,KAAtB,CAA4B,GAA5B,EAAiC,CAAjC,CAAzB;AACA,UAAMyB,qBAAqB,GAAGvI,gBAAgB,GACvC,GAAEA,gBAAiB,EADoB,GAExCgI,GAAG,CAACE,OAAJ,CAAYC,IAFlB;AAGA,QAAIK,iBAAiB,GAAG,GAAxB;AACA,UAAMC,aAAa,GAAGjS,IAAI,CAACyR,IAAL,CAAUP,GAAV,EAAe,wBAAf,CAAtB;;AACA,QAAI;AACA,YAAMgB,eAAe,GAAGrR,eAAe,CAACsR,SAAhB,CAA0BF,aAA1B,EAAyC,CAAC,WAAD,CAAzC,EAAwDG,MAAxD,CAA+D/L,QAA/D,EAAxB;AACA2L,MAAAA,iBAAiB,GAAGE,eAAe,CAACG,KAAhB,CAAsB,CAAtB,EAAyB/B,KAAzB,CAA+B,GAA/B,EAAoC,CAApC,CAApB;AACH,KAHD,CAIA,OAAOP,GAAP,EAAY,CACX;;AACD,QAAIgC,qBAAqB,KAAKC,iBAA9B,EAAiD;AAC7C,WAAK9P,MAAL,CAAYkC,UAAZ,CAAuB,SAAvB,EAAkC,WAAlC,EAAgD,cAAa2N,qBAAsB,oBAAnF;AACA,aAAOE,aAAP;AACH;;AACD,QAAIF,qBAAqB,KAAKF,gBAA9B,EAAgD;AAC5C,WAAK3P,MAAL,CAAYkC,UAAZ,CAAuB,SAAvB,EAAkC,WAAlC,EAAgD,cAAa2N,qBAAsB,aAAnF;AACA,aAAO9N,OAAO,CAAC2N,QAAf;AACH;;AACD,SAAK1P,MAAL,CAAYsC,GAAZ,CAAgB,MAAhB,EAAyB,kCAAiCuN,qBAAsB,wCAAuCF,gBAAiB,GAAxI;AACA,WAAO5N,OAAO,CAAC2N,QAAf;AACH;;AACDU,EAAAA,WAAW,GAAG;AACV,UAAMC,WAAW,GAAG;AAChBC,MAAAA,eAAe,EAAE,KAAK1Q,IAAL,CAAUkI,YADX;AAEhB/G,MAAAA,SAAS,EAAE,KAAKnB,IAAL,CAAUmB,SAFL;AAGhBwP,MAAAA,UAAU,EAAE;AAHI,KAApB;;AAKA,QAAIjR,YAAY,CAACkR,WAAb,CAAyBH,WAAzB,CAAJ,EAA2C;AACvC,UAAI;AACA,eAAO/Q,YAAY,CAACmR,YAAb,CAA0BJ,WAA1B,CAAP;AACH,OAFD,CAGA,OAAOlH,CAAP,EAAU;AACN9K,QAAAA,QAAQ,CAAC2B,MAAT,CAAgBiG,KAAhB,CAAsB,4CAAtB,EAAoEkD,CAApE;AACH;AACJ;;AACD,WAAO,EAAP;AACH;;AACDI,EAAAA,aAAa,CAACmH,UAAD,EAAa;AACtB,UAAMC,IAAI,GAAG,EAAb;AACAA,IAAAA,IAAI,CAACC,cAAL,GAAsB,KAAKhR,IAAL,CAAUmB,SAAhC;AACA4P,IAAAA,IAAI,CAACE,UAAL,GAAkB,GAAlB;AACAF,IAAAA,IAAI,CAACG,IAAL,GAAY,IAAZ;;AACA,QAAIJ,UAAJ,EAAgB;AACZ,YAAMtF,OAAO,GAAGsF,UAAU,CAACvK,UAA3B;AACA,YAAM4K,MAAM,GAAG3F,OAAO,CAAC4F,OAAR,CAAgB,IAAhB,EAAsB,GAAtB,CAAf;AACAL,MAAAA,IAAI,CAACM,eAAL,GAAuBF,MAAvB;AACAJ,MAAAA,IAAI,CAACO,uBAAL,GAA+BR,UAAU,CAACtK,aAA1C;AACAuK,MAAAA,IAAI,CAACQ,SAAL,GAAiB/F,OAAjB;AACH;;AACD,WAAOuF,IAAP;AACH;;AACDnH,EAAAA,eAAe,GAAG;AACd,UAAMmH,IAAI,GAAG,EAAb;AACAA,IAAAA,IAAI,CAACS,kBAAL,GAA0B,MAA1B;AACAT,IAAAA,IAAI,CAACU,EAAL,GAAU,KAAV;AACA,UAAMC,iBAAiB,GAAG,KAAK1K,eAAL,CAAqBpI,OAAO,CAAC2B,SAAR,CAAkB0G,SAAvC,CAA1B;;AACA,QAAIyK,iBAAiB,IAAI,IAAzB,EAA+B;AAC3BX,MAAAA,IAAI,CAACpS,WAAW,CAACmN,SAAZ,CAAsB6F,uBAAvB,CAAJ,GAAsD3S,yBAAyB,CAAC4S,UAA1B,CAAqCF,iBAArC,CAAtD;AACH;;AACD,UAAMG,gBAAgB,GAAG,KAAK7K,eAAL,CAAqBpI,OAAO,CAAC2B,SAAR,CAAkB4G,QAAvC,CAAzB;;AACA,QAAI0K,gBAAJ,EAAsB;AAClBd,MAAAA,IAAI,CAACpS,WAAW,CAACmN,SAAZ,CAAsBgG,+BAAvB,CAAJ,GAA8D9S,yBAAyB,CAAC4S,UAA1B,CAAqCC,gBAArC,CAA9D;AACH;;AACD,UAAME,YAAY,GAAG,KAAK/K,eAAL,CAAqBpI,OAAO,CAAC2B,SAAR,CAAkBgH,IAAvC,CAArB;;AACA,QAAIwK,YAAJ,EAAkB;AACdhB,MAAAA,IAAI,CAACpS,WAAW,CAACmN,SAAZ,CAAsBkG,2BAAvB,CAAJ,GAA0DhT,yBAAyB,CAAC4S,UAA1B,CAAqCG,YAArC,CAA1D;AACH;;AACD,UAAME,eAAe,GAAG,KAAKjL,eAAL,CAAqBpI,OAAO,CAAC2B,SAAR,CAAkBkH,OAAvC,CAAxB;;AACA,QAAIwK,eAAJ,EAAqB;AACjBlB,MAAAA,IAAI,CAACpS,WAAW,CAACmN,SAAZ,CAAsBoG,8BAAvB,CAAJ,GAA6DlT,yBAAyB,CAAC4S,UAA1B,CAAqCK,eAArC,CAA7D;AACAlB,MAAAA,IAAI,CAACpS,WAAW,CAACmN,SAAZ,CAAsBqG,2BAAvB,CAAJ,GAA2D,UAASnT,yBAAyB,CAAC4S,UAA1B,CAAqCK,eAArC,CAAsD,EAA1H;AACH;;AACD,UAAM3D,cAAc,GAAG,KAAKtH,eAAL,CAAqBpI,OAAO,CAAC2B,SAAR,CAAkB8G,MAAvC,CAAvB;;AACA,QAAIiH,cAAJ,EAAoB;AAChB,YAAM8D,UAAU,GAAGpT,yBAAyB,CAAC4S,UAA1B,CAAqCtD,cAArC,CAAnB;AACAnM,MAAAA,OAAO,CAACC,GAAR,CAAYiQ,oBAAZ,GAAmCD,UAAnC;AACH;;AACD,WAAOrB,IAAP;AACH;;AACDjH,EAAAA,iBAAiB,GAAG;AAChB,UAAM+H,gBAAgB,GAAG,KAAK7K,eAAL,CAAqBpI,OAAO,CAAC2B,SAAR,CAAkB4G,QAAvC,CAAzB;AACA,QAAImL,mBAAmB,GAAGhH,SAA1B;;AACA,QAAIuG,gBAAJ,EAAsB;AAClB,UAAIU,EAAE,GAAG,KAAKvS,IAAL,CAAUmB,SAAnB;;AACA,UAAI,KAAKD,cAAL,CAAoBmO,WAAxB,EAAqC;AACjC,cAAMmD,KAAK,GAAG,IAAIjU,KAAK,CAACkU,GAAV,CAAc,KAAKvR,cAAL,CAAoBmO,WAAlC,CAAd;AACAkD,QAAAA,EAAE,GAAGC,KAAK,CAACE,QAAN,CAAelE,KAAf,CAAqB,GAArB,EAA0B,CAA1B,CAAL;AACH;;AACD8D,MAAAA,mBAAmB,GAAI,UAAStT,yBAAyB,CAAC4S,UAA1B,CAAqCC,gBAArC,CAAuD,QAAOU,EAAG,EAAjG;AACH;;AACD,WAAOlO,IAAI,CAAC6G,SAAL,CAAe;AAClBoE,MAAAA,aAAa,EAAE,KAAKpO,cAAL,CAAoBoO,aADjB;AAElBD,MAAAA,WAAW,EAAEiD,mBAAmB,IAAI,KAAKpR,cAAL,CAAoBmO,WAFtC;AAGlBlO,MAAAA,SAAS,EAAE,KAAKnB,IAAL,CAAUmB;AAHH,KAAf,CAAP;AAKH;;AACD6G,EAAAA,cAAc,CAAC8I,UAAD,EAAa;AACvB,WAAOpT,MAAM,CAACmJ,MAAP,CAAcnJ,MAAM,CAACmJ,MAAP,CAAcnJ,MAAM,CAACmJ,MAAP,CAAcnJ,MAAM,CAACmJ,MAAP,CAAcnJ,MAAM,CAACmJ,MAAP,CAAc,EAAd,EAAkB,KAAK2J,WAAL,EAAlB,CAAd,EAAqD,KAAK7G,aAAL,CAAmBmH,UAAnB,CAArD,CAAd,EAAoG,KAAKlH,eAAL,EAApG,CAAd,EAA2I;AAAEC,MAAAA,eAAe,EAAE,KAAKC,iBAAL;AAAnB,KAA3I,CAAd,EAAyM,KAAK9J,IAAL,CAAUoC,GAAnN,CAAP;AACH;;AACD2F,EAAAA,aAAa,CAAC0H,GAAD,EAAM9H,IAAN,EAAYgL,UAAZ,EAAwB;AACjC,QAAI,KAAKnR,UAAL,CAAgBoR,YAAhB,CAA6BnD,GAAG,CAACzL,SAAjC,CAAJ,EAAiD;AAC7C,aAAO,KAAKxC,UAAL,CAAgBqR,UAAhB,CAA2BpD,GAAG,CAACzL,SAA/B,EAA0CyL,GAA1C,EAA+C9H,IAA/C,CAAP;AACH;;AACD,UAAMmL,OAAO,GAAG,IAAI5T,QAAQ,CAAC6T,YAAb,EAAhB;AACA,UAAM/S,IAAI,GAAG,CAAC9B,IAAI,CAACyR,IAAL,CAAUqD,SAAV,EAAqB,0BAArB,CAAD,CAAb;;AACA,QAAIrL,IAAI,CAACsL,eAAT,EAA0B;AACtBjT,MAAAA,IAAI,CAACkT,OAAL,CAAa,eAAb;AACH;;AACD,QAAI,KAAKlT,IAAL,CAAUe,SAAd,EAAyB;AACrB,UAAIoB,OAAO,CAACC,GAAR,CAAY+Q,eAAZ,IAA+BhR,OAAO,CAAC2N,QAAR,IAAoBnI,IAAI,CAAC1H,UAA5D,EAAwE;AACpE,cAAMmT,yBAAyB,GAAG,KAAK5D,8BAAL,CAAoCC,GAApC,CAAlC;AACA,aAAKrP,MAAL,CAAYsC,GAAZ,CAAgB,MAAhB,EAAyB,8CAA6CP,OAAO,CAAC2N,QAAS,kBAAiBsD,yBAA0B,0CAAlI;AACH,OAHD,MAIK;AACD,cAAM;AAAEvR,UAAAA;AAAF,YAAW,KAAKwG,OAAL,EAAjB;AACArI,QAAAA,IAAI,CAACkT,OAAL,CAAc,aAAYrR,IAAK,IAAG,KAAK7B,IAAL,CAAUe,SAAU,EAAtD;AACH;AACJ;;AACD,UAAMsS,OAAO,GAAGnV,IAAI,CAACyR,IAAL,CAAUF,GAAG,CAACL,GAAd,EAAmB,SAAnB,CAAhB;;AACA,QAAInR,EAAE,CAACqV,UAAH,CAAcD,OAAd,CAAJ,EAA4B;AACxBlU,MAAAA,gBAAgB,CAACkB,cAAjB,CAAgCC,WAAhC,CAA4C1B,OAAO,CAAC2B,SAAR,CAAkBC,SAA9D,EAAyE8B,UAAzE,CAAoF,WAApF,EAAiG,WAAjG,EAA8G,+BAC1G,wHAD0G,GAE1G,sFAFJ;AAGH;;AACD,UAAMiR,YAAY,GAAGzU,KAAK,CAAC6I,IAAI,CAAC1H,UAAN,EAAkBD,IAAlB,EAAwB;AAC9CoC,MAAAA,GAAG,EAAE1E,MAAM,CAACmJ,MAAP,CAAcnJ,MAAM,CAACmJ,MAAP,CAAc;AAAEgJ,QAAAA,IAAI,EAAElI,IAAI,CAAC1H;AAAb,OAAd,EAAyCkC,OAAO,CAACC,GAAjD,CAAd,EAAsEuQ,UAAU,KAAK,IAAf,IAAuBA,UAAU,KAAK,KAAK,CAA3C,GAA+CA,UAA/C,GAA4D,EAAlI,CADyC;AAE9CvD,MAAAA,GAAG,EAAEK,GAAG,CAACL,GAFqC;AAG9CoE,MAAAA,KAAK,EAAE,CAAC,MAAD,EAAS,MAAT,EAAiB,MAAjB,EAAyB,KAAzB;AAHuC,KAAxB,CAA1B;AAKA,UAAMC,OAAO,GAAG;AACZC,MAAAA,MAAM,EAAE;AAAEC,QAAAA,IAAI,EAAEJ,YAAY,CAACG,MAArB;AAA6B7V,QAAAA,KAAK,EAAE;AAApC,OADI;AAEZyS,MAAAA,MAAM,EAAE;AAAEqD,QAAAA,IAAI,EAAEJ,YAAY,CAACjD,MAArB;AAA6BzS,QAAAA,KAAK,EAAE;AAApC;AAFI,KAAhB;AAIA,UAAM+V,SAAS,GAAG;AAAE/V,MAAAA,KAAK,EAAE;AAAT,KAAlB;AACA0V,IAAAA,YAAY,CAACpQ,EAAb,CAAgB,SAAhB,EAA4B0Q,OAAD,IAAa;AACpC,WAAKC,MAAL,CAAYP,YAAZ,EAA0BT,OAA1B,EAAmCc,SAAnC,EAA8CC,OAA9C;AACH,KAFD;;AAGA,SAAK,MAAMhH,EAAX,IAAiB4G,OAAjB,EAA0B;AACtB,UAAIA,OAAO,CAACM,cAAR,CAAuBlH,EAAvB,CAAJ,EAAgC;AAC5B,cAAMmH,MAAM,GAAGP,OAAO,CAAC5G,EAAD,CAAtB;AACAmH,QAAAA,MAAM,CAACL,IAAP,CAAYxQ,EAAZ,CAAe,MAAf,EAAwB8Q,GAAD,IAAS;AAC5B,eAAKH,MAAL,CAAYP,YAAZ,EAA0BT,OAA1B,EAAmCkB,MAAnC,EAA2CC,GAA3C;AACH,SAFD;AAGH;AACJ;;AACD,UAAM/J,OAAO,GAAG;AACZgK,MAAAA,GAAG,EAAEX,YAAY,CAACW,GADN;AAEZ1K,MAAAA,IAAI,EAAE,IAAId,OAAJ,CAAaC,OAAD,IAAa;AAC3B4K,QAAAA,YAAY,CAACpQ,EAAb,CAAgB,MAAhB,EAAwBwF,OAAxB;AACH,OAFK,CAFM;AAKZwB,MAAAA,MAAM,EAAE2I,OALI;AAMZqB,MAAAA,QAAQ,EAAE,MAAM;AACZZ,QAAAA,YAAY,CAACa,IAAb;AACH,OARW;AASZA,MAAAA,IAAI,EAAGC,MAAD,IAAY;AACdd,QAAAA,YAAY,CAACa,IAAb,CAAkBC,MAAlB;AACAvB,QAAAA,OAAO,CAACwB,IAAR,CAAa,KAAb,EAAoB,IAAI1V,OAAO,CAACoL,WAAZ,CAAwB,QAAxB,EAAkC,gBAAlC,EAAoD,QAApD,CAApB;AACH,OAZW;AAaZtE,MAAAA,IAAI,EAAG1F,IAAD,IAAU;AACZ,eAAOuT,YAAY,CAAC7N,IAAb,CAAkBrB,IAAI,CAAC6G,SAAL,CAAelL,IAAf,CAAlB,CAAP;AACH;AAfW,KAAhB;AAiBA,SAAKwB,UAAL,CAAgB+S,SAAhB,CAA0B9E,GAAG,CAACzL,SAA9B,EAAyCkG,OAAzC;AACA,WAAO,KAAK1I,UAAL,CAAgBqR,UAAhB,CAA2BpD,GAAG,CAACzL,SAA/B,EAA0CyL,GAA1C,EAA+C9H,IAA/C,CAAP;AACH;;AAC8B,QAAzB6M,yBAAyB,GAAG;AAC9B9W,IAAAA,MAAM,CAACiN,MAAP,CAAc,KAAKzK,QAAnB,EAA6BgG,OAA7B,CAAsC2E,MAAD,IAAY;AAC7C,UAAIA,MAAM,CAACE,GAAP,CAAWI,YAAX,IAA2BN,MAAM,CAACO,OAAtC,EAA+C;AAC3C,aAAKhL,MAAL,CAAYkC,UAAZ,CAAuB,QAAvB,EAAkC,aAAYuI,MAAM,CAACE,GAAP,CAAWC,UAAW,GAApE,EAAwE,gCAAxE;AACAH,QAAAA,MAAM,CAACO,OAAP,GAAiB,KAAjB;AACH;AACJ,KALD;AAMA,UAAM,KAAK1J,SAAL,CAAe4H,KAAf,EAAN;AACH;;AACmB,QAAdmL,cAAc,GAAG;AACnB,SAAKtU,iBAAL;AACA,WAAO,KAAKgJ,YAAL,EAAP;AACH;;AAC4B,QAAvBjE,uBAAuB,CAAC/D,SAAD,EAAY4E,UAAZ,EAAwB3B,KAAxB,EAA+B;AACxD,UAAMyG,MAAM,GAAG,KAAK3K,QAAL,CAAc6F,UAAd,CAAf;;AACA,QAAI8E,MAAM,IAAI,CAACA,MAAM,CAACO,OAAtB,EAA+B;AAC3B,aAAO1C,OAAO,CAAC4E,MAAR,CAAe;AAAE7H,QAAAA,IAAI,EAAE,GAAR;AAAaX,QAAAA,IAAI,EAAE;AAAnB,OAAf,CAAP;AACH;;AACD,UAAM4P,OAAO,GAAG,KAAKzF,yBAAL,CAA+BlJ,UAA/B,CAAhB;AACA,UAAMyF,OAAO,GAAGxM,yBAAyB,CAACyM,kBAA1B,CAA6CiJ,OAA7C,CAAhB;AACA,UAAM5M,MAAM,GAAG,KAAKxB,oBAAL,CAA0BoO,OAAO,CAAC7H,EAAlC,EAAsC6H,OAAO,CAAC3S,IAA9C,EAAoD/C,yBAAyB,CAAC6M,gBAA1B,CAA2C6I,OAA3C,CAApD,EAAyGtQ,KAAzG,CAAf;AACA,WAAO,IAAIsE,OAAJ,CAAY,CAACC,OAAD,EAAU2E,MAAV,KAAqB;AACpC,UAAInM,SAAS,KAAK,KAAKnB,IAAL,CAAUmB,SAA5B,EAAuC;AACnC,YAAIqK,OAAO,KAAK7M,WAAW,CAACmN,SAAZ,CAAsBG,yBAAtC,EAAiE;AAC7DxN,UAAAA,QAAQ,CAAC2B,MAAT,CAAgBiG,KAAhB,CAAuB,2CAA0CmF,OAAQ,0BAAyBrK,SAAU,IAA5G;AACAmM,UAAAA,MAAM,CAAC;AAAE7H,YAAAA,IAAI,EAAE;AAAR,WAAD,CAAN;AACA;AACH;;AACD,YAAI,CAACiP,OAAO,CAACvJ,YAAR,CAAqBiC,QAArB,CAA8BuH,UAA9B,CAA0C,wBAAuBxT,SAAU,EAA3E,CAAL,EAAoF;AAChF1C,UAAAA,QAAQ,CAAC2B,MAAT,CAAgBiG,KAAhB,CAAuB,4CAA2CqO,OAAO,CAAC3S,IAAK,iBAAgBZ,SAAU,oCAAmCkD,IAAI,CAAC6G,SAAL,CAAewJ,OAAf,CAAwB,GAApK;AACApH,UAAAA,MAAM,CAAC;AAAE7H,YAAAA,IAAI,EAAE;AAAR,WAAD,CAAN;AACA;AACH;AACJ;;AACDqC,MAAAA,MAAM,CAAC8M,MAAP,CAAeC,EAAD,IAAQ;AAClB,YAAIA,EAAE,CAACC,KAAH,KAAa,OAAjB,EAA0B;AACtBxH,UAAAA,MAAM,CAAC;AAAE7H,YAAAA,IAAI,EAAE,GAAR;AAAaX,YAAAA,IAAI,EAAE+P,EAAE,CAACE;AAAtB,WAAD,CAAN;AACH;AACJ,OAJD;AAKArW,MAAAA,KAAK,CAACkB,YAAD,EAAeZ,yBAAyB,CAACyM,kBAA1B,CAA6CiJ,OAA7C,CAAf,CAAL;AACA5M,MAAAA,MAAM,CAACkN,WAAP,GAAqB7P,IAArB,CAA0B,MAAM;AAC5BwD,QAAAA,OAAO,CAAC;AAAEnD,UAAAA,MAAM,EAAE;AAAV,SAAD,CAAP;AACH,OAFD;AAGH,KAtBM,CAAP;AAuBH;;AACDwB,EAAAA,eAAe,CAACiO,QAAD,EAAW;AACtB,QAAI,KAAKjV,IAAL,CAAUkV,eAAd,EAA+B;AAC3B,UAAI,KAAKlV,IAAL,CAAUkV,eAAV,CAA0BD,QAA1B,CAAJ,EAAyC;AACrC,eAAO,KAAKjV,IAAL,CAAUkV,eAAV,CAA0BD,QAA1B,CAAP;AACH;AACJ;;AACD,WAAOhW,UAAU,CAAC+N,gBAAX,CAA4B3E,OAA5B,CAAoC4M,QAApC,CAAP;AACH;;AACDE,EAAAA,mBAAmB,CAACC,UAAD,EAAa;AAC5B,UAAMC,KAAK,GAAGD,UAAU,CAACC,KAAX,CAAiB,eAAjB,CAAd;;AACA,QAAI,CAACA,KAAL,EAAY;AACR;AACH;;AACD,QAAIC,OAAO,GAAGD,KAAK,CAAC,CAAD,CAAnB;AACA5W,IAAAA,QAAQ,CAAC2B,MAAT,CAAgBiG,KAAhB,CAAuB,aAAYiP,OAAQ,EAA3C;;AACA,QAAIA,OAAO,IAAIA,OAAO,CAAC7Q,QAAR,CAAiB,GAAjB,CAAf,EAAsC;AAClC6Q,MAAAA,OAAO,GAAGA,OAAO,CAAClE,OAAR,CAAgB,UAAhB,EAA4B,GAA5B,CAAV;AACA3S,MAAAA,QAAQ,CAAC2B,MAAT,CAAgBiG,KAAhB,CAAuB,kDAAiDiP,OAAQ,EAAhF;AACH;;AACD,QAAI;AACA,YAAMC,OAAO,GAAGjX,GAAG,CAACkX,MAAJ,CAAWF,OAAX,EAAoB;AAAEG,QAAAA,QAAQ,EAAE;AAAZ,OAApB,CAAhB;;AACA,UAAI,CAACF,OAAD,IAAY,OAAOA,OAAP,KAAmB,QAAnC,EAA6C;AACzC9W,QAAAA,QAAQ,CAAC2B,MAAT,CAAgBiG,KAAhB,CAAuB,8BAA6BkP,OAAQ,EAA5D;AACA;AACH;;AACD,YAAMG,MAAM,GAAGH,OAAO,CAACI,OAAvB;AACAD,MAAAA,MAAM,CAACE,GAAP,GAAaF,MAAM,CAACG,GAApB;AACA,aAAOH,MAAP;AACH,KATD,CAUA,OAAOnM,CAAP,EAAU;AACN;AACH;AACJ;;AACuB,QAAlB1D,kBAAkB,CAAC9C,GAAD,EAAMC,GAAN,EAAW;AAC/B,UAAMgC,MAAM,GAAGjC,GAAG,CAACiC,MAAnB;AACA,UAAMhD,MAAM,GAAGe,GAAG,CAACgB,MAAJ,CAAW/B,MAA1B;AACA,UAAMmM,WAAW,GAAGpL,GAAG,CAACgB,MAAJ,CAAWE,YAA/B;AACA,UAAMD,SAAS,GAAI,GAAEhC,MAAO,IAAGmM,WAAY,EAA3C;;AACA,QAAI,CAAC,KAAKjO,QAAL,CAAc8D,SAAd,CAAL,EAA+B;AAC3BhB,MAAAA,GAAG,CACEwC,MADL,CACY,GADZ,EAEKE,IAFL,CAEW,YAAW1B,SAAU,wCAAuCtG,MAAM,CAACoY,IAAP,CAAY,KAAK5V,QAAjB,EAA2ByP,IAA3B,CAAgC,IAAhC,CAAsC,EAF7G;AAGA;AACH;;AACD,UAAM+E,OAAO,GAAG,KAAKzF,yBAAL,CAA+BjL,SAA/B,CAAhB;AACAvF,IAAAA,QAAQ,CAAC2B,MAAT,CAAgBiG,KAAhB,CAAuB,oBAAmBrB,MAAO,IAAGjC,GAAG,CAACkC,GAAI,QAAOjB,SAAU,EAA7E;AACA,UAAMG,OAAO,GAAGpB,GAAG,CAACO,OAApB;AACA,UAAMyS,UAAU,GAAGrB,OAAO,CAACsB,MAAR,IAAkBtB,OAAO,CAACsB,MAAR,CAAe,qBAAf,MAA0C,MAA/E;AACA,UAAMZ,UAAU,GAAGrS,GAAG,CAACkT,MAAJ,CAAW,eAAX,CAAnB;;AACA,QAAIb,UAAU,IAAIW,UAAlB,EAA8B;AAC1B,YAAMG,KAAK,GAAG,KAAKf,mBAAL,CAAyBC,UAAzB,CAAd;;AACA,UAAIc,KAAJ,EAAW;AACP,cAAMC,WAAW,GAAG;AAChBP,UAAAA,GAAG,EAAEM,KAAK,CAACN,GADK;AAEhBM,UAAAA,KAAK,EAAEA;AAFS,SAApB;AAIAnT,QAAAA,GAAG,CAACyB,OAAJ,CAAYxF,yBAAyB,CAACoX,aAA1B,CAAwCC,oBAApD,IAA4EtT,GAAG,CAACyB,OAAJ,CAAY,eAAZ,CAA5E;AACA,eAAOzB,GAAG,CAACyB,OAAJ,CAAY,eAAZ,CAAP;AACAzB,QAAAA,GAAG,CAACyB,OAAJ,CAAYxF,yBAAyB,CAACoX,aAA1B,CAAwCE,oBAApD,IAA4EC,kBAAkB,CAAClS,IAAI,CAAC6G,SAAL,CAAeiL,WAAf,CAAD,CAA9F;AACH;AACJ;;AACD,UAAMrO,MAAM,GAAG,KAAKxB,oBAAL,CAA0BoO,OAAO,CAAC7H,EAAlC,EAAsC6H,OAAO,CAAC3S,IAA9C,EAAoD,MAApD,EAA4DuJ,SAA5D,CAAf;AACAxD,IAAAA,MAAM,CAAC8M,MAAP,CAAeC,EAAD,IAAQ;AAClB,UAAIA,EAAE,CAACC,KAAH,KAAa,OAAjB,EAA0B;AACtB9R,QAAAA,GAAG,CAACwC,MAAJ,CAAW,GAAX,EAAgBE,IAAhB,CAAqBmP,EAAE,CAACE,IAAxB;AACH;AACJ,KAJD;AAKA,UAAMjN,MAAM,CAAC0O,kBAAP,EAAN;AACA9X,IAAAA,KAAK,CAACkB,YAAD,EAAe,OAAf,CAAL;AACA,SAAKQ,MAAL,CAAYsC,GAAZ,CAAgB,OAAhB,EAA0B,6CAA1B;;AACA,QAAI,CAACoF,MAAM,CAAC2O,QAAZ,EAAsB;AAClB,YAAM,IAAIpX,OAAO,CAAC6P,aAAZ,CAA0B,8CAA1B,CAAN;AACH;;AACD,QAAI,CAACpH,MAAM,CAAC2O,QAAP,CAAgBhH,GAAhB,CAAoBiH,UAAzB,EAAqC;AACjC,YAAM,IAAIrX,OAAO,CAAC6P,aAAZ,CAA2B,oDAAmD7K,IAAI,CAAC6G,SAAL,CAAepD,MAAM,CAAC2O,QAAtB,CAAgC,EAA9G,CAAN;AACH;;AACD,UAAMxR,GAAG,GAAG,IAAI1G,KAAK,CAACkU,GAAV,CAAe,GAAE1P,GAAG,CAAC4T,QAAS,MAAK5T,GAAG,CAAC2P,QAAS,GAAE3P,GAAG,CAACkC,GAAI,EAA1D,CAAZ;AACA,UAAM/G,IAAI,GAAI,GAAE+G,GAAG,CAAC2R,QAAS,GAAE3R,GAAG,CAAC4R,MAAO,EAA7B,CAA+BzF,OAA/B,CAAuC,IAAItR,MAAJ,CAAY,KAAI,KAAKE,IAAL,CAAUmB,SAAU,aAAYgN,WAAY,KAA5D,CAAvC,EAA0G,GAA1G,CAAb;AACA,SAAK/N,MAAL,CAAYsC,GAAZ,CAAgB,OAAhB,EAA0B,2BAA0BK,GAAG,CAACkC,GAAI,qBAAoB/G,IAAK,EAArF;AACA,UAAM4Y,UAAU,GAAGzY,IAAI,CAACwP,OAAL,CAAa;AAC5B7I,MAAAA,MAD4B;AAE5B9G,MAAAA,IAF4B;AAG5BsG,MAAAA,OAAO,EAAEzB,GAAG,CAACyB,OAHe;AAI5BkS,MAAAA,UAAU,EAAE5O,MAAM,CAAC2O,QAAP,CAAgBhH,GAAhB,CAAoBiH;AAJJ,KAAb,EAKfK,UAAD,IAAgB;AACf,eAASC,uBAAT,GAAmC;AAC/BhU,QAAAA,GAAG,CAACwC,MAAJ,CAAWuR,UAAU,CAACE,UAAX,IAAyB,GAApC;;AACA,YAAI,CAACjU,GAAG,CAACkU,WAAT,EAAsB;AAClBxZ,UAAAA,MAAM,CAACoY,IAAP,CAAYiB,UAAU,CAACvS,OAAvB,EAAgC0B,OAAhC,CAAyCwF,GAAD,IAAS;AAC7C,kBAAMyL,GAAG,GAAGJ,UAAU,CAACvS,OAAX,CAAmBkH,GAAnB,CAAZ;;AACA,gBAAIyL,GAAJ,EAAS;AACLnU,cAAAA,GAAG,CAACoU,SAAJ,CAAc1L,GAAd,EAAmByL,GAAnB;AACH;AACJ,WALD;AAMH;AACJ;;AACDJ,MAAAA,UAAU,CAAC5T,EAAX,CAAc,MAAd,EAAuB8Q,GAAD,IAAS;AAC3B+C,QAAAA,uBAAuB;AACvBhU,QAAAA,GAAG,CAACqU,KAAJ,CAAUpD,GAAV;AACH,OAHD;AAIA8C,MAAAA,UAAU,CAAC5T,EAAX,CAAc,OAAd,EAAuB,MAAM;AACzB6T,QAAAA,uBAAuB;AACvBhU,QAAAA,GAAG,CAACsU,GAAJ;AACH,OAHD;AAIAP,MAAAA,UAAU,CAAC5T,EAAX,CAAc,KAAd,EAAqB,MAAM;AACvB6T,QAAAA,uBAAuB;AACvBhU,QAAAA,GAAG,CAACsU,GAAJ;AACH,OAHD;AAIH,KA7BkB,CAAnB;AA8BAR,IAAAA,UAAU,CAAC3T,EAAX,CAAc,OAAd,EAAuB,MAAM;AACzBH,MAAAA,GAAG,CAACsU,GAAJ;AACH,KAFD;;AAGA,QAAInT,OAAJ,EAAa;AACT2S,MAAAA,UAAU,CAACO,KAAX,CAAiBlT,OAAjB;AACA2S,MAAAA,UAAU,CAACQ,GAAX;AACH;;AACDvU,IAAAA,GAAG,CAAC4Q,IAAJ,CAASmD,UAAT,EAAqB;AAAEQ,MAAAA,GAAG,EAAE;AAAP,KAArB,EAAoCnU,EAApC,CAAuC,OAAvC,EAAgD,MAAM;AAClDH,MAAAA,GAAG,CAACsU,GAAJ;AACH,KAFD;AAGA,UAAMxP,MAAM,CAACkN,WAAP,EAAN;AACH;;AACDlB,EAAAA,MAAM,CAAC5J,OAAD,EAAU4I,OAAV,EAAmBkB,MAAnB,EAA2BC,GAA3B,EAAgC;AAClCD,IAAAA,MAAM,CAACnW,KAAP,IAAgBoW,GAAG,CAAC1P,QAAJ,EAAhB;AACA,UAAMgT,KAAK,GAAGvD,MAAM,CAACnW,KAAP,CAAa2Q,KAAb,CAAmB,IAAnB,CAAd;;AACA,QAAI+I,KAAK,CAAClK,MAAN,GAAe,CAAnB,EAAsB;AAClBkK,MAAAA,KAAK,CAAChH,KAAN,CAAY,CAAZ,EAAe,CAAC,CAAhB,EAAmBrK,OAAnB,CAA4BsR,IAAD,IAAU;AACjC,cAAM9U,GAAG,GAAG9D,OAAO,CAACoL,WAAR,CAAoByN,QAApB,CAA6BD,IAA7B,CAAZ;AACA1E,QAAAA,OAAO,CAACwB,IAAR,CAAa,KAAb,EAAoB5R,GAApB;;AACA,YAAIA,GAAG,CAACoS,KAAJ,KAAc,OAAlB,EAA2B;AACvBhC,UAAAA,OAAO,CAACwB,IAAR,CAAa,KAAb,EAAoB,IAAI1V,OAAO,CAACoL,WAAZ,CAAwB,QAAxB,EAAkC,gBAAlC,EAAoD,QAApD,CAApB;AACAE,UAAAA,OAAO,CAACkK,IAAR;AACH;AACJ,OAPD;AAQH;;AACDJ,IAAAA,MAAM,CAACnW,KAAP,GAAe0Z,KAAK,CAACA,KAAK,CAAClK,MAAN,GAAe,CAAhB,CAApB;AACH;;AAjxBmB;;AAmxBxBzP,OAAO,CAACE,iBAAR,GAA4BA,iBAA5B","sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.FunctionsEmulator = void 0;\nconst _ = require(\"lodash\");\nconst fs = require(\"fs\");\nconst path = require(\"path\");\nconst express = require(\"express\");\nconst clc = require(\"cli-color\");\nconst http = require(\"http\");\nconst jwt = require(\"jsonwebtoken\");\nconst url_1 = require(\"url\");\nconst api = require(\"../api\");\nconst logger_1 = require(\"../logger\");\nconst track = require(\"../track\");\nconst constants_1 = require(\"./constants\");\nconst types_1 = require(\"./types\");\nconst chokidar = require(\"chokidar\");\nconst spawn = require(\"cross-spawn\");\nconst child_process_1 = require(\"child_process\");\nconst functionsEmulatorShared_1 = require(\"./functionsEmulatorShared\");\nconst registry_1 = require(\"./registry\");\nconst events_1 = require(\"events\");\nconst emulatorLogger_1 = require(\"./emulatorLogger\");\nconst functionsRuntimeWorker_1 = require(\"./functionsRuntimeWorker\");\nconst error_1 = require(\"../error\");\nconst workQueue_1 = require(\"./workQueue\");\nconst utils_1 = require(\"../utils\");\nconst defaultCredentials_1 = require(\"../defaultCredentials\");\nconst adminSdkConfig_1 = require(\"./adminSdkConfig\");\nconst functionsEnv = require(\"../functions/env\");\nconst types_2 = require(\"./events/types\");\nconst EVENT_INVOKE = \"functions:invoke\";\nconst DATABASE_PATH_PATTERN = new RegExp(\"^projects/[^/]+/instances/([^/]+)/refs(/.*)$\");\nclass FunctionsEmulator {\n    constructor(args) {\n        this.args = args;\n        this.nodeBinary = \"\";\n        this.triggers = {};\n        this.triggerGeneration = 0;\n        this.logger = emulatorLogger_1.EmulatorLogger.forEmulator(types_1.Emulators.FUNCTIONS);\n        this.multicastTriggers = {};\n        emulatorLogger_1.EmulatorLogger.verbosity = this.args.quiet ? emulatorLogger_1.Verbosity.QUIET : emulatorLogger_1.Verbosity.DEBUG;\n        if (this.args.debugPort) {\n            this.args.disabledRuntimeFeatures = this.args.disabledRuntimeFeatures || {};\n            this.args.disabledRuntimeFeatures.timeout = true;\n        }\n        this.adminSdkConfig = {\n            projectId: this.args.projectId,\n        };\n        const mode = this.args.debugPort\n            ? types_1.FunctionsExecutionMode.SEQUENTIAL\n            : types_1.FunctionsExecutionMode.AUTO;\n        this.workerPool = new functionsRuntimeWorker_1.RuntimeWorkerPool(mode);\n        this.workQueue = new workQueue_1.WorkQueue(mode);\n    }\n    static getHttpFunctionUrl(host, port, projectId, name, region) {\n        return `http://${host}:${port}/${projectId}/${region}/${name}`;\n    }\n    async getCredentialsEnvironment() {\n        const credentialEnv = {};\n        if (process.env.GOOGLE_APPLICATION_CREDENTIALS) {\n            this.logger.logLabeled(\"WARN\", \"functions\", `Your GOOGLE_APPLICATION_CREDENTIALS environment variable points to ${process.env.GOOGLE_APPLICATION_CREDENTIALS}. Non-emulated services will access production using these credentials. Be careful!`);\n        }\n        else if (this.args.account) {\n            const defaultCredPath = await defaultCredentials_1.getCredentialPathAsync(this.args.account);\n            if (defaultCredPath) {\n                this.logger.log(\"DEBUG\", `Setting GAC to ${defaultCredPath}`);\n                credentialEnv.GOOGLE_APPLICATION_CREDENTIALS = defaultCredPath;\n            }\n        }\n        else {\n            this.logger.logLabeled(\"WARN\", \"functions\", \"You are not signed in to the Firebase CLI. If you have authorized this machine using gcloud application-default credentials those may be discovered and used to access production services.\");\n        }\n        return credentialEnv;\n    }\n    createHubServer() {\n        this.workQueue.start();\n        const hub = express();\n        const dataMiddleware = (req, res, next) => {\n            const chunks = [];\n            req.on(\"data\", (chunk) => {\n                chunks.push(chunk);\n            });\n            req.on(\"end\", () => {\n                req.rawBody = Buffer.concat(chunks);\n                next();\n            });\n        };\n        const backgroundFunctionRoute = `/functions/projects/:project_id/triggers/:trigger_name`;\n        const httpsFunctionRoute = `/${this.args.projectId}/:region/:trigger_name`;\n        const multicastFunctionRoute = `/functions/projects/:project_id/trigger_multicast`;\n        const httpsFunctionRoutes = [httpsFunctionRoute, `${httpsFunctionRoute}/*`];\n        const backgroundHandler = (req, res) => {\n            var _a;\n            const region = req.params.region;\n            const triggerId = req.params.trigger_name;\n            const projectId = req.params.project_id;\n            const reqBody = req.rawBody;\n            let proto = JSON.parse(reqBody.toString());\n            if ((_a = req.headers[\"content-type\"]) === null || _a === void 0 ? void 0 : _a.includes(\"cloudevent\")) {\n                if (types_2.EventUtils.isBinaryCloudEvent(req)) {\n                    proto = types_2.EventUtils.extractBinaryCloudEventContext(req);\n                    proto.data = req.body;\n                }\n            }\n            this.workQueue.submit(() => {\n                this.logger.log(\"DEBUG\", `Accepted request ${req.method} ${req.url} --> ${triggerId}`);\n                return this.handleBackgroundTrigger(projectId, triggerId, proto)\n                    .then((x) => res.json(x))\n                    .catch((errorBundle) => {\n                    if (errorBundle.body) {\n                        res.status(errorBundle.code).send(errorBundle.body);\n                    }\n                    else {\n                        res.sendStatus(errorBundle.code);\n                    }\n                });\n            });\n        };\n        const httpsHandler = (req, res) => {\n            this.workQueue.submit(() => {\n                return this.handleHttpsTrigger(req, res);\n            });\n        };\n        const multicastHandler = (req, res) => {\n            var _a;\n            const projectId = req.params.project_id;\n            const reqBody = req.rawBody;\n            let proto = JSON.parse(reqBody.toString());\n            let triggerKey;\n            if ((_a = req.headers[\"content-type\"]) === null || _a === void 0 ? void 0 : _a.includes(\"cloudevent\")) {\n                triggerKey = `${this.args.projectId}:${proto.type}`;\n                if (types_2.EventUtils.isBinaryCloudEvent(req)) {\n                    proto = types_2.EventUtils.extractBinaryCloudEventContext(req);\n                    proto.data = req.body;\n                }\n            }\n            else {\n                triggerKey = `${this.args.projectId}:${proto.eventType}`;\n            }\n            const triggers = this.multicastTriggers[triggerKey] || [];\n            triggers.forEach((triggerId) => {\n                this.workQueue.submit(() => {\n                    this.logger.log(\"DEBUG\", `Accepted multicast request ${req.method} ${req.url} --> ${triggerId}`);\n                    return this.handleBackgroundTrigger(projectId, triggerId, proto);\n                });\n            });\n            res.json({ status: \"multicast_acknowledged\" });\n        };\n        hub.post(backgroundFunctionRoute, dataMiddleware, backgroundHandler);\n        hub.post(multicastFunctionRoute, dataMiddleware, multicastHandler);\n        hub.all(httpsFunctionRoutes, dataMiddleware, httpsHandler);\n        hub.all(\"*\", dataMiddleware, (req, res) => {\n            logger_1.logger.debug(`Functions emulator received unknown request at path ${req.path}`);\n            res.sendStatus(404);\n        });\n        return hub;\n    }\n    startFunctionRuntime(triggerId, targetName, signatureType, proto, runtimeOpts) {\n        const bundleTemplate = this.getBaseBundle();\n        const runtimeBundle = Object.assign(Object.assign({}, bundleTemplate), { emulators: {\n                firestore: this.getEmulatorInfo(types_1.Emulators.FIRESTORE),\n                database: this.getEmulatorInfo(types_1.Emulators.DATABASE),\n                pubsub: this.getEmulatorInfo(types_1.Emulators.PUBSUB),\n                auth: this.getEmulatorInfo(types_1.Emulators.AUTH),\n                storage: this.getEmulatorInfo(types_1.Emulators.STORAGE),\n            }, nodeMajorVersion: this.args.nodeMajorVersion, proto,\n            triggerId,\n            targetName });\n        const opts = runtimeOpts || {\n            nodeBinary: this.nodeBinary,\n            extensionTriggers: this.args.predefinedTriggers,\n        };\n        const worker = this.invokeRuntime(runtimeBundle, opts, this.getRuntimeEnvs({ targetName, signatureType }));\n        return worker;\n    }\n    async start() {\n        this.nodeBinary = this.askInstallNodeVersion(this.args.functionsDir, this.args.nodeMajorVersion);\n        const credentialEnv = await this.getCredentialsEnvironment();\n        this.args.env = Object.assign(Object.assign({}, credentialEnv), this.args.env);\n        const adminSdkConfig = await adminSdkConfig_1.getProjectAdminSdkConfigOrCached(this.args.projectId);\n        if (adminSdkConfig) {\n            this.adminSdkConfig = adminSdkConfig;\n        }\n        else {\n            this.logger.logLabeled(\"WARN\", \"functions\", \"Unable to fetch project Admin SDK configuration, Admin SDK behavior in Cloud Functions emulator may be incorrect.\");\n            this.adminSdkConfig = adminSdkConfig_1.constructDefaultAdminSdkConfig(this.args.projectId);\n        }\n        const { host, port } = this.getInfo();\n        this.workQueue.start();\n        const server = this.createHubServer().listen(port, host);\n        this.destroyServer = utils_1.createDestroyer(server);\n        return Promise.resolve();\n    }\n    async connect() {\n        this.logger.logLabeled(\"BULLET\", \"functions\", `Watching \"${this.args.functionsDir}\" for Cloud Functions...`);\n        const watcher = chokidar.watch(this.args.functionsDir, {\n            ignored: [\n                /.+?[\\\\\\/]node_modules[\\\\\\/].+?/,\n                /(^|[\\/\\\\])\\../,\n                /.+\\.log/,\n            ],\n            persistent: true,\n        });\n        const debouncedLoadTriggers = _.debounce(() => this.loadTriggers(), 1000);\n        watcher.on(\"change\", (filePath) => {\n            this.logger.log(\"DEBUG\", `File ${filePath} changed, reloading triggers`);\n            return debouncedLoadTriggers();\n        });\n        return this.loadTriggers(true);\n    }\n    async stop() {\n        try {\n            await this.workQueue.flush();\n        }\n        catch (e) {\n            this.logger.logLabeled(\"WARN\", \"functions\", \"Functions emulator work queue did not empty before stopping\");\n        }\n        this.workQueue.stop();\n        this.workerPool.exit();\n        if (this.destroyServer) {\n            await this.destroyServer();\n        }\n    }\n    async loadTriggers(force = false) {\n        this.workerPool.refresh();\n        const worker = this.invokeRuntime(this.getBaseBundle(), {\n            nodeBinary: this.nodeBinary,\n            extensionTriggers: this.args.predefinedTriggers,\n        }, Object.assign(Object.assign(Object.assign(Object.assign({}, this.getSystemEnvs()), this.getEmulatorEnvs()), { FIREBASE_CONFIG: this.getFirebaseConfig() }), this.args.env));\n        const triggerParseEvent = await types_1.EmulatorLog.waitForLog(worker.runtime.events, \"SYSTEM\", \"triggers-parsed\");\n        const parsedDefinitions = triggerParseEvent.data\n            .triggerDefinitions;\n        const triggerDefinitions = functionsEmulatorShared_1.emulatedFunctionsByRegion(parsedDefinitions);\n        const toSetup = triggerDefinitions.filter((definition) => {\n            if (force) {\n                return true;\n            }\n            const anyEnabledMatch = Object.values(this.triggers).some((record) => {\n                const sameEntryPoint = record.def.entryPoint === definition.entryPoint;\n                const sameEventTrigger = JSON.stringify(record.def.eventTrigger) === JSON.stringify(definition.eventTrigger);\n                if (sameEntryPoint && !sameEventTrigger) {\n                    this.logger.log(\"DEBUG\", `Definition for trigger ${definition.entryPoint} changed from ${JSON.stringify(record.def.eventTrigger)} to ${JSON.stringify(definition.eventTrigger)}`);\n                }\n                return record.enabled && sameEntryPoint && sameEventTrigger;\n            });\n            return !anyEnabledMatch;\n        });\n        for (const definition of toSetup) {\n            let added = false;\n            let url = undefined;\n            if (definition.httpsTrigger) {\n                const { host, port } = this.getInfo();\n                added = true;\n                url = FunctionsEmulator.getHttpFunctionUrl(host, port, this.args.projectId, definition.name, definition.region);\n            }\n            else if (definition.eventTrigger) {\n                const service = functionsEmulatorShared_1.getFunctionService(definition);\n                const key = this.getTriggerKey(definition);\n                const signature = functionsEmulatorShared_1.getSignatureType(definition);\n                switch (service) {\n                    case constants_1.Constants.SERVICE_FIRESTORE:\n                        added = await this.addFirestoreTrigger(this.args.projectId, key, definition.eventTrigger);\n                        break;\n                    case constants_1.Constants.SERVICE_REALTIME_DATABASE:\n                        added = await this.addRealtimeDatabaseTrigger(this.args.projectId, key, definition.eventTrigger);\n                        break;\n                    case constants_1.Constants.SERVICE_PUBSUB:\n                        added = await this.addPubsubTrigger(definition.name, key, definition.eventTrigger, signature, definition.schedule);\n                        break;\n                    case constants_1.Constants.SERVICE_AUTH:\n                        added = this.addAuthTrigger(this.args.projectId, key, definition.eventTrigger);\n                        break;\n                    case constants_1.Constants.SERVICE_STORAGE:\n                        added = this.addStorageTrigger(this.args.projectId, key, definition.eventTrigger);\n                        break;\n                    default:\n                        this.logger.log(\"DEBUG\", `Unsupported trigger: ${JSON.stringify(definition)}`);\n                        break;\n                }\n            }\n            else {\n                this.logger.log(\"WARN\", `Trigger trigger \"${definition.name}\" has has neither \"httpsTrigger\" or \"eventTrigger\" member`);\n            }\n            const ignored = !added;\n            this.addTriggerRecord(definition, { ignored, url });\n            const type = definition.httpsTrigger\n                ? \"http\"\n                : constants_1.Constants.getServiceName(functionsEmulatorShared_1.getFunctionService(definition));\n            if (ignored) {\n                const msg = `function ignored because the ${type} emulator does not exist or is not running.`;\n                this.logger.logLabeled(\"BULLET\", `functions[${definition.id}]`, msg);\n            }\n            else {\n                const msg = url\n                    ? `${clc.bold(type)} function initialized (${url}).`\n                    : `${clc.bold(type)} function initialized.`;\n                this.logger.logLabeled(\"SUCCESS\", `functions[${definition.id}]`, msg);\n            }\n        }\n    }\n    addRealtimeDatabaseTrigger(projectId, key, eventTrigger) {\n        const databaseEmu = registry_1.EmulatorRegistry.get(types_1.Emulators.DATABASE);\n        if (!databaseEmu) {\n            return Promise.resolve(false);\n        }\n        const result = DATABASE_PATH_PATTERN.exec(eventTrigger.resource);\n        if (result === null || result.length !== 3) {\n            this.logger.log(\"WARN\", `Event trigger \"${key}\" has malformed \"resource\" member. ` + `${eventTrigger.resource}`);\n            return Promise.reject();\n        }\n        const instance = result[1];\n        const bundle = JSON.stringify({\n            name: `projects/${projectId}/locations/_/functions/${key}`,\n            path: result[2],\n            event: eventTrigger.eventType,\n            topic: `projects/${projectId}/topics/${key}`,\n        });\n        logger_1.logger.debug(`addRealtimeDatabaseTrigger[${instance}]`, JSON.stringify(bundle));\n        let setTriggersPath = \"/.settings/functionTriggers.json\";\n        if (instance !== \"\") {\n            setTriggersPath += `?ns=${instance}`;\n        }\n        else {\n            this.logger.log(\"WARN\", `No project in use. Registering function trigger for sentinel namespace '${constants_1.Constants.DEFAULT_DATABASE_EMULATOR_NAMESPACE}'`);\n        }\n        return api\n            .request(\"POST\", setTriggersPath, {\n            origin: `http://${registry_1.EmulatorRegistry.getInfoHostString(databaseEmu.getInfo())}`,\n            headers: {\n                Authorization: \"Bearer owner\",\n            },\n            data: bundle,\n            json: false,\n        })\n            .then(() => {\n            return true;\n        })\n            .catch((err) => {\n            this.logger.log(\"WARN\", \"Error adding trigger: \" + err);\n            throw err;\n        });\n    }\n    addFirestoreTrigger(projectId, key, eventTrigger) {\n        const firestoreEmu = registry_1.EmulatorRegistry.get(types_1.Emulators.FIRESTORE);\n        if (!firestoreEmu) {\n            return Promise.resolve(false);\n        }\n        const bundle = JSON.stringify({ eventTrigger });\n        logger_1.logger.debug(`addFirestoreTrigger`, JSON.stringify(bundle));\n        return api\n            .request(\"PUT\", `/emulator/v1/projects/${projectId}/triggers/${key}`, {\n            origin: `http://${registry_1.EmulatorRegistry.getInfoHostString(firestoreEmu.getInfo())}`,\n            data: bundle,\n            json: false,\n        })\n            .then(() => {\n            return true;\n        })\n            .catch((err) => {\n            this.logger.log(\"WARN\", \"Error adding trigger: \" + err);\n            throw err;\n        });\n    }\n    async addPubsubTrigger(triggerName, key, eventTrigger, signatureType, schedule) {\n        const pubsubPort = registry_1.EmulatorRegistry.getPort(types_1.Emulators.PUBSUB);\n        if (!pubsubPort) {\n            return false;\n        }\n        const pubsubEmulator = registry_1.EmulatorRegistry.get(types_1.Emulators.PUBSUB);\n        logger_1.logger.debug(`addPubsubTrigger`, JSON.stringify({ eventTrigger }));\n        const resource = eventTrigger.resource;\n        let topic;\n        if (schedule) {\n            topic = \"firebase-schedule-\" + triggerName;\n        }\n        else {\n            const resourceParts = resource.split(\"/\");\n            topic = resourceParts[resourceParts.length - 1];\n        }\n        try {\n            await pubsubEmulator.addTrigger(topic, key, signatureType);\n            return true;\n        }\n        catch (e) {\n            return false;\n        }\n    }\n    addAuthTrigger(projectId, key, eventTrigger) {\n        logger_1.logger.debug(`addAuthTrigger`, JSON.stringify({ eventTrigger }));\n        const eventTriggerId = `${projectId}:${eventTrigger.eventType}`;\n        const triggers = this.multicastTriggers[eventTriggerId] || [];\n        triggers.push(key);\n        this.multicastTriggers[eventTriggerId] = triggers;\n        return true;\n    }\n    addStorageTrigger(projectId, key, eventTrigger) {\n        logger_1.logger.debug(`addStorageTrigger`, JSON.stringify({ eventTrigger }));\n        const eventTriggerId = `${projectId}:${eventTrigger.eventType}`;\n        const triggers = this.multicastTriggers[eventTriggerId] || [];\n        triggers.push(key);\n        this.multicastTriggers[eventTriggerId] = triggers;\n        return true;\n    }\n    getProjectId() {\n        return this.args.projectId;\n    }\n    getInfo() {\n        const host = this.args.host || constants_1.Constants.getDefaultHost(types_1.Emulators.FUNCTIONS);\n        const port = this.args.port || constants_1.Constants.getDefaultPort(types_1.Emulators.FUNCTIONS);\n        return {\n            name: this.getName(),\n            host,\n            port,\n        };\n    }\n    getName() {\n        return types_1.Emulators.FUNCTIONS;\n    }\n    getTriggerDefinitions() {\n        return Object.values(this.triggers).map((record) => record.def);\n    }\n    getTriggerDefinitionByKey(triggerKey) {\n        const record = this.triggers[triggerKey];\n        if (!record) {\n            logger_1.logger.debug(`Could not find key=${triggerKey} in ${JSON.stringify(this.triggers)}`);\n            throw new error_1.FirebaseError(`No trigger with key ${triggerKey}`);\n        }\n        return record.def;\n    }\n    getTriggerKey(def) {\n        return def.eventTrigger ? `${def.id}-${this.triggerGeneration}` : def.id;\n    }\n    addTriggerRecord(def, opts) {\n        const key = this.getTriggerKey(def);\n        this.triggers[key] = { def, enabled: true, ignored: opts.ignored, url: opts.url };\n    }\n    setTriggersForTesting(triggers) {\n        triggers.forEach((def) => this.addTriggerRecord(def, { ignored: false }));\n    }\n    getBaseBundle() {\n        return {\n            cwd: this.args.functionsDir,\n            projectId: this.args.projectId,\n            triggerId: \"\",\n            targetName: \"\",\n            emulators: {\n                firestore: registry_1.EmulatorRegistry.getInfo(types_1.Emulators.FIRESTORE),\n                database: registry_1.EmulatorRegistry.getInfo(types_1.Emulators.DATABASE),\n                pubsub: registry_1.EmulatorRegistry.getInfo(types_1.Emulators.PUBSUB),\n                auth: registry_1.EmulatorRegistry.getInfo(types_1.Emulators.AUTH),\n                storage: registry_1.EmulatorRegistry.getInfo(types_1.Emulators.STORAGE),\n            },\n            adminSdkConfig: {\n                databaseURL: this.adminSdkConfig.databaseURL,\n                storageBucket: this.adminSdkConfig.storageBucket,\n            },\n            disabled_features: this.args.disabledRuntimeFeatures,\n        };\n    }\n    getRequestedNodeRuntimeVersion(frb) {\n        const pkg = require(path.join(frb.cwd, \"package.json\"));\n        return frb.nodeMajorVersion || (pkg.engines && pkg.engines.node);\n    }\n    askInstallNodeVersion(cwd, nodeMajorVersion) {\n        const pkg = require(path.join(cwd, \"package.json\"));\n        if ((!pkg.engines || !pkg.engines.node) && !nodeMajorVersion) {\n            this.logger.log(\"WARN\", \"Your functions directory does not specify a Node version.\\n   \" +\n                \"- Learn more at https://firebase.google.com/docs/functions/manage-functions#set_runtime_options\");\n            return process.execPath;\n        }\n        const hostMajorVersion = process.versions.node.split(\".\")[0];\n        const requestedMajorVersion = nodeMajorVersion\n            ? `${nodeMajorVersion}`\n            : pkg.engines.node;\n        let localMajorVersion = \"0\";\n        const localNodePath = path.join(cwd, \"node_modules/.bin/node\");\n        try {\n            const localNodeOutput = child_process_1.spawnSync(localNodePath, [\"--version\"]).stdout.toString();\n            localMajorVersion = localNodeOutput.slice(1).split(\".\")[0];\n        }\n        catch (err) {\n        }\n        if (requestedMajorVersion === localMajorVersion) {\n            this.logger.logLabeled(\"SUCCESS\", \"functions\", `Using node@${requestedMajorVersion} from local cache.`);\n            return localNodePath;\n        }\n        if (requestedMajorVersion === hostMajorVersion) {\n            this.logger.logLabeled(\"SUCCESS\", \"functions\", `Using node@${requestedMajorVersion} from host.`);\n            return process.execPath;\n        }\n        this.logger.log(\"WARN\", `Your requested \"node\" version \"${requestedMajorVersion}\" doesn't match your global version \"${hostMajorVersion}\"`);\n        return process.execPath;\n    }\n    getUserEnvs() {\n        const projectInfo = {\n            functionsSource: this.args.functionsDir,\n            projectId: this.args.projectId,\n            isEmulator: true,\n        };\n        if (functionsEnv.hasUserEnvs(projectInfo)) {\n            try {\n                return functionsEnv.loadUserEnvs(projectInfo);\n            }\n            catch (e) {\n                logger_1.logger.debug(\"Failed to load local environment variables\", e);\n            }\n        }\n        return {};\n    }\n    getSystemEnvs(triggerDef) {\n        const envs = {};\n        envs.GCLOUD_PROJECT = this.args.projectId;\n        envs.K_REVISION = \"1\";\n        envs.PORT = \"80\";\n        if (triggerDef) {\n            const service = triggerDef.targetName;\n            const target = service.replace(/-/g, \".\");\n            envs.FUNCTION_TARGET = target;\n            envs.FUNCTION_SIGNATURE_TYPE = triggerDef.signatureType;\n            envs.K_SERVICE = service;\n        }\n        return envs;\n    }\n    getEmulatorEnvs() {\n        const envs = {};\n        envs.FUNCTIONS_EMULATOR = \"true\";\n        envs.TZ = \"UTC\";\n        const firestoreEmulator = this.getEmulatorInfo(types_1.Emulators.FIRESTORE);\n        if (firestoreEmulator != null) {\n            envs[constants_1.Constants.FIRESTORE_EMULATOR_HOST] = functionsEmulatorShared_1.formatHost(firestoreEmulator);\n        }\n        const databaseEmulator = this.getEmulatorInfo(types_1.Emulators.DATABASE);\n        if (databaseEmulator) {\n            envs[constants_1.Constants.FIREBASE_DATABASE_EMULATOR_HOST] = functionsEmulatorShared_1.formatHost(databaseEmulator);\n        }\n        const authEmulator = this.getEmulatorInfo(types_1.Emulators.AUTH);\n        if (authEmulator) {\n            envs[constants_1.Constants.FIREBASE_AUTH_EMULATOR_HOST] = functionsEmulatorShared_1.formatHost(authEmulator);\n        }\n        const storageEmulator = this.getEmulatorInfo(types_1.Emulators.STORAGE);\n        if (storageEmulator) {\n            envs[constants_1.Constants.FIREBASE_STORAGE_EMULATOR_HOST] = functionsEmulatorShared_1.formatHost(storageEmulator);\n            envs[constants_1.Constants.CLOUD_STORAGE_EMULATOR_HOST] = `http://${functionsEmulatorShared_1.formatHost(storageEmulator)}`;\n        }\n        const pubsubEmulator = this.getEmulatorInfo(types_1.Emulators.PUBSUB);\n        if (pubsubEmulator) {\n            const pubsubHost = functionsEmulatorShared_1.formatHost(pubsubEmulator);\n            process.env.PUBSUB_EMULATOR_HOST = pubsubHost;\n        }\n        return envs;\n    }\n    getFirebaseConfig() {\n        const databaseEmulator = this.getEmulatorInfo(types_1.Emulators.DATABASE);\n        let emulatedDatabaseURL = undefined;\n        if (databaseEmulator) {\n            let ns = this.args.projectId;\n            if (this.adminSdkConfig.databaseURL) {\n                const asUrl = new url_1.URL(this.adminSdkConfig.databaseURL);\n                ns = asUrl.hostname.split(\".\")[0];\n            }\n            emulatedDatabaseURL = `http://${functionsEmulatorShared_1.formatHost(databaseEmulator)}/?ns=${ns}`;\n        }\n        return JSON.stringify({\n            storageBucket: this.adminSdkConfig.storageBucket,\n            databaseURL: emulatedDatabaseURL || this.adminSdkConfig.databaseURL,\n            projectId: this.args.projectId,\n        });\n    }\n    getRuntimeEnvs(triggerDef) {\n        return Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({}, this.getUserEnvs()), this.getSystemEnvs(triggerDef)), this.getEmulatorEnvs()), { FIREBASE_CONFIG: this.getFirebaseConfig() }), this.args.env);\n    }\n    invokeRuntime(frb, opts, runtimeEnv) {\n        if (this.workerPool.readyForWork(frb.triggerId)) {\n            return this.workerPool.submitWork(frb.triggerId, frb, opts);\n        }\n        const emitter = new events_1.EventEmitter();\n        const args = [path.join(__dirname, \"functionsEmulatorRuntime\")];\n        if (opts.ignore_warnings) {\n            args.unshift(\"--no-warnings\");\n        }\n        if (this.args.debugPort) {\n            if (process.env.FIREPIT_VERSION && process.execPath == opts.nodeBinary) {\n                const requestedMajorNodeVersion = this.getRequestedNodeRuntimeVersion(frb);\n                this.logger.log(\"WARN\", `To enable function inspection, please run \"${process.execPath} is:npm i node@${requestedMajorNodeVersion} --save-dev\" in your functions directory`);\n            }\n            else {\n                const { host } = this.getInfo();\n                args.unshift(`--inspect=${host}:${this.args.debugPort}`);\n            }\n        }\n        const pnpPath = path.join(frb.cwd, \".pnp.js\");\n        if (fs.existsSync(pnpPath)) {\n            emulatorLogger_1.EmulatorLogger.forEmulator(types_1.Emulators.FUNCTIONS).logLabeled(\"WARN_ONCE\", \"functions\", \"Detected yarn@2 with PnP. \" +\n                \"Cloud Functions for Firebase requires a node_modules folder to work correctly and is therefore incompatible with PnP. \" +\n                \"See https://yarnpkg.com/getting-started/migration#step-by-step for more information.\");\n        }\n        const childProcess = spawn(opts.nodeBinary, args, {\n            env: Object.assign(Object.assign({ node: opts.nodeBinary }, process.env), (runtimeEnv !== null && runtimeEnv !== void 0 ? runtimeEnv : {})),\n            cwd: frb.cwd,\n            stdio: [\"pipe\", \"pipe\", \"pipe\", \"ipc\"],\n        });\n        const buffers = {\n            stderr: { pipe: childProcess.stderr, value: \"\" },\n            stdout: { pipe: childProcess.stdout, value: \"\" },\n        };\n        const ipcBuffer = { value: \"\" };\n        childProcess.on(\"message\", (message) => {\n            this.onData(childProcess, emitter, ipcBuffer, message);\n        });\n        for (const id in buffers) {\n            if (buffers.hasOwnProperty(id)) {\n                const buffer = buffers[id];\n                buffer.pipe.on(\"data\", (buf) => {\n                    this.onData(childProcess, emitter, buffer, buf);\n                });\n            }\n        }\n        const runtime = {\n            pid: childProcess.pid,\n            exit: new Promise((resolve) => {\n                childProcess.on(\"exit\", resolve);\n            }),\n            events: emitter,\n            shutdown: () => {\n                childProcess.kill();\n            },\n            kill: (signal) => {\n                childProcess.kill(signal);\n                emitter.emit(\"log\", new types_1.EmulatorLog(\"SYSTEM\", \"runtime-status\", \"killed\"));\n            },\n            send: (args) => {\n                return childProcess.send(JSON.stringify(args));\n            },\n        };\n        this.workerPool.addWorker(frb.triggerId, runtime);\n        return this.workerPool.submitWork(frb.triggerId, frb, opts);\n    }\n    async disableBackgroundTriggers() {\n        Object.values(this.triggers).forEach((record) => {\n            if (record.def.eventTrigger && record.enabled) {\n                this.logger.logLabeled(\"BULLET\", `functions[${record.def.entryPoint}]`, \"function temporarily disabled.\");\n                record.enabled = false;\n            }\n        });\n        await this.workQueue.flush();\n    }\n    async reloadTriggers() {\n        this.triggerGeneration++;\n        return this.loadTriggers();\n    }\n    async handleBackgroundTrigger(projectId, triggerKey, proto) {\n        const record = this.triggers[triggerKey];\n        if (record && !record.enabled) {\n            return Promise.reject({ code: 204, body: \"Background triggers are curently disabled.\" });\n        }\n        const trigger = this.getTriggerDefinitionByKey(triggerKey);\n        const service = functionsEmulatorShared_1.getFunctionService(trigger);\n        const worker = this.startFunctionRuntime(trigger.id, trigger.name, functionsEmulatorShared_1.getSignatureType(trigger), proto);\n        return new Promise((resolve, reject) => {\n            if (projectId !== this.args.projectId) {\n                if (service !== constants_1.Constants.SERVICE_REALTIME_DATABASE) {\n                    logger_1.logger.debug(`Received functions trigger for service \"${service}\" for unknown project \"${projectId}\".`);\n                    reject({ code: 404 });\n                    return;\n                }\n                if (!trigger.eventTrigger.resource.startsWith(`projects/_/instances/${projectId}`)) {\n                    logger_1.logger.debug(`Received functions trigger for function \"${trigger.name}\" of project \"${projectId}\" that did not match definition: ${JSON.stringify(trigger)}.`);\n                    reject({ code: 404 });\n                    return;\n                }\n            }\n            worker.onLogs((el) => {\n                if (el.level === \"FATAL\") {\n                    reject({ code: 500, body: el.text });\n                }\n            });\n            track(EVENT_INVOKE, functionsEmulatorShared_1.getFunctionService(trigger));\n            worker.waitForDone().then(() => {\n                resolve({ status: \"acknowledged\" });\n            });\n        });\n    }\n    getEmulatorInfo(emulator) {\n        if (this.args.remoteEmulators) {\n            if (this.args.remoteEmulators[emulator]) {\n                return this.args.remoteEmulators[emulator];\n            }\n        }\n        return registry_1.EmulatorRegistry.getInfo(emulator);\n    }\n    tokenFromAuthHeader(authHeader) {\n        const match = authHeader.match(/^Bearer (.*)$/);\n        if (!match) {\n            return;\n        }\n        let idToken = match[1];\n        logger_1.logger.debug(`ID Token: ${idToken}`);\n        if (idToken && idToken.includes(\"=\")) {\n            idToken = idToken.replace(/[=]+?\\./g, \".\");\n            logger_1.logger.debug(`ID Token contained invalid padding, new value: ${idToken}`);\n        }\n        try {\n            const decoded = jwt.decode(idToken, { complete: true });\n            if (!decoded || typeof decoded !== \"object\") {\n                logger_1.logger.debug(`Failed to decode ID Token: ${decoded}`);\n                return;\n            }\n            const claims = decoded.payload;\n            claims.uid = claims.sub;\n            return claims;\n        }\n        catch (e) {\n            return;\n        }\n    }\n    async handleHttpsTrigger(req, res) {\n        const method = req.method;\n        const region = req.params.region;\n        const triggerName = req.params.trigger_name;\n        const triggerId = `${region}-${triggerName}`;\n        if (!this.triggers[triggerId]) {\n            res\n                .status(404)\n                .send(`Function ${triggerId} does not exist, valid triggers are: ${Object.keys(this.triggers).join(\", \")}`);\n            return;\n        }\n        const trigger = this.getTriggerDefinitionByKey(triggerId);\n        logger_1.logger.debug(`Accepted request ${method} ${req.url} --> ${triggerId}`);\n        const reqBody = req.rawBody;\n        const isCallable = trigger.labels && trigger.labels[\"deployment-callable\"] === \"true\";\n        const authHeader = req.header(\"Authorization\");\n        if (authHeader && isCallable) {\n            const token = this.tokenFromAuthHeader(authHeader);\n            if (token) {\n                const contextAuth = {\n                    uid: token.uid,\n                    token: token,\n                };\n                req.headers[functionsEmulatorShared_1.HttpConstants.ORIGINAL_AUTH_HEADER] = req.headers[\"authorization\"];\n                delete req.headers[\"authorization\"];\n                req.headers[functionsEmulatorShared_1.HttpConstants.CALLABLE_AUTH_HEADER] = encodeURIComponent(JSON.stringify(contextAuth));\n            }\n        }\n        const worker = this.startFunctionRuntime(trigger.id, trigger.name, \"http\", undefined);\n        worker.onLogs((el) => {\n            if (el.level === \"FATAL\") {\n                res.status(500).send(el.text);\n            }\n        });\n        await worker.waitForSocketReady();\n        track(EVENT_INVOKE, \"https\");\n        this.logger.log(\"DEBUG\", `[functions] Runtime ready! Sending request!`);\n        if (!worker.lastArgs) {\n            throw new error_1.FirebaseError(\"Cannot execute on a worker with no arguments\");\n        }\n        if (!worker.lastArgs.frb.socketPath) {\n            throw new error_1.FirebaseError(`Cannot execute on a worker without a socketPath: ${JSON.stringify(worker.lastArgs)}`);\n        }\n        const url = new url_1.URL(`${req.protocol}://${req.hostname}${req.url}`);\n        const path = `${url.pathname}${url.search}`.replace(new RegExp(`\\/${this.args.projectId}\\/[^\\/]*\\/${triggerName}\\/?`), \"/\");\n        this.logger.log(\"DEBUG\", `[functions] Got req.url=${req.url}, mapping to path=${path}`);\n        const runtimeReq = http.request({\n            method,\n            path,\n            headers: req.headers,\n            socketPath: worker.lastArgs.frb.socketPath,\n        }, (runtimeRes) => {\n            function forwardStatusAndHeaders() {\n                res.status(runtimeRes.statusCode || 200);\n                if (!res.headersSent) {\n                    Object.keys(runtimeRes.headers).forEach((key) => {\n                        const val = runtimeRes.headers[key];\n                        if (val) {\n                            res.setHeader(key, val);\n                        }\n                    });\n                }\n            }\n            runtimeRes.on(\"data\", (buf) => {\n                forwardStatusAndHeaders();\n                res.write(buf);\n            });\n            runtimeRes.on(\"close\", () => {\n                forwardStatusAndHeaders();\n                res.end();\n            });\n            runtimeRes.on(\"end\", () => {\n                forwardStatusAndHeaders();\n                res.end();\n            });\n        });\n        runtimeReq.on(\"error\", () => {\n            res.end();\n        });\n        if (reqBody) {\n            runtimeReq.write(reqBody);\n            runtimeReq.end();\n        }\n        req.pipe(runtimeReq, { end: true }).on(\"error\", () => {\n            res.end();\n        });\n        await worker.waitForDone();\n    }\n    onData(runtime, emitter, buffer, buf) {\n        buffer.value += buf.toString();\n        const lines = buffer.value.split(\"\\n\");\n        if (lines.length > 1) {\n            lines.slice(0, -1).forEach((line) => {\n                const log = types_1.EmulatorLog.fromJSON(line);\n                emitter.emit(\"log\", log);\n                if (log.level === \"FATAL\") {\n                    emitter.emit(\"log\", new types_1.EmulatorLog(\"SYSTEM\", \"runtime-status\", \"killed\"));\n                    runtime.kill();\n                }\n            });\n        }\n        buffer.value = lines[lines.length - 1];\n    }\n}\nexports.FunctionsEmulator = FunctionsEmulator;\n"]},"metadata":{},"sourceType":"script"}