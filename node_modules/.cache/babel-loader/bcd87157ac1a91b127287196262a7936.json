{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.compareFunctions = exports.missingEndpoint = exports.hasEndpoint = exports.regionalEndpoints = exports.matchingBackend = exports.someEndpoint = exports.allEndpoints = exports.checkAvailability = exports.existingBackend = exports.scheduleIdForFunction = exports.functionName = exports.isEmptyBackend = exports.of = exports.empty = exports.isScheduleTriggered = exports.isEventTriggered = exports.isHttpsTriggered = exports.SCHEDULED_FUNCTION_LABEL = exports.memoryOptionDisplayName = exports.endpointTriggerType = void 0;\n\nconst gcf = require(\"../../gcp/cloudfunctions\");\n\nconst gcfV2 = require(\"../../gcp/cloudfunctionsv2\");\n\nconst utils = require(\"../../utils\");\n\nconst error_1 = require(\"../../error\");\n\nconst previews_1 = require(\"../../previews\");\n\nfunction endpointTriggerType(endpoint) {\n  if (isScheduleTriggered(endpoint)) {\n    return \"scheduled\";\n  } else if (isHttpsTriggered(endpoint)) {\n    return \"https\";\n  } else if (isEventTriggered(endpoint)) {\n    return endpoint.eventTrigger.eventType;\n  } else {\n    throw new Error(\"Unexpected trigger type for endpoint \" + JSON.stringify(endpoint));\n  }\n}\n\nexports.endpointTriggerType = endpointTriggerType;\n\nfunction memoryOptionDisplayName(option) {\n  return {\n    128: \"128MB\",\n    256: \"256MB\",\n    512: \"512MB\",\n    1024: \"1GB\",\n    2048: \"2GB\",\n    4096: \"4GB\",\n    8192: \"8GB\"\n  }[option];\n}\n\nexports.memoryOptionDisplayName = memoryOptionDisplayName;\nexports.SCHEDULED_FUNCTION_LABEL = Object.freeze({\n  deployment: \"firebase-schedule\"\n});\n\nfunction isHttpsTriggered(triggered) {\n  return {}.hasOwnProperty.call(triggered, \"httpsTrigger\");\n}\n\nexports.isHttpsTriggered = isHttpsTriggered;\n\nfunction isEventTriggered(triggered) {\n  return {}.hasOwnProperty.call(triggered, \"eventTrigger\");\n}\n\nexports.isEventTriggered = isEventTriggered;\n\nfunction isScheduleTriggered(triggered) {\n  return {}.hasOwnProperty.call(triggered, \"scheduleTrigger\");\n}\n\nexports.isScheduleTriggered = isScheduleTriggered;\n\nfunction empty() {\n  return {\n    requiredAPIs: {},\n    endpoints: {},\n    environmentVariables: {}\n  };\n}\n\nexports.empty = empty;\n\nfunction of(...endpoints) {\n  const bkend = Object.assign({}, empty());\n\n  for (const endpoint of endpoints) {\n    bkend.endpoints[endpoint.region] = bkend.endpoints[endpoint.region] || {};\n\n    if (bkend.endpoints[endpoint.region][endpoint.id]) {\n      throw new Error(\"Trying to create a backend with the same endpiont twice\");\n    }\n\n    bkend.endpoints[endpoint.region][endpoint.id] = endpoint;\n  }\n\n  return bkend;\n}\n\nexports.of = of;\n\nfunction isEmptyBackend(backend) {\n  return Object.keys(backend.requiredAPIs).length == 0 && Object.keys(backend.endpoints).length === 0;\n}\n\nexports.isEmptyBackend = isEmptyBackend;\n\nfunction functionName(cloudFunction) {\n  return `projects/${cloudFunction.project}/locations/${cloudFunction.region}/functions/${cloudFunction.id}`;\n}\n\nexports.functionName = functionName;\n\nfunction scheduleIdForFunction(cloudFunction) {\n  return `firebase-schedule-${cloudFunction.id}-${cloudFunction.region}`;\n}\n\nexports.scheduleIdForFunction = scheduleIdForFunction;\n\nasync function existingBackend(context, forceRefresh) {\n  const ctx = context;\n\n  if (!ctx.loadedExistingBackend || forceRefresh) {\n    await loadExistingBackend(ctx);\n  }\n\n  return ctx.existingBackend;\n}\n\nexports.existingBackend = existingBackend;\n\nasync function loadExistingBackend(ctx) {\n  var _a;\n\n  ctx.loadedExistingBackend = true;\n  ctx.existingBackend = Object.assign({}, empty());\n  ctx.unreachableRegions = {\n    gcfV1: [],\n    gcfV2: []\n  };\n  const gcfV1Results = await gcf.listAllFunctions(ctx.projectId);\n\n  for (const apiFunction of gcfV1Results.functions) {\n    const endpoint = gcf.endpointFromFunction(apiFunction);\n    ctx.existingBackend.endpoints[endpoint.region] = ctx.existingBackend.endpoints[endpoint.region] || {};\n    ctx.existingBackend.endpoints[endpoint.region][endpoint.id] = endpoint;\n  }\n\n  ctx.unreachableRegions.gcfV1 = gcfV1Results.unreachable;\n\n  if (!previews_1.previews.functionsv2) {\n    return;\n  }\n\n  let gcfV2Results;\n\n  try {\n    gcfV2Results = await gcfV2.listAllFunctions(ctx.projectId);\n  } catch (err) {\n    if (err.status === 404 && ((_a = err.message) === null || _a === void 0 ? void 0 : _a.toLowerCase().includes(\"method not found\"))) {\n      return;\n    }\n\n    throw err;\n  }\n\n  for (const apiFunction of gcfV2Results.functions) {\n    const endpoint = gcfV2.endpointFromFunction(apiFunction);\n    ctx.existingBackend.endpoints[endpoint.region] = ctx.existingBackend.endpoints[endpoint.region] || {};\n    ctx.existingBackend.endpoints[endpoint.region][endpoint.id] = endpoint;\n  }\n\n  ctx.unreachableRegions.gcfV2 = gcfV2Results.unreachable;\n}\n\nasync function checkAvailability(context, want) {\n  const ctx = context;\n\n  if (!ctx.loadedExistingBackend) {\n    await loadExistingBackend(ctx);\n  }\n\n  const gcfV1Regions = new Set();\n  const gcfV2Regions = new Set();\n\n  for (const ep of allEndpoints(want)) {\n    if (ep.platform == \"gcfv1\") {\n      gcfV1Regions.add(ep.region);\n    } else {\n      gcfV2Regions.add(ep.region);\n    }\n  }\n\n  const neededUnreachableV1 = ctx.unreachableRegions.gcfV1.filter(region => gcfV1Regions.has(region));\n  const neededUnreachableV2 = ctx.unreachableRegions.gcfV2.filter(region => gcfV2Regions.has(region));\n\n  if (neededUnreachableV1.length) {\n    throw new error_1.FirebaseError(\"The following Cloud Functions regions are currently unreachable:\\n\\t\" + neededUnreachableV1.join(\"\\n\\t\") + \"\\nThis deployment contains functions in those regions. Please try again in a few minutes, or exclude these regions from your deployment.\");\n  }\n\n  if (neededUnreachableV2.length) {\n    throw new error_1.FirebaseError(\"The following Cloud Functions V2 regions are currently unreachable:\\n\\t\" + neededUnreachableV2.join(\"\\n\\t\") + \"\\nThis deployment contains functions in those regions. Please try again in a few minutes, or exclude these regions from your deployment.\");\n  }\n\n  if (ctx.unreachableRegions.gcfV1.length) {\n    utils.logLabeledWarning(\"functions\", \"The following Cloud Functions regions are currently unreachable:\\n\" + ctx.unreachableRegions.gcfV1.join(\"\\n\") + \"\\nCloud Functions in these regions won't be deleted.\");\n  }\n\n  if (ctx.unreachableRegions.gcfV2.length) {\n    utils.logLabeledWarning(\"functions\", \"The following Cloud Functions V2 regions are currently unreachable:\\n\" + ctx.unreachableRegions.gcfV2.join(\"\\n\") + \"\\nCloud Functions in these regions won't be deleted.\");\n  }\n}\n\nexports.checkAvailability = checkAvailability;\n\nfunction allEndpoints(backend) {\n  return Object.values(backend.endpoints).reduce((accum, perRegion) => {\n    return [...accum, ...Object.values(perRegion)];\n  }, []);\n}\n\nexports.allEndpoints = allEndpoints;\n\nfunction someEndpoint(backend, predicate) {\n  for (const endpoints of Object.values(backend.endpoints)) {\n    if (Object.values(endpoints).some(predicate)) {\n      return true;\n    }\n  }\n\n  return false;\n}\n\nexports.someEndpoint = someEndpoint;\n\nfunction matchingBackend(backend, predicate) {\n  const filtered = Object.assign({}, empty());\n\n  for (const endpoint of allEndpoints(backend)) {\n    if (!predicate(endpoint)) {\n      continue;\n    }\n\n    filtered.endpoints[endpoint.region] = filtered.endpoints[endpoint.region] || {};\n    filtered.endpoints[endpoint.region][endpoint.id] = endpoint;\n  }\n\n  return filtered;\n}\n\nexports.matchingBackend = matchingBackend;\n\nfunction regionalEndpoints(backend, region) {\n  return backend.endpoints[region] ? Object.values(backend.endpoints[region]) : [];\n}\n\nexports.regionalEndpoints = regionalEndpoints;\n\nexports.hasEndpoint = backend => endpoint => {\n  return !!backend.endpoints[endpoint.region] && !!backend.endpoints[endpoint.region][endpoint.id];\n};\n\nexports.missingEndpoint = backend => endpoint => {\n  return !exports.hasEndpoint(backend)(endpoint);\n};\n\nfunction compareFunctions(left, right) {\n  if (left.platform != right.platform) {\n    return right.platform < left.platform ? -1 : 1;\n  }\n\n  if (left.region < right.region) {\n    return -1;\n  }\n\n  if (left.region > right.region) {\n    return 1;\n  }\n\n  if (left.id < right.id) {\n    return -1;\n  }\n\n  if (left.id > right.id) {\n    return 1;\n  }\n\n  return 0;\n}\n\nexports.compareFunctions = compareFunctions;","map":{"version":3,"sources":["C:/Users/Sharik/Desktop/Projects/ReactProject/my-first-app/node_modules/firebase-tools/lib/deploy/functions/backend.js"],"names":["Object","defineProperty","exports","value","compareFunctions","missingEndpoint","hasEndpoint","regionalEndpoints","matchingBackend","someEndpoint","allEndpoints","checkAvailability","existingBackend","scheduleIdForFunction","functionName","isEmptyBackend","of","empty","isScheduleTriggered","isEventTriggered","isHttpsTriggered","SCHEDULED_FUNCTION_LABEL","memoryOptionDisplayName","endpointTriggerType","gcf","require","gcfV2","utils","error_1","previews_1","endpoint","eventTrigger","eventType","Error","JSON","stringify","option","freeze","deployment","triggered","hasOwnProperty","call","requiredAPIs","endpoints","environmentVariables","bkend","assign","region","id","backend","keys","length","cloudFunction","project","context","forceRefresh","ctx","loadedExistingBackend","loadExistingBackend","_a","unreachableRegions","gcfV1","gcfV1Results","listAllFunctions","projectId","apiFunction","functions","endpointFromFunction","unreachable","previews","functionsv2","gcfV2Results","err","status","message","toLowerCase","includes","want","gcfV1Regions","Set","gcfV2Regions","ep","platform","add","neededUnreachableV1","filter","has","neededUnreachableV2","FirebaseError","join","logLabeledWarning","values","reduce","accum","perRegion","predicate","some","filtered","left","right"],"mappings":"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","sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.compareFunctions = exports.missingEndpoint = exports.hasEndpoint = exports.regionalEndpoints = exports.matchingBackend = exports.someEndpoint = exports.allEndpoints = exports.checkAvailability = exports.existingBackend = exports.scheduleIdForFunction = exports.functionName = exports.isEmptyBackend = exports.of = exports.empty = exports.isScheduleTriggered = exports.isEventTriggered = exports.isHttpsTriggered = exports.SCHEDULED_FUNCTION_LABEL = exports.memoryOptionDisplayName = exports.endpointTriggerType = void 0;\nconst gcf = require(\"../../gcp/cloudfunctions\");\nconst gcfV2 = require(\"../../gcp/cloudfunctionsv2\");\nconst utils = require(\"../../utils\");\nconst error_1 = require(\"../../error\");\nconst previews_1 = require(\"../../previews\");\nfunction endpointTriggerType(endpoint) {\n    if (isScheduleTriggered(endpoint)) {\n        return \"scheduled\";\n    }\n    else if (isHttpsTriggered(endpoint)) {\n        return \"https\";\n    }\n    else if (isEventTriggered(endpoint)) {\n        return endpoint.eventTrigger.eventType;\n    }\n    else {\n        throw new Error(\"Unexpected trigger type for endpoint \" + JSON.stringify(endpoint));\n    }\n}\nexports.endpointTriggerType = endpointTriggerType;\nfunction memoryOptionDisplayName(option) {\n    return {\n        128: \"128MB\",\n        256: \"256MB\",\n        512: \"512MB\",\n        1024: \"1GB\",\n        2048: \"2GB\",\n        4096: \"4GB\",\n        8192: \"8GB\",\n    }[option];\n}\nexports.memoryOptionDisplayName = memoryOptionDisplayName;\nexports.SCHEDULED_FUNCTION_LABEL = Object.freeze({ deployment: \"firebase-schedule\" });\nfunction isHttpsTriggered(triggered) {\n    return {}.hasOwnProperty.call(triggered, \"httpsTrigger\");\n}\nexports.isHttpsTriggered = isHttpsTriggered;\nfunction isEventTriggered(triggered) {\n    return {}.hasOwnProperty.call(triggered, \"eventTrigger\");\n}\nexports.isEventTriggered = isEventTriggered;\nfunction isScheduleTriggered(triggered) {\n    return {}.hasOwnProperty.call(triggered, \"scheduleTrigger\");\n}\nexports.isScheduleTriggered = isScheduleTriggered;\nfunction empty() {\n    return {\n        requiredAPIs: {},\n        endpoints: {},\n        environmentVariables: {},\n    };\n}\nexports.empty = empty;\nfunction of(...endpoints) {\n    const bkend = Object.assign({}, empty());\n    for (const endpoint of endpoints) {\n        bkend.endpoints[endpoint.region] = bkend.endpoints[endpoint.region] || {};\n        if (bkend.endpoints[endpoint.region][endpoint.id]) {\n            throw new Error(\"Trying to create a backend with the same endpiont twice\");\n        }\n        bkend.endpoints[endpoint.region][endpoint.id] = endpoint;\n    }\n    return bkend;\n}\nexports.of = of;\nfunction isEmptyBackend(backend) {\n    return (Object.keys(backend.requiredAPIs).length == 0 && Object.keys(backend.endpoints).length === 0);\n}\nexports.isEmptyBackend = isEmptyBackend;\nfunction functionName(cloudFunction) {\n    return `projects/${cloudFunction.project}/locations/${cloudFunction.region}/functions/${cloudFunction.id}`;\n}\nexports.functionName = functionName;\nfunction scheduleIdForFunction(cloudFunction) {\n    return `firebase-schedule-${cloudFunction.id}-${cloudFunction.region}`;\n}\nexports.scheduleIdForFunction = scheduleIdForFunction;\nasync function existingBackend(context, forceRefresh) {\n    const ctx = context;\n    if (!ctx.loadedExistingBackend || forceRefresh) {\n        await loadExistingBackend(ctx);\n    }\n    return ctx.existingBackend;\n}\nexports.existingBackend = existingBackend;\nasync function loadExistingBackend(ctx) {\n    var _a;\n    ctx.loadedExistingBackend = true;\n    ctx.existingBackend = Object.assign({}, empty());\n    ctx.unreachableRegions = {\n        gcfV1: [],\n        gcfV2: [],\n    };\n    const gcfV1Results = await gcf.listAllFunctions(ctx.projectId);\n    for (const apiFunction of gcfV1Results.functions) {\n        const endpoint = gcf.endpointFromFunction(apiFunction);\n        ctx.existingBackend.endpoints[endpoint.region] =\n            ctx.existingBackend.endpoints[endpoint.region] || {};\n        ctx.existingBackend.endpoints[endpoint.region][endpoint.id] = endpoint;\n    }\n    ctx.unreachableRegions.gcfV1 = gcfV1Results.unreachable;\n    if (!previews_1.previews.functionsv2) {\n        return;\n    }\n    let gcfV2Results;\n    try {\n        gcfV2Results = await gcfV2.listAllFunctions(ctx.projectId);\n    }\n    catch (err) {\n        if (err.status === 404 && ((_a = err.message) === null || _a === void 0 ? void 0 : _a.toLowerCase().includes(\"method not found\"))) {\n            return;\n        }\n        throw err;\n    }\n    for (const apiFunction of gcfV2Results.functions) {\n        const endpoint = gcfV2.endpointFromFunction(apiFunction);\n        ctx.existingBackend.endpoints[endpoint.region] =\n            ctx.existingBackend.endpoints[endpoint.region] || {};\n        ctx.existingBackend.endpoints[endpoint.region][endpoint.id] = endpoint;\n    }\n    ctx.unreachableRegions.gcfV2 = gcfV2Results.unreachable;\n}\nasync function checkAvailability(context, want) {\n    const ctx = context;\n    if (!ctx.loadedExistingBackend) {\n        await loadExistingBackend(ctx);\n    }\n    const gcfV1Regions = new Set();\n    const gcfV2Regions = new Set();\n    for (const ep of allEndpoints(want)) {\n        if (ep.platform == \"gcfv1\") {\n            gcfV1Regions.add(ep.region);\n        }\n        else {\n            gcfV2Regions.add(ep.region);\n        }\n    }\n    const neededUnreachableV1 = ctx.unreachableRegions.gcfV1.filter((region) => gcfV1Regions.has(region));\n    const neededUnreachableV2 = ctx.unreachableRegions.gcfV2.filter((region) => gcfV2Regions.has(region));\n    if (neededUnreachableV1.length) {\n        throw new error_1.FirebaseError(\"The following Cloud Functions regions are currently unreachable:\\n\\t\" +\n            neededUnreachableV1.join(\"\\n\\t\") +\n            \"\\nThis deployment contains functions in those regions. Please try again in a few minutes, or exclude these regions from your deployment.\");\n    }\n    if (neededUnreachableV2.length) {\n        throw new error_1.FirebaseError(\"The following Cloud Functions V2 regions are currently unreachable:\\n\\t\" +\n            neededUnreachableV2.join(\"\\n\\t\") +\n            \"\\nThis deployment contains functions in those regions. Please try again in a few minutes, or exclude these regions from your deployment.\");\n    }\n    if (ctx.unreachableRegions.gcfV1.length) {\n        utils.logLabeledWarning(\"functions\", \"The following Cloud Functions regions are currently unreachable:\\n\" +\n            ctx.unreachableRegions.gcfV1.join(\"\\n\") +\n            \"\\nCloud Functions in these regions won't be deleted.\");\n    }\n    if (ctx.unreachableRegions.gcfV2.length) {\n        utils.logLabeledWarning(\"functions\", \"The following Cloud Functions V2 regions are currently unreachable:\\n\" +\n            ctx.unreachableRegions.gcfV2.join(\"\\n\") +\n            \"\\nCloud Functions in these regions won't be deleted.\");\n    }\n}\nexports.checkAvailability = checkAvailability;\nfunction allEndpoints(backend) {\n    return Object.values(backend.endpoints).reduce((accum, perRegion) => {\n        return [...accum, ...Object.values(perRegion)];\n    }, []);\n}\nexports.allEndpoints = allEndpoints;\nfunction someEndpoint(backend, predicate) {\n    for (const endpoints of Object.values(backend.endpoints)) {\n        if (Object.values(endpoints).some(predicate)) {\n            return true;\n        }\n    }\n    return false;\n}\nexports.someEndpoint = someEndpoint;\nfunction matchingBackend(backend, predicate) {\n    const filtered = Object.assign({}, empty());\n    for (const endpoint of allEndpoints(backend)) {\n        if (!predicate(endpoint)) {\n            continue;\n        }\n        filtered.endpoints[endpoint.region] = filtered.endpoints[endpoint.region] || {};\n        filtered.endpoints[endpoint.region][endpoint.id] = endpoint;\n    }\n    return filtered;\n}\nexports.matchingBackend = matchingBackend;\nfunction regionalEndpoints(backend, region) {\n    return backend.endpoints[region] ? Object.values(backend.endpoints[region]) : [];\n}\nexports.regionalEndpoints = regionalEndpoints;\nexports.hasEndpoint = (backend) => (endpoint) => {\n    return !!backend.endpoints[endpoint.region] && !!backend.endpoints[endpoint.region][endpoint.id];\n};\nexports.missingEndpoint = (backend) => (endpoint) => {\n    return !exports.hasEndpoint(backend)(endpoint);\n};\nfunction compareFunctions(left, right) {\n    if (left.platform != right.platform) {\n        return right.platform < left.platform ? -1 : 1;\n    }\n    if (left.region < right.region) {\n        return -1;\n    }\n    if (left.region > right.region) {\n        return 1;\n    }\n    if (left.id < right.id) {\n        return -1;\n    }\n    if (left.id > right.id) {\n        return 1;\n    }\n    return 0;\n}\nexports.compareFunctions = compareFunctions;\n"]},"metadata":{},"sourceType":"script"}